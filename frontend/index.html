<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindLab Health - Therapist Matching Platform v2.1</title>
    <style>
        :root {
            /* Primary Brand Colors */
            --primary-blue: #1976d2;
            --primary-green: #2e7d32;
            --primary-orange: #f57c00;
            --primary-pink: #e91e63;
            
            /* Secondary Colors */
            --secondary-blue: #42a5f5;
            --secondary-green: #66bb6a;
            --secondary-orange: #ff9800;
            --secondary-pink: #f48fb1;
            
            /* Light Background Colors */
            --light-blue: #e3f2fd;
            --light-green: #e8f5e8;
            --light-orange: #fff3e0;
            --light-pink: #fce4ec;
            
            /* Gradient Colors */
            --gradient-blue-start: #e3f2fd;
            --gradient-blue-end: #bbdefb;
            --gradient-green-start: #e8f5e8;
            --gradient-green-end: #c8e6c9;
            --gradient-orange-start: #fff3e0;
            --gradient-orange-end: #ffcc02;
            --gradient-pink-start: #ffebee;
            --gradient-pink-end: #ffcdd2;
            
            /* Neutral Colors */
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --text-dark: #212121;
            --text-light: #666666;
            --text-muted: #9e9e9e;
            --border-color: #e0e0e0;
            --border-light: #f0f0f0;
            
            /* Status Colors */
            --success-green: #4caf50;
            --warning-orange: #ff9800;
            --error-red: #f44336;
            --info-blue: #2196f3;
            
            /* Dark Theme Colors */
            --dark-bg: #263238;
            --dark-surface: #37474f;
            --dark-text: #eceff1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-light);
            min-height: 100vh;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            position: relative;
        }

        /* Login Container - Centered */
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(45, 122, 62, 0.15);
            max-width: 450px;
            width: 100%;
            padding: 40px;
            margin: 50px auto;
        }
        
        .container.hidden {
            display: none;
        }
        
        /* Dashboard Layout */
        .dashboard-layout {
            display: none;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: var(--bg-light);
            overflow: hidden;
        }
        
        .dashboard-layout.active {
            display: flex;
        }
        
        /* Sidebar Navigation */
        .sidebar {
            width: 260px;
            min-width: 260px;
            background: linear-gradient(180deg, var(--dark-bg) 0%, var(--primary-blue) 100%);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 30px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h2 {
            font-size: clamp(18px, 4vw, 22px);
            margin-bottom: 5px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-header .user-role {
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }
        
        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 15px;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: var(--secondary-blue);
            color: white;
            font-weight: 600;
        }
        
        .nav-item-icon {
            font-size: 20px;
            width: 24px;
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            background: var(--bg-light);
            height: 100vh;
        }
        
        /* Top Header Bar */
        .top-header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 28px;
            color: var(--text-dark);
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        /* Content Pages */
        .content-page {
            display: none;
            padding: 40px;
            flex: 1;
        }
        
        .content-page.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        h1 {
            color: var(--primary-blue);
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 30px;
            font-size: 14px;
        }

        /* Auth tabs - show for login/register */
        #auth-section .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            gap: 5px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            color: var(--text-light);
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab.active {
            color: var(--primary-blue);
            border-bottom: 3px solid var(--primary-blue);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--primary-blue) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(25, 118, 210, 0.3);
        }

        button:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: white !important;
            color: var(--primary-blue) !important;
            border: 2px solid var(--primary-blue) !important;
        }
        
        .btn-secondary:hover {
            background: var(--primary-blue) !important;
            color: white !important;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 14px;
        }

        .message.success {
            background: var(--light-green);
            color: var(--primary-green);
            border: 1px solid var(--secondary-green);
        }

        .message.error {
            background: var(--light-pink);
            color: var(--primary-pink);
            border: 1px solid var(--secondary-pink);
        }

        .message.show {
            display: block;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard {
            margin-top: 20px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-info {
            color: #667eea;
            font-weight: 600;
        }

        .logout-btn {
            padding: 8px 16px;
            width: auto;
            font-size: 14px;
        }

        .appointment-list, .message-list {
            margin-top: 20px;
        }

        .appointment-card, .message-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .appointment-card h3, .message-card h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .appointment-card p, .message-card p {
            color: #666;
            font-size: 14px;
            margin: 4px 0;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-scheduled { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d1ecf1; color: #0c5460; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--primary-green);
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-blue);
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: var(--primary-blue);
        }

        /* Module Cards for Role-Based Dashboard */
        .module-card {
            transition: all 0.3s ease;
            cursor: pointer;
            height: 100%;
        }

        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15) !important;
        }

        .module-icon {
            display: block;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .card-text {
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* Role-Based Color Schemes */
        .role-admin { color: #dc3545 !important; }
        .role-physician { color: #0d6efd !important; }
        .role-therapist { color: #198754 !important; }
        .role-health_coach { color: #fd7e14 !important; }
        .role-patient { color: #6f42c1 !important; }
        .role-partner { color: #20c997 !important; }

        /* Dashboard Header */
        .dashboard-header {
            background: linear-gradient(135deg, var(--gradient-blue-start), var(--gradient-blue-end));
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            transition: background 0.3s ease;
        }

        /* Role-specific dashboard header themes */
        .dashboard-header.physician {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }
        
        .dashboard-header.therapist {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
        }
        
        .dashboard-header.health_coach {
            background: linear-gradient(135deg, #fff3e0, #ffcc02);
        }
        
        .dashboard-header.patient {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
        }
        
        .dashboard-header.partner {
            background: linear-gradient(135deg, #e0f2f1, #b2dfdb);
        }
        
        .dashboard-header.admin {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
        }

        #user-role-indicator {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: white;
            transition: all 0.3s ease;
        }

        /* Enhanced Module Cards */
        .module-card {
            transition: all 0.3s ease;
            cursor: pointer;
            height: 100%;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }

        .module-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15) !important;
        }

        .module-icon {
            display: block;
            font-size: 2.5rem;
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .module-card:hover .module-icon {
            transform: scale(1.1);
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: color 0.3s ease;
        }

        .card-text {
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* Role-specific button styling */
        .btn-role-themed {
            border-radius: 20px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        /* Loading states */
        .loading-spinner {
            padding: 3rem;
            text-align: center;
        }

        .loading-spinner .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        /* Stats grid enhancements */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-blue);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-blue);
            line-height: 1;
        }

        /* Loading Spinner */
        .loading-spinner {
            padding: 3rem;
        }

        /* Permission-based visibility helpers */
        [data-admin-only] { display: none; }
        [data-permission] { display: none; }
        [data-module] { display: none; }

        /* Responsive Grid for Module Cards */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            #dashboard-modules .col-md-4 {
                margin-bottom: 1rem;
            }
        }

        .module-card {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s;
            border: none;
        }

        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(25, 118, 210, 0.3);
        }

        .module-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .module-card p {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .module-card button {
            background: white !important;
            color: var(--primary-blue) !important;
            padding: 10px 20px !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            width: auto !important;
        }

        .module-card button:hover {
            background: var(--bg-light) !important;
            transform: none !important;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .sidebar-header h2 {
                font-size: 18px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 220px;
                min-width: 220px;
            }

            .sidebar-header h2 {
                font-size: 16px;
            }

            .sidebar-header {
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† MindLab Health</h1>
        <p class="subtitle">Connect with the right therapist for you</p>

        <div id="message" class="message"></div>

        <!-- Authentication Section -->
        <div id="auth-section">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('login')">Login</button>
                <button class="tab" onclick="switchTab('register')">Register</button>
            </div>

            <!-- Login Form -->
            <div id="login-tab" class="tab-content active">
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-username">Username</label>
                        <input type="text" id="login-username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" name="password" required>
                    </div>
                    <button type="submit">Login</button>
                </form>
            </div>

            <!-- Register Form -->
            <div id="register-tab" class="tab-content">
                <form id="register-form">
                    <div class="form-group">
                        <label for="reg-username">Username</label>
                        <input type="text" id="reg-username" name="username" required minlength="3">
                    </div>
                    <div class="form-group">
                        <label for="reg-email">Email</label>
                        <input type="email" id="reg-email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-password">Password</label>
                        <input type="password" id="reg-password" name="password" required minlength="8">
                    </div>
                    <div class="form-group">
                        <label for="reg-role">I am a...</label>
                        <select id="reg-role" name="role" required>
                            <option value="patient">Patient seeking therapy</option>
                            <option value="therapist">Therapist</option>
                            <option value="health_coach">Health Coach</option>
                            <option value="physician">Physician</option>
                            <option value="partner">Partner</option>
                        </select>
                    </div>
                    <button type="submit">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard Section (outside .container so it can be shown independently) -->
    <div id="dashboard-section" class="dashboard-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2>üß† MindLab Health</h2>
                    <div class="user-role" id="user-info">Welcome!</div>
                </div>
                
                <nav class="nav-menu">
                    <div class="nav-item active" onclick="switchDashboardTab('overview')">
                        <span class="nav-item-icon">üìä</span>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" data-module="appointments" onclick="switchDashboardTab('appointments')">
                        <span class="nav-item-icon">üìÖ</span>
                        <span>Appointments</span>
                    </div>
                    <div class="nav-item" data-module="messages" onclick="switchDashboardTab('messages')">
                        <span class="nav-item-icon">üí¨</span>
                        <span>Messages</span>
                    </div>
                    <div class="nav-item" data-permission="appointments.create" onclick="switchDashboardTab('book')">
                        <span class="nav-item-icon">‚ûï</span>
                        <span>Book Appointment</span>
                    </div>
                    <div class="nav-item" data-module="analytics" onclick="switchDashboardTab('analytics')">
                        <span class="nav-item-icon">üìà</span>
                        <span>Analytics</span>
                    </div>
                    <div class="nav-item" data-admin-only onclick="switchDashboardTab('admin')">
                        <span class="nav-item-icon">‚öôÔ∏è</span>
                        <span>Admin Panel</span>
                    </div>
                </nav>
                
                <div style="padding: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <button class="btn-secondary" onclick="logout()" style="width: 100%; padding: 12px;">Logout</button>
                </div>
            </aside>
            
            <!-- Main Content -->
            <main class="main-content">
                <div class="top-header">
                    <h1 class="header-title" id="page-title">Overview</h1>
                    <div class="header-actions">
                        <span id="user-greeting" style="color: var(--text-light);"></span>
                    </div>
                </div>
                
                <!-- Overview Page -->
                <div id="overview-page" class="content-page active">
                    <!-- Role-Based Dashboard Header -->
                    <div class="dashboard-header mb-4">
                        <div class="row">
                            <div class="col-md-8">
                                <h2 id="dashboard-title">Loading Dashboard...</h2>
                                <p id="dashboard-description" class="text-muted">Preparing your personalized dashboard...</p>
                                <span id="user-role-indicator" class="badge badge-primary">USER</span>
                            </div>
                            <div class="col-md-4 text-right">
                                <div class="user-info">
                                    <span id="user-greeting" class="text-muted">Welcome back!</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Module Summary Cards -->
                    <div class="mt-4" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <!-- Users Module Summary -->
                        <div class="module-summary-card" id="users-summary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 18px;">üë• User Management</h3>
                                <span style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; font-size: 12px;">Active</span>
                            </div>
                            <div style="font-size: 36px; font-weight: bold; margin-bottom: 10px;" id="total-users-stat">-</div>
                            <div style="opacity: 0.9; font-size: 14px; margin-bottom: 15px;">Total Users</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                                <div>
                                    <div style="font-size: 20px; font-weight: bold;" id="new-users-week">-</div>
                                    <div style="opacity: 0.8; font-size: 12px;">New This Week</div>
                                </div>
                                <div>
                                    <div style="font-size: 20px; font-weight: bold;" id="users-growth-rate">-</div>
                                    <div style="opacity: 0.8; font-size: 12px;">Growth Rate</div>
                                </div>
                            </div>
                        </div>

                        <!-- Appointments Module Summary -->
                        <div class="module-summary-card" id="appointments-summary" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 18px;">üìÖ Appointments</h3>
                                <span style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; font-size: 12px;">Tracking</span>
                            </div>
                            <div style="font-size: 36px; font-weight: bold; margin-bottom: 10px;" id="total-appointments-stat">-</div>
                            <div style="opacity: 0.9; font-size: 14px; margin-bottom: 15px;">Total Appointments</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                                <div>
                                    <div style="font-size: 20px; font-weight: bold;" id="appointments-today">-</div>
                                    <div style="opacity: 0.8; font-size: 12px;">Today</div>
                                </div>
                                <div>
                                    <div style="font-size: 20px; font-weight: bold;" id="appointments-upcoming">-</div>
                                    <div style="opacity: 0.8; font-size: 12px;">Upcoming</div>
                                </div>
                            </div>
                        </div>

                        <!-- Therapists Module Summary -->
                        <div class="module-summary-card" id="therapists-summary" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 18px;">ü©∫ Therapists</h3>
                                <span style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; font-size: 12px;">Available</span>
                            </div>
                            <div style="font-size: 36px; font-weight: bold; margin-bottom: 10px;" id="total-therapists-stat">-</div>
                            <div style="opacity: 0.9; font-size: 14px; margin-bottom: 15px;">Total Therapists</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                                <div>
                                    <div style="font-size: 20px; font-weight: bold;" id="active-therapists">-</div>
                                    <div style="opacity: 0.8; font-size: 12px;">Active Now</div>
                                </div>
                                <div>
                                    <div style="font-size: 20px; font-weight: bold;" id="therapist-availability">-</div>
                                    <div style="opacity: 0.8; font-size: 12px;">Availability</div>
                                </div>
                            </div>
                        </div>

                        <!-- Health Records Module Summary -->
                        <div class="module-summary-card" id="health-records-summary" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 18px;">üìã Health Records</h3>
                                <span style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; font-size: 12px;">Secure</span>
                            </div>
                            <div style="font-size: 36px; font-weight: bold; margin-bottom: 10px;" id="total-health-records">-</div>
                            <div style="opacity: 0.9; font-size: 14px; margin-bottom: 15px;">Total Records</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                                <div>
                                    <div style="font-size: 20px; font-weight: bold;" id="health-records-today">-</div>
                                    <div style="opacity: 0.8; font-size: 12px;">Added Today</div>
                                </div>
                                <div>
                                    <div style="font-size: 20px; font-weight: bold;" id="avg-records-per-user">-</div>
                                    <div style="opacity: 0.8; font-size: 12px;">Avg/User</div>
                                </div>
                            </div>
                        </div>

                        <!-- Nutrition Module Summary -->
                        <div class="module-summary-card" id="nutrition-summary" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(250, 112, 154, 0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 18px;">ü•ó Nutrition</h3>
                                <span style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; font-size: 12px;">Planning</span>
                            </div>
                            <div style="font-size: 36px; font-weight: bold; margin-bottom: 10px;" id="total-meals-stat">-</div>
                            <div style="opacity: 0.9; font-size: 14px; margin-bottom: 15px;">Total Meals</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                                <div>
                                    <div style="font-size: 20px; font-weight: bold;" id="total-nutrients">-</div>
                                    <div style="opacity: 0.8; font-size: 12px;">Nutrients</div>
                                </div>
                                <div>
                                    <div style="font-size: 20px; font-weight: bold;" id="total-ingredients">-</div>
                                    <div style="opacity: 0.8; font-size: 12px;">Ingredients</div>
                                </div>
                            </div>
                        </div>

                        <!-- Messages Module Summary -->
                        <div class="module-summary-card" id="messages-summary" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(48, 207, 208, 0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 18px;">üí¨ Messages</h3>
                                <span style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; font-size: 12px;">Active</span>
                            </div>
                            <div style="font-size: 36px; font-weight: bold; margin-bottom: 10px;" id="total-messages-stat">-</div>
                            <div style="opacity: 0.9; font-size: 14px; margin-bottom: 15px;">Total Messages</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                                <div>
                                    <div style="font-size: 20px; font-weight: bold;" id="unread-messages-stat">-</div>
                                    <div style="opacity: 0.8; font-size: 12px;">Unread</div>
                                </div>
                                <div>
                                    <div style="font-size: 20px; font-weight: bold;" id="next-appointment-time">None</div>
                                    <div style="opacity: 0.8; font-size: 12px;">Next Appt</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Activity Timeline -->
                    <div class="mt-4" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
                        <h2 style="margin-bottom: 20px; color: var(--text-dark); display: flex; align-items: center; gap: 10px;">
                            <span>üìä</span> System Activity Overview
                        </h2>
                        <div id="activity-overview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Total Records</div>
                                <div style="font-size: 28px; font-weight: bold; color: #333;" id="total-records-overview">-</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #f5576c;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Today's Activity</div>
                                <div style="font-size: 28px; font-weight: bold; color: #333;" id="today-activity">-</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #43e97b;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">System Health</div>
                                <div style="font-size: 28px; font-weight: bold; color: #333;" id="system-health">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Role-Based Dashboard Modules -->
                    <div id="dashboard-modules" class="row mt-4">
                        <!-- Role-specific modules will be dynamically loaded here by RBAC -->
                    </div>
                </div>

                <!-- Appointments Page -->
                <div id="appointments-page" class="content-page">
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                            <h2 style="margin: 0; color: var(--text-dark);">Appointments Management</h2>
                            <div style="display: flex; gap: 15px;">
                                <button onclick="showAppointmentBooking()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                    Book New Appointment
                                </button>
                                <button onclick="switchAppointmentView('list')" id="list-view-btn" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                                    List View
                                </button>
                                <button onclick="switchAppointmentView('calendar')" id="calendar-view-btn" style="background: #e5e7eb; color: #374151; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                                    Calendar View
                                </button>
                            </div>
                        </div>

                        <!-- Appointment Booking Form (Hidden by default) -->
                        <div id="appointment-booking-form" style="display: none; background: #f8fafc; padding: 25px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #e1e5e9;">
                            <h3 style="margin-top: 0; color: var(--text-dark);">Book New Appointment</h3>
                            <form id="booking-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark);">Therapist:</label>
                                    <select id="booking-therapist" required style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                        <option value="">Select a therapist...</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark);">Appointment Type:</label>
                                    <select id="booking-type" required style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                        <option value="consultation">Initial Consultation</option>
                                        <option value="therapy">Therapy Session</option>
                                        <option value="follow-up">Follow-up</option>
                                        <option value="assessment">Assessment</option>
                                        <option value="group">Group Session</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark);">Date & Time:</label>
                                    <input type="datetime-local" id="booking-datetime" required style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark);">Duration (minutes):</label>
                                    <select id="booking-duration" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                        <option value="30">30 minutes</option>
                                        <option value="45">45 minutes</option>
                                        <option value="60" selected>1 hour</option>
                                        <option value="90">1.5 hours</option>
                                        <option value="120">2 hours</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark);">Location:</label>
                                    <select id="booking-location" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                        <option value="Office Room 101">Office Room 101</option>
                                        <option value="Office Room 102">Office Room 102</option>
                                        <option value="Office Room 103">Office Room 103</option>
                                        <option value="Online - Video Call">Online - Video Call</option>
                                        <option value="Phone Consultation">Phone Consultation</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark);">
                                        Google Calendar Sync
                                    </label>
                                    <button type="button" onclick="configureGoogleCalendar()" style="padding: 6px 16px; background: #4285f4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; margin-bottom: 8px; display: block;">
                                        Configure
                                    </button>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="booking-calendar-sync" checked style="margin-right: 4px;">
                                        <span id="calendar-sync-status" style="font-size: 12px; color: #6b7280;">
                                            Not configured
                                        </span>
                                    </div>
                                </div>
                                <div style="grid-column: 1 / -1;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark);">Notes:</label>
                                    <textarea id="booking-notes" placeholder="Any special requirements or notes..." style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; resize: vertical; min-height: 80px;"></textarea>
                                </div>
                                <div style="grid-column: 1 / -1; display: flex; gap: 15px; justify-content: flex-end;">
                                    <button type="button" onclick="hideAppointmentBooking()" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                                        Cancel
                                    </button>
                                    <button type="submit" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                        Book Appointment
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Appointments List View -->
                        <div id="appointments-list-view">
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                    <button onclick="filterAppointments('all')" class="filter-btn active" data-filter="all" style="padding: 8px 16px; border: 2px solid #3b82f6; border-radius: 20px; background: #3b82f6; color: white; cursor: pointer; font-size: 14px;">All</button>
                                    <button onclick="filterAppointments('scheduled')" class="filter-btn" data-filter="scheduled" style="padding: 8px 16px; border: 2px solid #3b82f6; border-radius: 20px; background: white; color: #3b82f6; cursor: pointer; font-size: 14px;">Scheduled</button>
                                    <button onclick="filterAppointments('confirmed')" class="filter-btn" data-filter="confirmed" style="padding: 8px 16px; border: 2px solid #3b82f6; border-radius: 20px; background: white; color: #3b82f6; cursor: pointer; font-size: 14px;">Confirmed</button>
                                    <button onclick="filterAppointments('completed')" class="filter-btn" data-filter="completed" style="padding: 8px 16px; border: 2px solid #3b82f6; border-radius: 20px; background: white; color: #3b82f6; cursor: pointer; font-size: 14px;">Completed</button>
                                    <button onclick="filterAppointments('cancelled')" class="filter-btn" data-filter="cancelled" style="padding: 8px 16px; border: 2px solid #3b82f6; border-radius: 20px; background: white; color: #3b82f6; cursor: pointer; font-size: 14px;">Cancelled</button>
                                </div>
                                <div>
                                    <input type="text" id="appointment-search" placeholder="üîç Search appointments..." style="padding: 10px 15px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%; max-width: 400px;">
                                </div>
                            </div>
                            <div id="appointments-list" class="appointment-list">
                                <div class="loading">Loading appointments...</div>
                            </div>
                        </div>

                        <!-- Calendar View (Hidden by default) -->
                        <div id="appointments-calendar-view" style="display: none;">
                            <div style="background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center; border: 2px dashed #9ca3af;">
                                <h3 style="color: #6b7280; margin-bottom: 15px;">üìÖ Calendar View</h3>
                                <p style="color: #9ca3af; margin-bottom: 20px;">Interactive calendar view will be implemented here</p>
                                <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <div id="calendar-placeholder" style="min-height: 400px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                        <div style="font-size: 48px; margin-bottom: 15px;">üìÖ</div>
                                        <p style="color: #6b7280;">Calendar integration coming soon...</p>
                                        <p style="color: #9ca3af; font-size: 14px;">This will show appointments in a monthly/weekly calendar view</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages Page -->
                <div id="messages-page" class="content-page">
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
                        <h2 style="margin-bottom: 20px; color: var(--text-dark);">My Messages</h2>
                        <div id="messages-list" class="message-list">
                            <div class="loading">Loading messages...</div>
                        </div>
                    </div>
                </div>

                <!-- Book Appointment Page -->
                <div id="book-page" class="content-page">
                    <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); max-width: 600px;">
                        <h2 style="margin-bottom: 25px; color: var(--text-dark);">Book New Appointment</h2>
                        <form id="book-form">
                            <div class="form-group">
                                <label for="therapist-id">Therapist ID</label>
                                <input type="number" id="therapist-id" name="therapist_id" required min="1">
                            </div>
                            <div class="form-group">
                                <label for="appointment-datetime">Date & Time</label>
                                <input type="datetime-local" id="appointment-datetime" name="appointment_datetime" required>
                            </div>
                            <div class="form-group">
                                <label for="notes">Notes (Optional)</label>
                                <textarea id="notes" name="notes" rows="4" placeholder="Tell us about your concerns..."></textarea>
                            </div>
                            <button type="submit">Book Appointment</button>
                        </form>
                    </div>
                </div>

                <!-- Admin Panel Page -->
                <div id="admin-page" class="content-page">
                    <h2 style="color: var(--primary-blue); margin-bottom: 30px; font-size: 24px;">Admin Control Panel</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="module-card">
                            <h3>üë• User Management</h3>
                            <p>Manage users, roles, and permissions</p>
                            <button onclick="openUserManagementModule()">Open Module</button>
                        </div>
                        <div class="module-card">
                            <h3>üìÖ Appointments</h3>
                            <p>View and manage all appointments</p>
                            <button onclick="openAppointmentsModule()">Open Module</button>
                        </div>
                        <div class="module-card">
                            <h3>üí¨ Messages</h3>
                            <p>Monitor all system messages</p>
                            <button onclick="openMessagesModule()">Open Module</button>
                        </div>
                        <div class="module-card">
                            <h3>üìä Analytics</h3>
                            <p>View system analytics and reports</p>
                            <button onclick="openAnalyticsModule()">Open Module</button>
                        </div>
                        <div class="module-card">
                            <h3>‚öôÔ∏è Settings</h3>
                            <p>Configure system settings</p>
                            <button onclick="openSettingsModule()">Open Module</button>
                        </div>
                        <div class="module-card">
                            <h3>ÔøΩ Subscription Plans</h3>
                            <p>Manage subscription tiers and features</p>
                            <button onclick="openSubscriptionModule()">Open Module</button>
                        </div>
                        <div class="module-card">
                            <h3>ÔøΩüîí Security</h3>
                            <p>View security logs and audit trails</p>
                            <button onclick="openSecurityModule()">Open Module</button>
                        </div>
                        <div class="module-card">
                            <h3>üçΩÔ∏è Meals Management</h3>
                            <p>Manage meal plans and dietary recommendations</p>
                            <button onclick="openMealsModule()">Open Module</button>
                        </div>
                        <div class="module-card">
                            <h3>ü•ó Nutrient Management</h3>
                            <p>Monitor and manage nutritional data</p>
                            <button onclick="openNutrientManagementModule()">Open Module</button>
                        </div>
                        <div class="module-card">
                            <h3>ü§ñ AI Chatbot</h3>
                            <p>Manage AI assistant and WhatsApp integration</p>
                            <button onclick="openAIChatbotModule()">Open Module</button>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 25px; border-radius: 12px; border-left: 4px solid var(--primary-green); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
                        <h3 style="color: var(--text-dark); margin-bottom: 15px; font-size: 20px;">System Status</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <p style="color: var(--text-light); margin: 5px 0;"><strong><span id="api-status-icon">üü¢</span> API Server:</strong> <span id="api-status">Online</span></p>
                            <p style="color: var(--text-light); margin: 5px 0;"><strong><span id="db-status-icon">üü¢</span> Database:</strong> <span id="db-status">Loading...</span></p>
                            <p style="color: var(--text-light); margin: 5px 0;"><strong>üìä Total Users:</strong> <span id="admin-user-count">Loading...</span></p>
                            <p style="color: var(--text-light); margin: 5px 0;"><strong>üìÖ Total Appointments:</strong> <span id="admin-appt-count">Loading...</span></p>
                            <p style="color: var(--text-light); margin: 5px 0;"><strong>üçΩÔ∏è Total Meals:</strong> <span id="admin-meals-count">Loading...</span></p>
                            <p style="color: var(--text-light); margin: 5px 0;"><strong>ü•ï Total Ingredients:</strong> <span id="admin-ingredients-count">Loading...</span></p>
                        </div>
                    </div>
                </div>

                <!-- User Management Module Page -->
                <div id="user-management-page" class="content-page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: var(--primary-blue); margin: 0;">üë• User Management</h2>
                        <button onclick="switchDashboardTab('overview')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">‚Üê Back to Dashboard</button>
                    </div>
                    
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 20px;">
                        <h3>User Management System</h3>
                        <p>Manage users, roles, and permissions across the platform.</p>
                        <div id="user-management-content">
                            <p style="color: #666;">Loading user management interface...</p>
                        </div>
                    </div>
                </div>

                <!-- Patient Management Module Page -->
                <div id="patient-management-page" class="content-page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: var(--primary-blue); margin: 0;">üë§ Patient Management</h2>
                        <button onclick="switchDashboardTab('overview')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">‚Üê Back to Dashboard</button>
                    </div>
                    
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 20px;">
                        <h3>Patient Management System</h3>
                        <p>Manage patient records, assignments, and care coordination.</p>
                        <div id="patient-management-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
                                    <h4>üìä Patient Statistics</h4>
                                    <p><strong>Total Patients:</strong> <span id="total-patients">Loading...</span></p>
                                    <p><strong>Active Cases:</strong> <span id="active-cases">Loading...</span></p>
                                    <p><strong>New This Month:</strong> <span id="new-patients">Loading...</span></p>
                                </div>
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
                                    <h4>üéØ Quick Actions</h4>
                                    <button style="width: 100%; margin: 5px 0; padding: 10px; background: var(--primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">Add New Patient</button>
                                    <button style="width: 100%; margin: 5px 0; padding: 10px; background: var(--primary-green); color: white; border: none; border-radius: 4px; cursor: pointer;">Patient Search</button>
                                    <button style="width: 100%; margin: 5px 0; padding: 10px; background: var(--primary-orange); color: white; border: none; border-radius: 4px; cursor: pointer;">Generate Reports</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Health Records Module Page -->
                <div id="health-records-page" class="content-page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: var(--primary-blue); margin: 0;">üìã Health Records</h2>
                        <button onclick="switchDashboardTab('overview')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">‚Üê Back to Dashboard</button>
                    </div>
                    
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 20px;">
                        <h3>Health Records Management</h3>
                        <p>Access and manage patient health records, medical history, and clinical notes.</p>
                        <div id="health-records-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3;">
                                    <h4>üìä Records Overview</h4>
                                    <p><strong>Total Records:</strong> <span id="total-records">Loading...</span></p>
                                    <p><strong>Recent Updates:</strong> <span id="recent-updates">Loading...</span></p>
                                    <p><strong>Pending Reviews:</strong> <span id="pending-reviews">Loading...</span></p>
                                </div>
                                <div style="background: #f3e5f5; padding: 20px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                                    <h4>üîç Search & Filter</h4>
                                    <input type="text" placeholder="Search patient records..." style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <button style="width: 100%; padding: 10px; background: var(--primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">Search Records</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nutrition Management Module Page -->
                <div id="nutrition-management-page" class="content-page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: var(--primary-blue); margin: 0;">ü•ó Nutrition Management</h2>
                        <button onclick="switchDashboardTab('overview')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">‚Üê Back to Dashboard</button>
                    </div>
                    
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 20px;">
                        <h3>Nutrition Planning & Management</h3>
                        <p>Create and manage nutrition plans, dietary recommendations, and nutritional analysis.</p>
                        <div id="nutrition-management-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
                                    <h4>üìä Nutrition Stats</h4>
                                    <p><strong>Active Plans:</strong> <span id="active-nutrition-plans">Loading...</span></p>
                                    <p><strong>Completed Plans:</strong> <span id="completed-plans">Loading...</span></p>
                                    <p><strong>Avg Compliance:</strong> <span id="avg-compliance">Loading...</span></p>
                                </div>
                                <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                                    <h4>üéØ Quick Actions</h4>
                                    <button style="width: 100%; margin: 5px 0; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">Create Nutrition Plan</button>
                                    <button style="width: 100%; margin: 5px 0; padding: 10px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">Nutritional Analysis</button>
                                    <button style="width: 100%; margin: 5px 0; padding: 10px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">View Reports</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Meals Management Module Page -->
                <div id="meals-management-page" class="content-page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: var(--primary-blue); margin: 0;">üçΩÔ∏è Meals Management</h2>
                        <button onclick="switchDashboardTab('overview')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">‚Üê Back to Dashboard</button>
                    </div>
                    
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 20px;">
                        <h3>Meal Planning & Management</h3>
                        <p>Design meal plans, manage dietary recommendations, and track meal compliance.</p>
                        <div id="meals-management-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div style="background: #ffeaa7; padding: 20px; border-radius: 8px; border-left: 4px solid #fdcb6e;">
                                    <h4>üçΩÔ∏è Meal Stats</h4>
                                    <p><strong>Total Meal Plans:</strong> <span id="total-meal-plans">Loading...</span></p>
                                    <p><strong>Active Plans:</strong> <span id="active-meal-plans">Loading...</span></p>
                                    <p><strong>Avg Rating:</strong> <span id="avg-meal-rating">Loading...</span></p>
                                </div>
                                <div style="background: #a29bfe; padding: 20px; border-radius: 8px; border-left: 4px solid #6c5ce7; color: white;">
                                    <h4>‚ö° Quick Actions</h4>
                                    <button style="width: 100%; margin: 5px 0; padding: 10px; background: #00b894; color: white; border: none; border-radius: 4px; cursor: pointer;">Create Meal Plan</button>
                                    <button style="width: 100%; margin: 5px 0; padding: 10px; background: #e17055; color: white; border: none; border-radius: 4px; cursor: pointer;">Recipe Management</button>
                                    <button style="width: 100%; margin: 5px 0; padding: 10px; background: #fd79a8; color: white; border: none; border-radius: 4px; cursor: pointer;">Dietary Preferences</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Earnings & Commission Module Page -->
                <div id="earnings-commission-page" class="content-page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: var(--primary-blue); margin: 0;">üí∞ Earnings & Commission</h2>
                        <button onclick="switchDashboardTab('overview')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">‚Üê Back to Dashboard</button>
                    </div>
                    
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 20px;">
                        <h3>Financial Management & Commission Tracking</h3>
                        <p>Manage provider earnings, commission structures, and financial reporting.</p>
                        <div id="earnings-commission-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div style="background: #d4edda; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
                                    <h4>üí∞ Financial Overview</h4>
                                    <p><strong>Total Earnings:</strong> <span id="total-earnings">Loading...</span></p>
                                    <p><strong>Pending Payments:</strong> <span id="pending-payments">Loading...</span></p>
                                    <p><strong>This Month:</strong> <span id="month-earnings">Loading...</span></p>
                                </div>
                                <div style="background: #f8d7da; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
                                    <h4>üìä Commission Management</h4>
                                    <button style="width: 100%; margin: 5px 0; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Commission Structures</button>
                                    <button style="width: 100%; margin: 5px 0; padding: 10px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">Payment Reports</button>
                                    <button style="width: 100%; margin: 5px 0; padding: 10px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;">Generate Invoices</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Admin Module Page -->
                <div id="system-admin-page" class="content-page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: var(--primary-blue); margin: 0;">üõ†Ô∏è System Administration</h2>
                        <button onclick="switchDashboardTab('overview')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">‚Üê Back to Dashboard</button>
                    </div>
                    
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 20px;">
                        <h3>Advanced System Administration</h3>
                        <p>System configuration, maintenance, and advanced administrative tools.</p>
                        <div id="system-admin-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div style="background: #e1f5fe; padding: 20px; border-radius: 8px; border-left: 4px solid #0288d1;">
                                    <h4>üîß System Status</h4>
                                    <p><strong>Server Uptime:</strong> <span id="server-uptime">Loading...</span></p>
                                    <p><strong>Database Status:</strong> <span id="db-status-detail">Loading...</span></p>
                                    <p><strong>Active Sessions:</strong> <span id="active-sessions">Loading...</span></p>
                                </div>
                                <div style="background: #fff8e1; padding: 20px; border-radius: 8px; border-left: 4px solid #ffa000;">
                                    <h4>‚öôÔ∏è Admin Tools</h4>
                                    <button style="width: 100%; margin: 5px 0; padding: 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">System Backup</button>
                                    <button style="width: 100%; margin: 5px 0; padding: 10px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer;">Audit Logs</button>
                                    <button style="width: 100%; margin: 5px 0; padding: 10px; background: #607d8b; color: white; border: none; border-radius: 4px; cursor: pointer;">Configuration</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

    <!-- RBAC Script for Role-Based Access Control -->
    <script src="/static/js/rbac.js"></script>
    
    <!-- Role-Specific Dashboard Scripts -->
    <script src="/static/js/role-dashboards.js"></script>
    
    <!-- Debug Module Testing -->
    <script src="/static/js/debug-modules.js"></script>
    
    <!-- Demo Features and Helper Functions -->
    <script src="/static/js/demo-features.js"></script>

    <script>
        // Test function to debug button clicks
        function testFunction() {
            console.log('=== ANALYTICS DEBUG START ===');
            
            // Check if openAnalyticsModule exists
            if (typeof openAnalyticsModule === 'function') {
                console.log('‚úÖ openAnalyticsModule function exists');
                try {
                    console.log('üîÑ Calling openAnalyticsModule...');
                    openAnalyticsModule();
                    console.log('‚úÖ openAnalyticsModule called successfully');
                } catch (error) {
                    console.error('‚ùå Error calling openAnalyticsModule:', error);
                    alert('Error in openAnalyticsModule: ' + error.message);
                }
            } else {
                console.error('‚ùå openAnalyticsModule function does not exist!');
                alert('openAnalyticsModule function not found');
            }
            
            console.log('=== ANALYTICS DEBUG END ===');
        }

        // API Configuration
        const API_BASE_URL = 'http://localhost:8000/api';
        
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;

        // Utility function to get current auth token
        function getAuthToken() {
            // Always get fresh token from localStorage
            const token = localStorage.getItem('authToken');
            if (!token) {
                console.warn('No auth token found - user may need to login');
            }
            return token;
        }

        // Utility function to make authenticated API calls
        async function authenticatedFetch(url, options = {}) {
            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token available');
            }
            
            // Merge headers with auth token
            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };
            
            return fetch(url, { ...options, headers });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            // Check health endpoint
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    console.log('API health check passed');
                }
            } catch (error) {
                showMessage('Unable to connect to API server', 'error');
            }

            // If user has token, try to load dashboard
            if (authToken) {
                await loadUserProfile();
            }
        });

        // Tab switching for auth
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        // Tab switching for dashboard
        function switchDashboardTab(tab) {
            console.log('üîß DEBUG: switchDashboardTab called with:', tab);
            
            // Debug: Check if elements exist before manipulation
            const allPages = document.querySelectorAll('.content-page');
            const targetPageId = `${tab}-page`;
            const targetPage = document.getElementById(targetPageId);
            
            console.log('üîß DEBUG: All content pages found:', allPages.length);
            console.log('üîß DEBUG: Looking for page with ID:', targetPageId);
            console.log('üîß DEBUG: Target page found:', !!targetPage);
            
            // Remove active class from all nav items and pages
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.content-page').forEach(page => {
                page.classList.remove('active');
                console.log('üîß DEBUG: Removed active from:', page.id);
            });
            
            // Add active class to clicked nav item (if event exists)
            if (typeof event !== 'undefined' && event.target) {
                const navItem = event.target.closest('.nav-item');
                if (navItem) {
                    navItem.classList.add('active');
                }
            } else {
                // For programmatic calls, find the nav item by data attribute or onclick
                const navItem = document.querySelector(`[onclick*="switchDashboardTab('${tab}')"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }
            }
            
            // Show the corresponding page
            const pageTitles = {
                'overview': 'Overview',
                'appointments': 'My Appointments',
                'messages': 'My Messages',
                'book': 'Book Appointment',
                'admin': 'Admin Panel',
                'patient-management': 'Patient Management',
                'health-records': 'Health Records',
                'nutrition-management': 'Nutrition Management',
                'meals-management': 'Meals Management',
                'earnings-commission': 'Earnings & Commission',
                'system-admin': 'System Administration',
                'user-management': 'User Management'
            };
            
            document.getElementById('page-title').textContent = pageTitles[tab] || 'Dashboard';
            console.log('üîß DEBUG: Set page title to:', pageTitles[tab] || 'Dashboard');
            
            // For overview - show dashboard with high-level summary
            if (tab === 'overview') {
                const overviewPage = document.getElementById('overview-page');
                if (overviewPage) {
                    overviewPage.classList.add('active');
                    console.log('‚úÖ DEBUG: Activated overview page');
                    // Recreate role-specific dashboard for overview
                    if (typeof rbacManager !== 'undefined') {
                        rbacManager.createRoleDashboard();
                    }
                    // Load dashboard statistics
                    loadDashboardStats();
                } else {
                    console.error('‚ùå DEBUG: overview-page not found!');
                }
            } 
            // For admin - show admin control panel
            else if (tab === 'admin') {
                const adminPage = document.getElementById('admin-page');
                if (adminPage) {
                    adminPage.classList.add('active');
                    console.log('‚úÖ DEBUG: Activated admin page');
                    // Load admin stats when admin panel is opened
                    loadAdminStats();
                } else {
                    console.error('‚ùå DEBUG: admin-page not found!');
                }
            } else {
                // For all other tabs, look for the corresponding page
                if (targetPage) {
                    targetPage.classList.add('active');
                    console.log('‚úÖ DEBUG: Successfully activated page:', targetPageId);
                    
                    // Double-check the page is actually visible
                    const computedStyle = window.getComputedStyle(targetPage);
                    console.log('üîß DEBUG: Page display style:', computedStyle.display);
                    console.log('üîß DEBUG: Page visibility:', computedStyle.visibility);
                } else {
                    console.error('‚ùå DEBUG: Page not found:', targetPageId);
                    console.log('üîß DEBUG: Available page IDs:');
                    document.querySelectorAll('.content-page').forEach(page => {
                        console.log('  - ', page.id);
                    });
                    
                    // Fallback to overview if page doesn't exist
                    const overviewPage = document.getElementById('overview-page');
                    if (overviewPage) {
                        overviewPage.classList.add('active');
                        console.log('‚úÖ DEBUG: Fallback to overview page');
                    }
                }
            }

            // Load data when switching tabs
            if (tab === 'appointments') loadAppointments();
            if (tab === 'messages') loadMessages();
            // Note: admin dashboard creation is already handled above, no need to call again
        }
        
        // Load admin statistics and system status
        async function loadAdminStats() {
            try {
                // Get fresh token
                const token = getAuthToken();
                if (!token) {
                    console.warn('No auth token for admin stats');
                    return;
                }
                
                // Fetch system status from backend
                const response = await fetch(`${API_BASE_URL}/system/status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update API status
                    const apiStatus = data.api_server?.status || 'unknown';
                    document.getElementById('api-status').textContent = apiStatus === 'online' ? 'Online' : 'Offline';
                    document.getElementById('api-status-icon').textContent = apiStatus === 'online' ? 'üü¢' : 'üî¥';
                    
                    // Update Database status
                    const dbStatus = data.database?.status || 'unknown';
                    const dbType = data.database?.type || 'Unknown';
                    const dbText = dbStatus === 'connected' 
                        ? `Connected (${dbType})` 
                        : `${dbStatus} (${dbType})`;
                    document.getElementById('db-status').textContent = dbText;
                    document.getElementById('db-status-icon').textContent = dbStatus === 'connected' ? 'üü¢' : 'üî¥';
                    
                    // Update statistics
                    const stats = data.statistics || {};
                    const totalUsers = stats.total_users || 0;
                    const totalAppts = stats.total_appointments || 0;
                    const totalMeals = stats.total_meals || 0;
                    const totalIngredients = stats.total_ingredients || 0;
                    
                    // Format user count with role breakdown
                    const userBreakdown = data.user_breakdown || {};
                    const adminCount = userBreakdown.admin || 0;
                    const userText = adminCount > 0 
                        ? `${totalUsers} (${adminCount} Admin)` 
                        : `${totalUsers}`;
                    
                    document.getElementById('admin-user-count').textContent = userText;
                    document.getElementById('admin-appt-count').textContent = totalAppts;
                    document.getElementById('admin-meals-count').textContent = totalMeals;
                    document.getElementById('admin-ingredients-count').textContent = totalIngredients;
                    
                    console.log('System status loaded:', data);
                } else {
                    console.error('Failed to fetch system status:', response.status);
                    // Fallback to default values
                    document.getElementById('admin-user-count').textContent = 'Error';
                    document.getElementById('admin-appt-count').textContent = 'Error';
                    document.getElementById('admin-meals-count').textContent = 'Error';
                    document.getElementById('admin-ingredients-count').textContent = 'Error';
                    document.getElementById('db-status').textContent = 'Error';
                }
            } catch (error) {
                console.error('Failed to load admin stats:', error);
                // Show error state
                document.getElementById('api-status').textContent = 'Error';
                document.getElementById('api-status-icon').textContent = 'üî¥';
                document.getElementById('db-status').textContent = 'Error';
                document.getElementById('db-status-icon').textContent = 'üî¥';
            }
        }

        // Load dashboard statistics with module summaries
        async function loadDashboardStats() {
            try {
                const token = getAuthToken();
                if (!token) {
                    console.warn('No auth token for dashboard stats');
                    return;
                }
                
                // Fetch dashboard statistics from backend using system/status endpoint
                const response = await fetch(`${API_BASE_URL}/system/status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const sysData = await response.json();
                    console.log('System status loaded:', sysData);
                    
                    // Transform system status data to dashboard format
                    const data = {
                        users: {
                            total: sysData.statistics?.total_users || 0,
                            new_this_week: 0,
                            growth_rate: 0
                        },
                        appointments: {
                            total: sysData.statistics?.total_appointments || 0,
                            today: 0,
                            upcoming: 0
                        },
                        therapists: {
                            total: (sysData.user_breakdown?.therapist || 0),
                            active: (sysData.user_breakdown?.therapist || 0)
                        },
                        health_records: {
                            total: 0,
                            today: 0,
                            avg_per_user: 0
                        },
                        nutrition: {
                            total_meals: sysData.statistics?.total_meals || 0,
                            total_nutrients: sysData.statistics?.total_nutrients || 0,
                            total_ingredients: sysData.statistics?.total_ingredients || 0
                        },
                        messages: {
                            total: 0,
                            unread: 0
                        },
                        overview: {
                            total_records: (sysData.statistics?.total_users || 0) + (sysData.statistics?.total_appointments || 0),
                            today_activity: 0,
                            system_health: 'stable'
                        }
                    };
                    console.log('Dashboard stats transformed:', data);
                    
                    // Update Users Module Summary
                    document.getElementById('total-users-stat').textContent = data.users?.total?.toLocaleString() || '0';
                    document.getElementById('new-users-week').textContent = data.users?.new_this_week?.toLocaleString() || '0';
                    document.getElementById('users-growth-rate').textContent = `${data.users?.growth_rate || 0}%`;
                    
                    // Update Appointments Module Summary
                    document.getElementById('total-appointments-stat').textContent = data.appointments?.total?.toLocaleString() || '0';
                    document.getElementById('appointments-today').textContent = data.appointments?.today?.toLocaleString() || '0';
                    document.getElementById('appointments-upcoming').textContent = data.appointments?.upcoming?.toLocaleString() || '0';
                    
                    // Update Therapists Module Summary
                    document.getElementById('total-therapists-stat').textContent = data.therapists?.total?.toLocaleString() || '0';
                    document.getElementById('active-therapists').textContent = data.therapists?.active?.toLocaleString() || '0';
                    document.getElementById('therapist-availability').textContent = `${data.therapists?.availability_rate || 0}%`;
                    
                    // Update Health Records Module Summary
                    document.getElementById('total-health-records').textContent = data.health_records?.total?.toLocaleString() || '0';
                    document.getElementById('health-records-today').textContent = data.health_records?.today?.toLocaleString() || '0';
                    document.getElementById('avg-records-per-user').textContent = data.health_records?.avg_per_user || '0';
                    
                    // Update Nutrition Module Summary
                    document.getElementById('total-meals-stat').textContent = data.nutrition?.total_meals?.toLocaleString() || '0';
                    document.getElementById('total-nutrients').textContent = data.nutrition?.total_nutrients?.toLocaleString() || '0';
                    document.getElementById('total-ingredients').textContent = data.nutrition?.total_ingredients?.toLocaleString() || '0';
                    
                    // Update Messages Module Summary
                    document.getElementById('total-messages-stat').textContent = data.messages?.total?.toLocaleString() || '0';
                    document.getElementById('unread-messages-stat').textContent = data.messages?.unread?.toLocaleString() || '0';
                    
                    // Update next appointment
                    if (data.appointments?.next_appointment) {
                        const nextAppt = data.appointments.next_appointment;
                        const apptDate = new Date(nextAppt.datetime);
                        const today = new Date();
                        const diffTime = apptDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 0) {
                            document.getElementById('next-appointment-time').textContent = 'Today';
                        } else if (diffDays === 1) {
                            document.getElementById('next-appointment-time').textContent = 'Tomorrow';
                        } else if (diffDays > 1 && diffDays <= 7) {
                            document.getElementById('next-appointment-time').textContent = `${diffDays}d`;
                        } else {
                            document.getElementById('next-appointment-time').textContent = apptDate.toLocaleDateString();
                        }
                    } else {
                        document.getElementById('next-appointment-time').textContent = 'None';
                    }
                    
                    // Update Activity Overview
                    document.getElementById('total-records-overview').textContent = data.overview?.total_records?.toLocaleString() || '0';
                    document.getElementById('today-activity').textContent = data.overview?.today_activity?.toLocaleString() || '0';
                    document.getElementById('system-health').textContent = (data.overview?.system_health || 'stable').charAt(0).toUpperCase() + (data.overview?.system_health || 'stable').slice(1);
                    
                    // Update dashboard title and description
                    const titleEl = document.getElementById('dashboard-title');
                    const descEl = document.getElementById('dashboard-description');
                    if (titleEl) {
                        titleEl.textContent = 'Dashboard Overview';
                    }
                    if (descEl) {
                        descEl.textContent = 'Real-time insights and statistics from all modules';
                    }
                    
                    console.log('‚úÖ Dashboard statistics updated successfully');
                } else {
                    console.error('Failed to fetch dashboard stats:', response.status);
                    // Set error state
                    const errorText = 'Error';
                    document.querySelectorAll('[id$="-stat"]').forEach(el => {
                        if (el.textContent === '-') el.textContent = errorText;
                    });
                }
            } catch (error) {
                console.error('Failed to load dashboard stats:', error);
                // Set error state
                const errorText = 'Error';
                document.querySelectorAll('[id$="-stat"]').forEach(el => {
                    if (el.textContent === '-') el.textContent = errorText;
                });
            }
        }

        // Show message
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type} show`;
            setTimeout(() => messageDiv.classList.remove('show'), 5000);
        }

        // Register user
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                username: document.getElementById('reg-username').value,
                email: document.getElementById('reg-email').value,
                password: document.getElementById('reg-password').value,
                role: document.getElementById('reg-role').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/users/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showMessage('Registration successful! Please login.', 'success');
                    switchTab('login');
                    e.target.reset();
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Registration failed', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        });

        // Login user
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('username', document.getElementById('login-username').value);
            formData.append('password', document.getElementById('login-password').value);

            try {
                const response = await fetch(`${API_BASE_URL}/token`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    localStorage.setItem('authToken', authToken);
                    
                    await loadUserProfile();
                    showMessage('Login successful!', 'success');
                    e.target.reset();
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Login failed', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        });

        // Load user profile
        async function loadUserProfile() {
            try {
                console.log('üîÑ Loading user profile...');
                const response = await fetch(`${API_BASE_URL}/users/me`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    console.log('‚úÖ User profile loaded:', currentUser);
                    
                    document.getElementById('user-info').textContent = `${currentUser.username} - ${currentUser.role.toUpperCase()}`;
                    document.getElementById('user-greeting').textContent = `Welcome, ${currentUser.username}!`;
                    
                    // Show dashboard layout first
                    console.log('üîÑ Showing dashboard...');
                    const container = document.querySelector('.container');
                    const dashboard = document.getElementById('dashboard-section');
                    
                    if (container && dashboard) {
                        container.classList.add('hidden');
                        dashboard.classList.add('active');
                        console.log('‚úÖ Dashboard shown successfully');
                        
                        // Small delay to ensure dashboard is rendered
                        setTimeout(async () => {
                            try {
                                console.log('üîÑ Initializing RBAC Manager...');
                                
                                // Check if rbacManager is available
                                if (typeof rbacManager !== 'undefined') {
                                    const rbacInitialized = await rbacManager.initialize();
                                    if (rbacInitialized) {
                                        console.log('‚úÖ RBAC initialized successfully');
                                        
                                        // Apply permission-based visibility
                                        rbacManager.applyPermissionBasedVisibility();
                                        
                                        // Create role-specific dashboard
                                        rbacManager.createRoleDashboard();
                                        
                                        // Apply role-based styling
                                        rbacManager.applyRoleBasedStyling();
                                        
                                        console.log('‚úÖ RBAC setup completed successfully');
                                        
                                        // Initialize demo features
                                        if (typeof initializeDemoFeatures === 'function') {
                                            initializeDemoFeatures();
                                        }
                                    } else {
                                        console.error('‚ùå Failed to initialize RBAC - showing fallback dashboard');
                                        showFallbackDashboard();
                                    }
                                } else {
                                    console.error('‚ùå RBAC Manager not loaded - showing fallback dashboard');
                                    showFallbackDashboard();
                                }
                            } catch (rbacError) {
                                console.error('‚ùå RBAC initialization error:', rbacError);
                                showFallbackDashboard();
                            }
                        }, 100);
                        
                    } else {
                        console.error('‚ùå Container or dashboard not found', { container, dashboard });
                    }
                    
                    // Load initial data
                    loadAppointments();
                    loadMessages();
                    loadDashboardStats();
                } else {
                    console.warn('‚ùå Failed to load user profile - status:', response.status);
                    logout();
                }
            } catch (error) {
                console.error('‚ùå Error loading user profile:', error);
                logout();
            }
        }

        // Fallback dashboard function
        function showFallbackDashboard() {
            console.log('üîÑ Showing fallback dashboard...');
            
            // Only show admin nav if user is actually admin
            if (currentUser && currentUser.role === 'admin') {
                const adminNavs = document.querySelectorAll('[data-admin-only]');
                adminNavs.forEach(nav => nav.style.display = 'block');
            } else {
                // Hide admin controls for non-admin users
                const adminNavs = document.querySelectorAll('[data-admin-only]');
                adminNavs.forEach(nav => nav.style.display = 'none');
                
                // Hide admin modules and sections
                const adminElements = document.querySelectorAll('.admin-only, [data-admin], .admin-controls');
                adminElements.forEach(element => element.style.display = 'none');
            }
            
            // Update dashboard title
            const titleElement = document.getElementById('dashboard-title');
            if (titleElement) {
                const roleDisplayNames = {
                    'admin': 'ADMIN',
                    'physician': 'PHYSICIAN', 
                    'therapist': 'THERAPIST',
                    'health_coach': 'HEALTH COACH',
                    'patient': 'PATIENT',
                    'partner': 'PARTNER'
                };
                const displayName = roleDisplayNames[currentUser?.role] || 'USER';
                titleElement.textContent = `${displayName} Dashboard`;
            }
            
            // Hide loading spinner
            const loadingSpinner = document.querySelector('.loading-spinner');
            if (loadingSpinner) {
                loadingSpinner.style.display = 'none';
            }
            
            // Create basic role-appropriate dashboard if role-specific dashboards failed
            createBasicRoleDashboard();
            
            console.log('‚úÖ Fallback dashboard shown for role:', currentUser?.role);
        }

        // Create basic role-appropriate dashboard when role-specific dashboards fail
        function createBasicRoleDashboard() {
            const dashboardContainer = document.getElementById('dashboard-modules');
            if (!dashboardContainer) return;
            
            // Clear existing content
            dashboardContainer.innerHTML = '';
            
            // Role-specific basic modules
            const roleModules = {
                'admin': [
                    { name: 'users', title: 'User Management', icon: 'üë•', description: 'Manage system users' },
                    { name: 'analytics', title: 'Analytics', icon: 'üìä', description: 'System reports and insights' },
                    { name: 'security', title: 'Security', icon: 'üîí', description: 'Security monitoring' },
                    { name: 'settings', title: 'Settings', icon: '‚öôÔ∏è', description: 'System configuration' }
                ],
                'physician': [
                    { name: 'appointments', title: 'Appointments', icon: 'üìÖ', description: 'Patient appointments' },
                    { name: 'health', title: 'Health Records', icon: 'üè•', description: 'Patient health data' },
                    { name: 'analytics', title: 'Analytics', icon: 'üìä', description: 'Medical insights' },
                    { name: 'messages', title: 'Messages', icon: 'üí¨', description: 'Patient communication' }
                ],
                'therapist': [
                    { name: 'appointments', title: 'Therapy Sessions', icon: 'üó£Ô∏è', description: 'Therapy appointments' },
                    { name: 'messages', title: 'Messages', icon: 'üí¨', description: 'Client communication' },
                    { name: 'analytics', title: 'Progress Reports', icon: 'üìà', description: 'Client progress' }
                ],
                'health_coach': [
                    { name: 'appointments', title: 'Coaching Sessions', icon: 'üéØ', description: 'Coaching appointments' },
                    { name: 'nutrition', title: 'Nutrition Plans', icon: 'ü•ó', description: 'Client nutrition' },
                    { name: 'analytics', title: 'Wellness Reports', icon: 'üìä', description: 'Wellness insights' }
                ],
                'patient': [
                    { name: 'appointments', title: 'My Appointments', icon: 'üìÖ', description: 'Your appointments' },
                    { name: 'health', title: 'My Health', icon: 'üè•', description: 'Your health records' },
                    { name: 'nutrition', title: 'My Nutrition', icon: 'ü•ó', description: 'Your meal plans' },
                    { name: 'messages', title: 'Messages', icon: 'üí¨', description: 'Communication' }
                ],
                'partner': [
                    { name: 'messages', title: 'Messages', icon: 'üí¨', description: 'Communication' },
                    { name: 'analytics', title: 'Reports', icon: 'üìä', description: 'Access reports' }
                ]
            };
            
            const userRole = currentUser?.role || 'patient';
            const modules = roleModules[userRole] || roleModules['patient'];
            
            // Create module cards
            const modulesHTML = modules.map(module => `
                <div class="col-md-4 col-sm-6 mb-3">
                    <div class="card h-100 module-card" data-module="${module.name}">
                        <div class="card-body d-flex flex-column">
                            <div class="text-center mb-2">
                                <span class="module-icon" style="font-size: 2rem;">${module.icon}</span>
                            </div>
                            <h6 class="card-title text-center">${module.title}</h6>
                            <p class="card-text text-muted small text-center flex-grow-1">${module.description}</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="openModule('${module.name}')">
                                Access ${module.title}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            dashboardContainer.innerHTML = `<div class="row">${modulesHTML}</div>`;
        }

        // Load appointments
        async function loadAppointments() {
            const listDiv = document.getElementById('appointments-list');
            listDiv.innerHTML = '<div class="loading">Loading appointments...</div>';

            try {
                // Load therapists for booking form
                await loadTherapists();
                
                // Update calendar sync status
                updateCalendarSyncStatus();
                
                // Determine which endpoint to use based on user role
                const endpoint = currentUser.role === 'admin' ? 'appointments' : 'appointments/my';
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });

                if (response.ok) {
                    const appointments = await response.json();
                    window.allAppointments = appointments; // Store for filtering
                    
                    if (appointments.length === 0) {
                        listDiv.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üìÖ</div>
                                <h3>No appointments yet</h3>
                                <p>Click "Book New Appointment" to schedule your first session</p>
                            </div>
                        `;
                        return;
                    }

                    displayAppointments(appointments);
                } else {
                    listDiv.innerHTML = '<p style="color: red; text-align: center; padding: 20px;">Failed to load appointments</p>';
                }
            } catch (error) {
                listDiv.innerHTML = '<p style="color: red; text-align: center; padding: 20px;">Network error loading appointments</p>';
                console.error('Error loading appointments:', error);
            }
        }

        // Display appointments with enhanced formatting
        function displayAppointments(appointments) {
            const listDiv = document.getElementById('appointments-list');
            
            listDiv.innerHTML = appointments.map(apt => {
                const appointmentDate = new Date(apt.appointment_datetime);
                const isUpcoming = appointmentDate > new Date();
                const statusColors = {
                    'scheduled': '#3b82f6',
                    'confirmed': '#10b981', 
                    'completed': '#6b7280',
                    'cancelled': '#ef4444',
                    'no_show': '#f59e0b'
                };
                
                const typeIcons = {
                    'consultation': 'üí¨',
                    'therapy': 'üß†',
                    'follow-up': 'üìã',
                    'assessment': 'üìä',
                    'group': 'üë•'
                };
                
                return `
                    <div class="appointment-card" data-status="${apt.status}" data-type="${apt.appointment_type}" style="
                        background: white; 
                        border: 1px solid #e5e7eb; 
                        border-radius: 12px; 
                        padding: 20px; 
                        margin-bottom: 15px;
                        transition: all 0.3s ease;
                        cursor: pointer;
                        border-left: 4px solid ${statusColors[apt.status] || '#6b7280'};
                    " onclick="showAppointmentDetails(${apt.id})">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div>
                                <h3 style="margin: 0 0 5px 0; color: var(--text-dark); display: flex; align-items: center; gap: 8px;">
                                    ${typeIcons[apt.appointment_type] || 'üìÖ'} 
                                    ${apt.appointment_type.charAt(0).toUpperCase() + apt.appointment_type.slice(1)} Session
                                </h3>
                                <p style="margin: 0; color: #6b7280; font-size: 14px;">Appointment #${apt.id}</p>
                            </div>
                            <div style="text-align: right;">
                                <span style="
                                    background: ${statusColors[apt.status] || '#6b7280'}; 
                                    color: white; 
                                    padding: 4px 12px; 
                                    border-radius: 20px; 
                                    font-size: 12px; 
                                    font-weight: 500;
                                    text-transform: uppercase;
                                ">${apt.status}</span>
                                ${apt.sync_with_calendar ? '<div style="margin-top: 5px; font-size: 12px; color: #10b981;">üìÖ Synced</div>' : ''}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <strong style="color: var(--text-dark);">üìÖ Date & Time:</strong><br>
                                <span style="color: #374151;">${appointmentDate.toLocaleDateString()}</span><br>
                                <span style="color: #6b7280; font-size: 14px;">${appointmentDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            </div>
                            <div>
                                <strong style="color: var(--text-dark);">‚è±Ô∏è Duration:</strong><br>
                                <span style="color: #374151;">${apt.duration_minutes} minutes</span>
                            </div>
                        </div>
                        
                        ${apt.location ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--text-dark);">üìç Location:</strong> 
                                <span style="color: #374151;">${apt.location}</span>
                            </div>
                        ` : ''}
                        
                        ${apt.notes ? `
                            <div style="margin-bottom: 15px;">
                                <strong style="color: var(--text-dark);">üìù Notes:</strong> 
                                <span style="color: #374151;">${apt.notes}</span>
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 15px; border-top: 1px solid #f3f4f6;">
                            ${isUpcoming && apt.status === 'scheduled' ? `
                                <button onclick="event.stopPropagation(); confirmAppointment(${apt.id})" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    ‚úÖ Confirm
                                </button>
                            ` : ''}
                            ${(isUpcoming && (apt.status === 'scheduled' || apt.status === 'confirmed')) ? `
                                <button onclick="event.stopPropagation(); editAppointment(${apt.id})" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button onclick="event.stopPropagation(); cancelAppointment(${apt.id})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    ‚ùå Cancel
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load therapists for booking form
        async function loadTherapists() {
            try {
                const response = await fetch(`${API_BASE_URL}/therapists`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });

                if (response.ok) {
                    const therapists = await response.json();
                    const select = document.getElementById('booking-therapist');
                    
                    select.innerHTML = '<option value="">Select a therapist...</option>' + 
                        therapists.map(therapist => 
                            `<option value="${therapist.id}">${therapist.username} (${therapist.email})</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading therapists:', error);
            }
        }

        // Appointment management functions
        function showAppointmentBooking() {
            document.getElementById('appointment-booking-form').style.display = 'block';
            // Set minimum date to today
            const now = new Date();
            const minDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('booking-datetime').min = minDateTime;
        }

        function hideAppointmentBooking() {
            document.getElementById('appointment-booking-form').style.display = 'none';
            document.getElementById('booking-form').reset();
        }

        // ============================================
        // Google Calendar Integration
        // ============================================
        // Provides configuration UI for Google Calendar sync
        // Stores settings in localStorage and backend
        // Status is displayed in appointment booking forms
        
        async function configureGoogleCalendar() {
            const configHTML = `
                <div style="padding: 20px;">
                    <h3 style="color: #4285f4; margin-bottom: 20px;">Google Calendar Integration</h3>
                    
                    <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4285f4;">
                        <p style="margin: 0 0 10px 0; font-weight: 600;">Setup Instructions:</p>
                        <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>Go to <a href="https://console.cloud.google.com" target="_blank" style="color: #4285f4;">Google Cloud Console</a></li>
                            <li>Create a new project or select an existing one</li>
                            <li>Enable the Google Calendar API</li>
                            <li>Create OAuth 2.0 credentials (Desktop app or Web application)</li>
                            <li>Download the credentials JSON file</li>
                            <li>Upload the credentials file below</li>
                        </ol>
                    </div>

                    <form id="google-calendar-config-form" onsubmit="saveGoogleCalendarConfig(event)">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Calendar ID:</label>
                            <input type="text" id="calendar-id" placeholder="primary (or your calendar ID)" 
                                value="${localStorage.getItem('googleCalendarId') || 'primary'}"
                                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #6b7280;">
                                Use 'primary' for your main calendar, or enter a specific calendar ID
                            </p>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Credentials File:</label>
                            <input type="file" id="credentials-file" accept=".json" 
                                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #6b7280;">
                                Upload your Google OAuth 2.0 credentials JSON file
                            </p>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="auto-sync-enabled" 
                                    ${localStorage.getItem('googleCalendarAutoSync') === 'true' ? 'checked' : ''}>
                                <span>Automatically sync all appointments</span>
                            </label>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Reminder (minutes before):</label>
                            <input type="number" id="calendar-reminder" value="${localStorage.getItem('googleCalendarReminder') || '30'}" min="0" 
                                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>

                        <div id="calendar-config-status" style="margin-bottom: 15px; padding: 10px; border-radius: 6px; display: none;"></div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="testGoogleCalendarConnection()" 
                                style="padding: 10px 20px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;">
                                Test Connection
                            </button>
                            <button type="submit" 
                                style="padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Save Configuration
                            </button>
                        </div>
                    </form>

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <h4 style="margin-bottom: 10px;">Current Status:</h4>
                        <div id="calendar-status-info" style="padding: 15px; background: #f9fafb; border-radius: 6px;">
                            <p style="margin: 0;">
                                <strong>Status:</strong> <span id="calendar-connection-status">${localStorage.getItem('googleCalendarConfigured') === 'true' ? '‚úÖ Configured' : '‚ùå Not Configured'}</span>
                            </p>
                            <p style="margin: 10px 0 0 0;">
                                <strong>Auto-sync:</strong> ${localStorage.getItem('googleCalendarAutoSync') === 'true' ? '‚úÖ Enabled' : '‚ùå Disabled'}
                            </p>
                        </div>
                    </div>
                </div>
            `;

            showLargeModal('Google Calendar Configuration', configHTML);
        }

        async function saveGoogleCalendarConfig(event) {
            event.preventDefault();
            
            const calendarId = document.getElementById('calendar-id').value;
            const autoSync = document.getElementById('auto-sync-enabled').checked;
            const reminder = document.getElementById('calendar-reminder').value;
            const credentialsFile = document.getElementById('credentials-file').files[0];

            // Save to localStorage
            localStorage.setItem('googleCalendarId', calendarId);
            localStorage.setItem('googleCalendarAutoSync', autoSync);
            localStorage.setItem('googleCalendarReminder', reminder);

            // Handle credentials file upload
            if (credentialsFile) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const credentials = JSON.parse(e.target.result);
                        
                        // Send to backend for storage
                        const response = await authenticatedFetch(`${API_BASE_URL}/settings/google-calendar-credentials`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                calendar_id: calendarId,
                                credentials: credentials,
                                auto_sync: autoSync,
                                reminder_minutes: parseInt(reminder)
                            })
                        });

                        if (response.ok) {
                            localStorage.setItem('googleCalendarConfigured', 'true');
                            showConfigStatus('‚úÖ Google Calendar configured successfully!', 'success');
                            updateCalendarSyncStatus();
                        } else {
                            showConfigStatus('‚ùå Failed to save configuration', 'error');
                        }
                    } catch (error) {
                        showConfigStatus('‚ùå Invalid credentials file', 'error');
                    }
                };
                reader.readAsText(credentialsFile);
            } else {
                // Just save settings without credentials update
                localStorage.setItem('googleCalendarConfigured', 'true');
                showConfigStatus('‚úÖ Settings saved successfully!', 'success');
                updateCalendarSyncStatus();
            }
        }

        async function testGoogleCalendarConnection() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/settings/google-calendar-test`, {
                    method: 'GET'
                });

                if (response.ok) {
                    const result = await response.json();
                    showConfigStatus(`‚úÖ Connection successful! Connected to: ${result.calendar_name || 'Google Calendar'}`, 'success');
                } else {
                    showConfigStatus('‚ùå Connection failed. Please check your credentials.', 'error');
                }
            } catch (error) {
                showConfigStatus('‚ùå Connection test failed: ' + error.message, 'error');
            }
        }

        function showConfigStatus(message, type) {
            const statusDiv = document.getElementById('calendar-config-status');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.style.background = type === 'success' ? '#d1fae5' : '#fee2e2';
            statusDiv.style.color = type === 'success' ? '#065f46' : '#991b1b';
            statusDiv.style.border = `1px solid ${type === 'success' ? '#10b981' : '#ef4444'}`;
        }

        function updateCalendarSyncStatus() {
            const statusElement = document.getElementById('calendar-sync-status');
            if (statusElement) {
                const isConfigured = localStorage.getItem('googleCalendarConfigured') === 'true';
                statusElement.textContent = isConfigured ? '‚úÖ Configured and ready' : '‚ùå Not configured';
                statusElement.style.color = isConfigured ? '#10b981' : '#6b7280';
            }
        }

        function switchAppointmentView(view) {
            const listView = document.getElementById('appointments-list-view');
            const calendarView = document.getElementById('appointments-calendar-view');
            const listBtn = document.getElementById('list-view-btn');
            const calendarBtn = document.getElementById('calendar-view-btn');

            if (view === 'list') {
                listView.style.display = 'block';
                calendarView.style.display = 'none';
                listBtn.style.background = '#3b82f6';
                listBtn.style.color = 'white';
                calendarBtn.style.background = '#e5e7eb';
                calendarBtn.style.color = '#374151';
            } else {
                listView.style.display = 'none';
                calendarView.style.display = 'block';
                listBtn.style.background = '#e5e7eb';
                listBtn.style.color = '#374151';
                calendarBtn.style.background = '#3b82f6';
                calendarBtn.style.color = 'white';
            }
        }

        function filterAppointments(status) {
            const appointments = window.allAppointments || [];
            const filtered = status === 'all' ? appointments : appointments.filter(apt => apt.status === status);
            
            // Update filter button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === status) {
                    btn.style.background = '#3b82f6';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#3b82f6';
                }
            });
            
            displayAppointments(filtered);
        }

        // Appointment booking form submission
        document.addEventListener('DOMContentLoaded', function() {
            const bookingForm = document.getElementById('booking-form');
            if (bookingForm) {
                bookingForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(e.target);
                    const appointmentData = {
                        therapist_id: parseInt(document.getElementById('booking-therapist').value),
                        appointment_datetime: document.getElementById('booking-datetime').value,
                        duration_minutes: parseInt(document.getElementById('booking-duration').value),
                        appointment_type: document.getElementById('booking-type').value,
                        location: document.getElementById('booking-location').value,
                        notes: document.getElementById('booking-notes').value,
                        sync_with_calendar: document.getElementById('booking-calendar-sync').checked
                    };

                    try {
                        const response = await fetch(`${API_BASE_URL}/appointments`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${getAuthToken()}`
                            },
                            body: JSON.stringify(appointmentData)
                        });

                        if (response.ok) {
                            showMessage('Appointment booked successfully!', 'success');
                            hideAppointmentBooking();
                            loadAppointments(); // Refresh the list
                        } else {
                            const error = await response.json();
                            showMessage(error.detail || 'Failed to book appointment', 'error');
                        }
                    } catch (error) {
                        showMessage('Network error. Please try again.', 'error');
                        console.error('Error booking appointment:', error);
                    }
                });
            }
        });

        // Appointment action functions
        async function confirmAppointment(appointmentId) {
            try {
                const response = await fetch(`${API_BASE_URL}/appointments/${appointmentId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ status: 'confirmed' })
                });

                if (response.ok) {
                    showMessage('Appointment confirmed!', 'success');
                    loadAppointments();
                } else {
                    showMessage('Failed to confirm appointment', 'error');
                }
            } catch (error) {
                showMessage('Network error', 'error');
            }
        }

        async function cancelAppointment(appointmentId) {
            if (confirm('Are you sure you want to cancel this appointment?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/appointments/${appointmentId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                    });

                    if (response.ok) {
                        showMessage('Appointment cancelled', 'success');
                        loadAppointments();
                    } else {
                        showMessage('Failed to cancel appointment', 'error');
                    }
                } catch (error) {
                    showMessage('Network error', 'error');
                }
            }
        }

        function editAppointment(appointmentId) {
            // This would open an edit form - for now, show a message
            showMessage('Edit functionality coming soon!', 'info');
        }

        function showAppointmentDetails(appointmentId) {
            // This would show detailed appointment view - for now, show a message
            showMessage(`Viewing details for appointment #${appointmentId}`, 'info');
        }

        // Load messages
        async function loadMessages() {
            const listDiv = document.getElementById('messages-list');
            listDiv.innerHTML = '<div class="loading">Loading messages...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/messages/inbox`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });

                if (response.ok) {
                    const messages = await response.json();
                    
                    if (messages.length === 0) {
                        listDiv.innerHTML = '<p style="text-align: center; color: #666;">No messages yet.</p>';
                        return;
                    }

                    listDiv.innerHTML = messages.map(msg => `
                        <div class="message-card">
                            <h3>${msg.subject}</h3>
                            <p><strong>From:</strong> User #${msg.sender_id}</p>
                            <p><strong>Date:</strong> ${new Date(msg.timestamp).toLocaleString()}</p>
                            <p>${msg.content}</p>
                        </div>
                    `).join('');
                } else {
                    listDiv.innerHTML = '<p style="color: red;">Failed to load messages</p>';
                }
            } catch (error) {
                listDiv.innerHTML = '<p style="color: red;">Network error</p>';
            }
        }

        // Book appointment
        document.getElementById('book-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                therapist_id: parseInt(document.getElementById('therapist-id').value),
                appointment_datetime: document.getElementById('appointment-datetime').value,
                notes: document.getElementById('notes').value || null
            };

            try {
                const response = await fetch(`${API_BASE_URL}/appointments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showMessage('Appointment booked successfully!', 'success');
                    e.target.reset();
                    switchDashboardTab('appointments');
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Booking failed', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        });

        // Logout
        function logout() {
            console.log('Logging out...');
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');

            const container = document.querySelector('.container');
            const dashboard = document.getElementById('dashboard-section');
            
            if (container) container.classList.remove('hidden');
            if (dashboard) dashboard.classList.remove('active');

            console.log('Logout complete - login form shown');
        }

        // User Management Module
        async function openUserManagementModule() {
            const userMgmtHTML = `
                <div style="display: flex; gap: 20px; min-height: 600px;">
                    <!-- Left side - Add User Form -->
                    <div style="flex: 0 0 380px; background: var(--bg-light); padding: 25px; border-radius: 12px;">
                        <h3 style="color: var(--primary-green); margin-bottom: 20px;">Create New User</h3>
                        
                        <!-- User Creation Form -->
                        <form id="add-user-form" style="margin-bottom: 30px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Username *</label>
                                <input type="text" id="new-username" required minlength="3" placeholder="Enter username" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Email *</label>
                                <input type="email" id="new-email" required placeholder="user@example.com" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Password *</label>
                                <input type="password" id="new-password" required minlength="8" placeholder="Min 8 characters" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Full Name</label>
                                <input type="text" id="new-fullname" placeholder="John Doe" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Role *</label>
                                <select id="new-role" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                    <option value="patient">Patient - Seeking therapy</option>
                                    <option value="therapist">Therapist - Healthcare provider</option>
                                    <option value="health_coach">Health Coach - Wellness guidance</option>
                                    <option value="physician">Physician - Medical doctor</option>
                                    <option value="partner">Partner - External partner/organization</option>
                                    <option value="admin">Admin - Full system access</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Phone Number</label>
                                <input type="tel" id="new-phone" placeholder="+1234567890" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            <button type="submit" style="width: 100%; padding: 12px; background: var(--primary-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Create User</button>
                        </form>

                        <!-- User Statistics -->
                        <div style="border-top: 2px solid var(--border-color); padding-top: 20px;">
                            <h3 style="color: var(--primary-green); margin-bottom: 15px; font-size: 16px;">User Statistics</h3>
                            <div id="user-stats" style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                                <p style="margin: 8px 0; font-size: 14px;"><strong>Total Users:</strong> <span id="total-users">-</span></p>
                                <p style="margin: 8px 0; font-size: 14px;"><strong>Admins:</strong> <span id="admin-count">-</span></p>
                                <p style="margin: 8px 0; font-size: 14px;"><strong>Therapists:</strong> <span id="therapist-count">-</span></p>
                                <p style="margin: 8px 0; font-size: 14px;"><strong>Patients:</strong> <span id="patient-count">-</span></p>
                                <p style="margin: 8px 0; font-size: 14px;"><strong>Health Coaches:</strong> <span id="health-coach-count">-</span></p>
                                <p style="margin: 8px 0; font-size: 14px;"><strong>Physicians:</strong> <span id="physician-count">-</span></p>
                                <p style="margin: 8px 0; font-size: 14px;"><strong>Partners:</strong> <span id="partner-count">-</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Right side - Users Table -->
                    <div style="flex: 1; background: white; padding: 25px; border-radius: 12px; overflow: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--primary-green); margin: 0;">All Users Database</h3>
                            <button onclick="loadUsersData()" style="padding: 8px 16px; background: var(--accent-green); color: white; border: none; border-radius: 6px; cursor: pointer;">Refresh</button>
                        </div>
                        <div id="users-table-container">
                            <p style="text-align: center; color: var(--text-light);">Loading users data...</p>
                        </div>
                    </div>
                </div>
            `;
            
            showLargeModal('üë• User Management', userMgmtHTML);
            
            // Load users data
            loadUsersData();
            
            // Setup form submission
            document.getElementById('add-user-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addUser();
            });
        }

        async function loadUsersData() {
            const container = document.getElementById('users-table-container');
            container.innerHTML = '<p style="text-align: center; color: var(--text-light);">Loading...</p>';
            
            try {
                const token = getAuthToken();
                if (!token) {
                    container.innerHTML = '<p style="color: red; text-align: center;">Please log in to view users</p>';
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const users = await response.json();
                    
                    // Update statistics
                    const totalUsers = users.length;
                    const adminCount = users.filter(u => u.role === 'admin').length;
                    const therapistCount = users.filter(u => u.role === 'therapist').length;
                    const patientCount = users.filter(u => u.role === 'patient').length;
                    const healthCoachCount = users.filter(u => u.role === 'health_coach').length;
                    const physicianCount = users.filter(u => u.role === 'physician').length;
                    const partnerCount = users.filter(u => u.role === 'partner').length;

                    if (document.getElementById('total-users')) {
                        document.getElementById('total-users').textContent = totalUsers;
                        document.getElementById('admin-count').textContent = adminCount;
                        document.getElementById('therapist-count').textContent = therapistCount;
                        document.getElementById('patient-count').textContent = patientCount;
                        document.getElementById('health-coach-count').textContent = healthCoachCount;
                        document.getElementById('physician-count').textContent = physicianCount;
                        document.getElementById('partner-count').textContent = partnerCount;
                    }

                    if (users.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No users found.</p>';
                        return;
                    }

                    // Role badge colors
                    const getRoleBadge = (role) => {
                        const colors = {
                            'admin': 'background: #dc3545; color: white;',
                            'therapist': 'background: #0dcaf0; color: white;',
                            'patient': 'background: #198754; color: white;',
                            'health_coach': 'background: #fd7e14; color: white;',
                            'physician': 'background: #6610f2; color: white;',
                            'partner': 'background: #0d6efd; color: white;'
                        };
                        const displayNames = {
                            'admin': 'ADMIN',
                            'therapist': 'THERAPIST',
                            'patient': 'PATIENT',
                            'health_coach': 'HEALTH COACH',
                            'physician': 'PHYSICIAN',
                            'partner': 'PARTNER'
                        };
                        return `<span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; ${colors[role] || 'background: #6c757d; color: white;'}">${displayNames[role] || role.toUpperCase()}</span>`;
                    };

                    container.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--bg-light); border-bottom: 2px solid var(--primary-green);">
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">ID</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Username</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Email</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Full Name</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Role</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Phone</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Status</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Created</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr style="border-bottom: 1px solid var(--border-color);" id="user-row-${user.id}">
                                        <td style="padding: 12px;">${user.id}</td>
                                        <td style="padding: 12px; font-weight: 500;">${user.username}</td>
                                        <td style="padding: 12px;">${user.email || '-'}</td>
                                        <td style="padding: 12px;">${user.full_name || '-'}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            <select onchange="updateUserRole(${user.id}, this.value)" style="padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 12px; font-weight: 600;">
                                                <option value="patient" ${user.role === 'patient' ? 'selected' : ''}>Patient</option>
                                                <option value="therapist" ${user.role === 'therapist' ? 'selected' : ''}>Therapist</option>
                                                <option value="health_coach" ${user.role === 'health_coach' ? 'selected' : ''}>Health Coach</option>
                                                <option value="physician" ${user.role === 'physician' ? 'selected' : ''}>Physician</option>
                                                <option value="partner" ${user.role === 'partner' ? 'selected' : ''}>Partner</option>
                                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                            </select>
                                        </td>
                                        <td style="padding: 12px;">${user.phone_number || '-'}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            <button onclick="toggleUserStatus(${user.id}, ${user.is_active})" style="padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; ${user.is_active ? 'background: #198754; color: white;' : 'background: #6c757d; color: white;'}">
                                                ${user.is_active ? '‚úì Active' : '‚úó Disabled'}
                                            </button>
                                        </td>
                                        <td style="padding: 12px; text-align: center; font-size: 13px;">${new Date(user.created_at).toLocaleDateString()}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            <button onclick="deleteUser(${user.id}, '${user.username}')" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                                üóëÔ∏è Delete
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p style="color: red; text-align: center;">Failed to load users data</p>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                container.innerHTML = '<p style="color: red; text-align: center;">Network error loading users</p>';
            }
        }

        async function updateUserRole(userId, newRole) {
            if (!confirm(`Are you sure you want to change this user's role to ${newRole}?`)) {
                loadUsersData(); // Reload to reset the dropdown
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}/role`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ role: newRole })
                });

                if (response.ok) {
                    showMessage('User role updated successfully!', 'success');
                    loadUsersData();
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to update role', 'error');
                    loadUsersData();
                }
            } catch (error) {
                console.error('Error updating role:', error);
                showMessage('Network error updating role', 'error');
                loadUsersData();
            }
        }

        async function toggleUserStatus(userId, currentStatus) {
            const action = currentStatus ? 'disable' : 'enable';
            if (!confirm(`Are you sure you want to ${action} this user?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ is_active: !currentStatus })
                });

                if (response.ok) {
                    showMessage(`User ${action}d successfully!`, 'success');
                    loadUsersData();
                } else {
                    const error = await response.json();
                    showMessage(error.detail || `Failed to ${action} user`, 'error');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showMessage('Network error updating status', 'error');
            }
        }

        async function deleteUser(userId, username) {
            if (!confirm(`‚ö†Ô∏è WARNING: Are you sure you want to PERMANENTLY DELETE user "${username}"?\n\nThis action CANNOT be undone!`)) {
                return;
            }

            // Second confirmation for safety
            const confirmText = prompt(`To confirm deletion, type the username: ${username}`);
            if (confirmText !== username) {
                showMessage('Deletion cancelled - username did not match', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (response.ok) {
                    showMessage(`User "${username}" deleted successfully`, 'success');
                    // Remove row with animation
                    const row = document.getElementById(`user-row-${userId}`);
                    if (row) {
                        row.style.transition = 'opacity 0.3s';
                        row.style.opacity = '0';
                        setTimeout(() => loadUsersData(), 300);
                    } else {
                        loadUsersData();
                    }
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to delete user', 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showMessage('Network error deleting user', 'error');
            }
        }

        async function addUser() {
            const userData = {
                username: document.getElementById('new-username').value,
                email: document.getElementById('new-email').value,
                password: document.getElementById('new-password').value,
                full_name: document.getElementById('new-fullname').value || null,
                role: document.getElementById('new-role').value,
                phone_number: document.getElementById('new-phone').value || null
            };

            try {
                const response = await fetch(`${API_BASE_URL}/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                if (response.ok) {
                    showMessage('User created successfully!', 'success');
                    document.getElementById('add-user-form').reset();
                    loadUsersData();
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to create user', 'error');
                }
            } catch (error) {
                console.error('Error creating user:', error);
                showMessage('Network error creating user', 'error');
            }
        }

        // Meals Module
        async function openMealsModule() {
            const mealsHTML = `
                <div style="display: flex; flex-direction: column; gap: 20px; min-height: 600px;">
                    <!-- View Toggle Buttons -->
                    <div style="display: flex; gap: 10px; background: white; padding: 15px; border-radius: 12px; align-items: center; flex-wrap: wrap;">
                        <button onclick="showMealsListView()" id="list-view-btn" style="flex: 0 0 auto; min-width: 140px; padding: 12px 16px; background: linear-gradient(135deg, var(--primary-green) 0%, #27ae60 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; white-space: nowrap;">
                            üìã List View
                        </button>
                        <button onclick="showWeeklyPlanView()" id="weekly-view-btn" style="flex: 0 0 auto; min-width: 180px; padding: 12px 16px; background: white; color: var(--primary-green); border: 2px solid var(--primary-green); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; white-space: nowrap;">
                            üìÖ Weekly Plan View
                        </button>
                        <select id="week-selector" style="padding: 12px 10px; border: 2px solid var(--border-color); border-radius: 8px; font-weight: 600; color: var(--primary-green); min-width: 100px; font-size: 14px;"
                            onchange="syncWeekNumberWithSelector()">
                            <!-- Week options will be populated dynamically via JavaScript -->
                        </select>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" id="max-weeks-input" min="4" max="104" value="52" placeholder="Max" 
                                style="padding: 12px 8px; border: 2px solid var(--border-color); border-radius: 8px; width: 80px; font-weight: 600; font-size: 14px; text-align: center;"
                                onchange="populateWeekSelector()" />
                            <label style="color: var(--text-primary); font-weight: 500; font-size: 14px; white-space: nowrap;">
                                max weeks
                            </label>
                        </div>
                    </div>

                    <!-- List View Container -->
                    <div id="meals-list-view" style="display: flex; gap: 20px; min-height: 600px;">
                    <!-- Left side - Form and Upload -->
                    <div style="flex: 0 0 400px; background: var(--bg-light); padding: 25px; border-radius: 12px; overflow-y: auto;">
                        <!-- Manage Types Button (outside form) -->
                        <div style="margin-bottom: 20px;">
                            <button onclick="openMealTypesManagement()" style="width: 100%; padding: 10px 16px; background: linear-gradient(135deg, #d2691e 0%, #cd853f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; box-shadow: 0 2px 4px rgba(210, 105, 30, 0.3); transition: all 0.3s;">
                                ‚öôÔ∏è Manage Meal Types
                            </button>
                        </div>

                        <h3 style="color: var(--primary-green); margin-bottom: 20px;">Add New Meal</h3>
                        
                        <!-- Manual Entry Form -->
                        <form id="add-meal-form" style="margin-bottom: 30px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Meal Name *</label>
                                <input type="text" id="meal-name" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Meal Type *</label>
                                <select id="meal-type" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;" onchange="updateMealTime()">
                                    <option value="">-- Select Type --</option>
                                    <option value="Breakfast">Breakfast</option>
                                    <option value="Lunch">Lunch</option>
                                    <option value="Dinner">Dinner</option>
                                    <option value="Snacks">Snacks</option>
                                    <option value="Special">Special</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Meal Time</label>
                                <input type="time" id="meal-time" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Week Number *</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-weight: 500; color: var(--primary-green);">Week</span>
                                    <input type="number" id="week-number" required min="1" max="52" value="1" 
                                        style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; font-weight: 600; text-align: center;"
                                        onchange="syncWeekSelectorWithNumber()" oninput="syncWeekSelectorWithNumber()">
                                    <div style="display: flex; flex-direction: column; gap: 2px;">
                                        <button type="button" onclick="incrementWeek()" style="padding: 4px 10px; background: var(--primary-green); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; line-height: 1;">‚ñ≤</button>
                                        <button type="button" onclick="decrementWeek()" style="padding: 4px 10px; background: var(--primary-green); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; line-height: 1;">‚ñº</button>
                                    </div>
                                </div>
                                <small style="display: block; margin-top: 5px; color: var(--text-light); font-size: 12px;">Select week number (synced with week selector)</small>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Day Number *</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-weight: 500; color: var(--secondary-green);">Day</span>
                                    <input type="number" id="day-number" required min="1" max="7" value="1" style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; font-weight: 600; text-align: center;">
                                    <div style="display: flex; flex-direction: column; gap: 2px;">
                                        <button type="button" onclick="incrementDay()" style="padding: 4px 10px; background: var(--secondary-green); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; line-height: 1;">‚ñ≤</button>
                                        <button type="button" onclick="decrementDay()" style="padding: 4px 10px; background: var(--secondary-green); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; line-height: 1;">‚ñº</button>
                                    </div>
                                </div>
                                <small style="display: block; margin-top: 5px; color: var(--text-light); font-size: 12px;">Select day number (1-7)</small>
                            </div>
                            
                            <div style="margin-bottom: 15px; position: relative;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">Ingredients *</label>
                                <textarea id="meal-ingredients" rows="4" 
                                    placeholder="Start typing ingredient names (comma-separated)... e.g., Chicken breast, Lettuce, Tomatoes"
                                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; resize: vertical; font-family: inherit;"
                                    oninput="handleIngredientInput(event)"></textarea>
                                <div id="ingredients-autocomplete" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid var(--border-color); border-radius: 6px; max-height: 200px; overflow-y: auto; width: calc(100% - 2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                                <small style="display: block; margin-top: 5px; color: var(--text-light); font-size: 12px;">
                                    Separate ingredients with commas. Start typing to see suggestions from ingredient database.
                                </small>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Instructions</label>
                                <textarea id="method-preparation" rows="4" placeholder="Describe the preparation instructions..." style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; resize: vertical; font-family: inherit;"></textarea>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Meal Notes</label>
                                <textarea id="meal-notes" rows="2" placeholder="Special notes for this specific meal..." style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; resize: vertical; font-family: inherit;"></textarea>
                                <small style="display: block; margin-top: 3px; color: var(--text-light); font-size: 11px;">Example: "One slice should match with 2 cook spoons of soup"</small>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Weekly Guidelines</label>
                                <textarea id="week-notes" rows="3" placeholder="Weekly notes and guidelines (optional, shared across all meals in this week)..." style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; resize: vertical; font-family: inherit;"></textarea>
                                <small style="display: block; margin-top: 3px; color: var(--text-light); font-size: 11px;">Example: "No eating after 6:00 p.m., Drink 2 liters of water daily"</small>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Date *</label>
                                <input type="date" id="meal-date" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            <button type="submit" style="width: 100%; padding: 12px; background: linear-gradient(135deg, var(--primary-green) 0%, #27ae60 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Add Meal</button>
                        </form>

                        <!-- File Upload Section -->
                        <div style="border-top: 2px solid var(--border-color); padding-top: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: var(--primary-green); margin: 0; font-size: 16px;">Bulk Import</h3>
                                <button onclick="downloadMealsTemplate()" style="width: 30%; min-width: 120px; padding: 6px 12px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: clamp(11px, 1.8vw, 12px); font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 5px; white-space: nowrap;">
                                    Download Template
                                </button>
                            </div>
                            <p style="font-size: 12px; color: var(--text-light); margin-bottom: 10px;">Upload CSV or Excel with columns:<br><em>name, meal_type, meal_time, period_type, ingredients, meal_date</em><br><small>Note: period_type should be "Week 1", "Week 2", etc. Ingredients should be comma-separated.</small></p>
                            <input type="file" id="meals-file-upload" accept=".csv,.xlsx,.xls" style="margin-bottom: 10px; font-size: 14px;">
                            <button onclick="uploadMealsFile()" style="width: 100%; padding: 10px; background: var(--secondary-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Upload File</button>
                        </div>
                    </div>

                    <!-- Right side - Data Table -->
                    <div style="flex: 1; background: white; padding: 25px; border-radius: 12px; overflow: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--primary-green); margin: 0; white-space: nowrap;">All Meals Database</h3>
                            <button onclick="loadMealsData()" style="padding: 8px 16px; background: var(--accent-green); color: white; border: none; border-radius: 6px; cursor: pointer;">Refresh</button>
                        </div>
                        <div id="meals-table-container">
                            <p style="text-align: center; color: var(--text-light);">Loading meals data...</p>
                        </div>
                    </div>
                </div>
                <!-- End List View -->

                <!-- Weekly Plan View Container -->
                <div id="meals-weekly-view" style="display: none; background: white; padding: 25px; border-radius: 12px; overflow: auto;">
                    <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 12px; border-left: 4px solid var(--primary-green);">
                        <h3 style="color: var(--primary-green); margin: 0 0 10px 0;">üìå Weekly Notes</h3>
                        <div id="weekly-notes-content" style="color: #333; line-height: 1.8; white-space: pre-wrap; font-size: 14px;">
                            Loading weekly notes...
                        </div>
                    </div>
                    
                    <div id="weekly-plan-container" style="overflow-x: auto;">
                        <p style="text-align: center; color: var(--text-light); padding: 40px;">Loading weekly meal plan...</p>
                    </div>
                </div>
            </div>
            `;
            
            showLargeModal('üçΩÔ∏è Meals Management', mealsHTML);
            
            // Set today's date as default
            document.getElementById('meal-date').valueAsDate = new Date();
            
            // Load meals data
            initializeMealsModule();
            
            // Setup form submission
            document.getElementById('add-meal-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addMeal();
            });
        }

        function updateMealTime() {
            const mealType = document.getElementById('meal-type').value;
            const mealTimeInput = document.getElementById('meal-time');
            
            const defaultTimes = {
                'Breakfast': '08:00',
                'Lunch': '12:30',
                'Dinner': '18:00',
                'Snacks': '15:00',
                'Special': ''
            };
            
            if (defaultTimes[mealType]) {
                mealTimeInput.value = defaultTimes[mealType];
            }
        }

        function getIngredients() {
            const textarea = document.getElementById('meal-ingredients');
            if (!textarea || !textarea.value.trim()) {
                return [];
            }
            
            // Split by comma and trim each ingredient
            const ingredients = textarea.value
                .split(',')
                .map(ing => ing.trim())
                .filter(ing => ing.length > 0);
            
            return ingredients;
        }

        function clearIngredientsForm() {
            const textarea = document.getElementById('meal-ingredients');
            if (textarea) {
                textarea.value = '';
            }
        }

        function populateIngredientsForEdit(ingredientsString) {
            const textarea = document.getElementById('meal-ingredients');
            if (textarea && ingredientsString) {
                textarea.value = ingredientsString;
            }
        }

        function incrementWeek() {
            const weekInput = document.getElementById('week-number');
            const maxWeeksInput = document.getElementById('max-weeks-input');
            const maxWeeks = parseInt(maxWeeksInput?.value) || 52;
            const currentValue = parseInt(weekInput.value) || 1;
            if (currentValue < maxWeeks) {
                weekInput.value = currentValue + 1;
                syncWeekSelectorWithNumber();
            }
        }

        function decrementWeek() {
            const weekInput = document.getElementById('week-number');
            const currentValue = parseInt(weekInput.value) || 1;
            if (currentValue > 1) {
                weekInput.value = currentValue - 1;
                syncWeekSelectorWithNumber();
            }
        }

        function incrementDay() {
            const dayInput = document.getElementById('day-number');
            const currentValue = parseInt(dayInput.value) || 1;
            if (currentValue < 7) {
                dayInput.value = currentValue + 1;
            }
        }

        function decrementDay() {
            const dayInput = document.getElementById('day-number');
            const currentValue = parseInt(dayInput.value) || 1;
            if (currentValue > 1) {
                dayInput.value = currentValue - 1;
            }
        }

        async function openMealTypesManagement() {
            const typesHTML = `
                <div style="padding: 20px;">
                    <!-- Back Button -->
                    <div style="margin-bottom: 20px;">
                        <button onclick="closeMealTypesAndReturnToMeals()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                            ‚Üê Back to Meal Management
                        </button>
                    </div>

                    <h3 style="color: var(--primary-green); margin-bottom: 20px;">Meal Types Management</h3>
                    
                    <!-- Add New Type Form -->
                    <div style="background: var(--bg-light); padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h4 style="margin-top: 0; margin-bottom: 15px;">Add New Meal Type</h4>
                        <form id="add-meal-type-form" style="display: grid; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Type Name *</label>
                                <input type="text" id="type-name" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;" placeholder="e.g., Pre-Workout, Midnight Snack">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Description</label>
                                <textarea id="type-description" rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;" placeholder="Optional description for this meal type"></textarea>
                            </div>
                            <button type="submit" style="padding: 12px; background: var(--primary-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Add Meal Type</button>
                        </form>
                    </div>

                    <!-- Existing Types List -->
                    <div>
                        <h4 style="margin-bottom: 15px;">Existing Meal Types</h4>
                        <div id="meal-types-list">
                            <p style="text-align: center; color: var(--text-light);">Loading meal types...</p>
                        </div>
                    </div>
                </div>
            `;
            
            showLargeModal('‚öôÔ∏è Meal Types Configuration', typesHTML);
            
            // Load existing meal types
            loadMealTypes();
            
            // Setup form submission
            document.getElementById('add-meal-type-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addMealType();
            });
        }

        async function loadMealTypes() {
            const container = document.getElementById('meal-types-list');
            container.innerHTML = '<p style="text-align: center; color: var(--text-light);">Loading...</p>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/meal-types`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });

                if (response.ok) {
                    const types = await response.json();
                    
                    if (types.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No custom meal types defined yet.</p>';
                        return;
                    }

                    container.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--bg-light); border-bottom: 2px solid var(--primary-green);">
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Type Name</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Description</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${types.map(type => `
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 12px; font-weight: 500;">${type.name}</td>
                                        <td style="padding: 12px;">${type.description || '-'}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            <button onclick="deleteMealType(${type.id}, '${type.name}')" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p style="color: red; text-align: center;">Failed to load meal types</p>';
                }
            } catch (error) {
                console.error('Error loading meal types:', error);
                container.innerHTML = '<p style="color: red; text-align: center;">Network error</p>';
            }
        }

        function closeMealTypesAndReturnToMeals() {
            // Close current modal and reopen meals module
            const modalOverlay = document.getElementById('large-modal-overlay');
            if (modalOverlay) {
                modalOverlay.remove();
            }
            // Reopen meals management
            openMealsModule();
        }

        async function addMealType() {
            const typeData = {
                name: document.getElementById('type-name').value,
                description: document.getElementById('type-description').value || null
            };

            try {
                const response = await fetch(`${API_BASE_URL}/meal-types`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(typeData)
                });

                if (response.ok) {
                    showMessage('Meal type added successfully!', 'success');
                    document.getElementById('add-meal-type-form').reset();
                    loadMealTypes();
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to add meal type', 'error');
                }
            } catch (error) {
                console.error('Error adding meal type:', error);
                showMessage('Network error', 'error');
            }
        }

        async function deleteMealType(typeId, typeName) {
            if (!confirm(`Delete meal type "${typeName}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/meal-types/${typeId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });

                if (response.ok) {
                    showMessage(`Meal type "${typeName}" deleted`, 'success');
                    loadMealTypes();
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to delete meal type', 'error');
                }
            } catch (error) {
                console.error('Error deleting meal type:', error);
                showMessage('Network error', 'error');
            }
        }

        async function loadMealsData() {
            const container = document.getElementById('meals-table-container');
            container.innerHTML = '<p style="text-align: center; color: var(--text-light);">Loading...</p>';
            
            // Always get fresh token from localStorage
            const token = localStorage.getItem('authToken');
            if (!token) {
                container.innerHTML = '<p style="color: red; text-align: center;">Session expired. Please login again.</p>';
                logout();
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/meals/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const meals = await response.json();
                    
                    if (meals.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No meals recorded yet. Add your first meal!</p>';
                        return;
                    }

                    container.innerHTML = `
                        <div style="margin-bottom: 12px; display: flex; gap: 6px; align-items: center; justify-content: flex-end;">
                            <span id="selected-count" style="font-weight: 500; color: var(--primary-green); font-size: 12px;">0 selected</span>
                            <button onclick="selectAllMeals()" style="padding: 4px 10px; background: #0dcaf0; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 11px;">Select All</button>
                            <button onclick="deselectAllMeals()" style="padding: 4px 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 11px;">Deselect</button>
                            <button onclick="bulkDeleteMeals()" style="padding: 4px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 11px;">Delete</button>
                        </div>
                        <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: var(--bg-light); border-bottom: 2px solid var(--primary-green);">
                                    <th style="padding: 10px; text-align: center; font-weight: 600; width: 40px;">
                                        <input type="checkbox" id="select-all-checkbox" onchange="toggleAllMeals()" style="cursor: pointer; width: 18px; height: 18px;">
                                    </th>
                                    <th style="padding: 10px; text-align: left; font-weight: 600;">Meal Name</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">Type</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">Time</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">Week</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">Day</th>
                                    <th style="padding: 10px; text-align: left; font-weight: 600;">Ingredients</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">Date</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600; width: 140px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${meals.map(meal => `
                                    <tr style="border-bottom: 1px solid var(--border-color);" id="meal-row-${meal.id}">
                                        <td style="padding: 10px; text-align: center;">
                                            <input type="checkbox" class="meal-checkbox" data-meal-id="${meal.id}" onchange="updateSelectedCount()" style="cursor: pointer; width: 18px; height: 18px;">
                                        </td>
                                        <td style="padding: 10px; font-weight: 500;">${meal.name || '-'}</td>
                                        <td style="padding: 10px; text-align: center;">
                                            <span style="padding: 3px 8px; background: #e3f2fd; color: #1976d2; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                                ${meal.meal_type || '-'}
                                            </span>
                                        </td>
                                        <td style="padding: 10px; text-align: center;">${meal.meal_time || '-'}</td>
                                        <td style="padding: 10px; text-align: center;">
                                            <span style="padding: 3px 8px; background: #f3e5f5; color: #7b1fa2; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                                ${(meal.period_type || 'Week 1, Day 1').split(',')[0]}
                                            </span>
                                        </td>
                                        <td style="padding: 10px; text-align: center;">
                                            <span style="padding: 3px 8px; background: #e8f5e9; color: #2e7d32; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                                ${(meal.period_type || 'Week 1, Day 1').split(',')[1]?.trim() || 'Day 1'}
                                            </span>
                                        </td>
                                        <td style="padding: 10px; font-size: 12px; color: #555;">${meal.ingredients || '-'}</td>
                                        <td style="padding: 10px; text-align: center;">${new Date(meal.meal_date).toLocaleDateString()}</td>
                                        <td style="padding: 10px; text-align: center;">
                                            <button onclick="editMeal(${meal.id})" style="padding: 4px 8px; background: #0dcaf0; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 4px;">Edit</button>
                                            <button onclick="deleteMeal(${meal.id}, '${meal.name}')" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="color: red; text-align: center;">Failed to load meals data</p>';
                }
            } catch (error) {
                console.error('Error loading meals:', error);
                container.innerHTML = '<p style="color: red; text-align: center;">Network error loading meals</p>';
            }
        }

        // Checkbox and bulk action functions
        function selectAllMeals() {
            document.querySelectorAll('.meal-checkbox').forEach(cb => cb.checked = true);
            document.getElementById('select-all-checkbox').checked = true;
            updateSelectedCount();
        }

        function deselectAllMeals() {
            document.querySelectorAll('.meal-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('select-all-checkbox').checked = false;
            updateSelectedCount();
        }

        function toggleAllMeals() {
            const selectAll = document.getElementById('select-all-checkbox').checked;
            document.querySelectorAll('.meal-checkbox').forEach(cb => cb.checked = selectAll);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = document.querySelectorAll('.meal-checkbox:checked').length;
            document.getElementById('selected-count').textContent = `${count} selected`;
            
            // Update header checkbox state
            const allCheckboxes = document.querySelectorAll('.meal-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.meal-checkbox:checked');
            const headerCheckbox = document.getElementById('select-all-checkbox');
            
            if (checkedCheckboxes.length === 0) {
                headerCheckbox.checked = false;
                headerCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length === allCheckboxes.length) {
                headerCheckbox.checked = true;
                headerCheckbox.indeterminate = false;
            } else {
                headerCheckbox.checked = false;
                headerCheckbox.indeterminate = true;
            }
        }

        async function bulkDeleteMeals() {
            const selectedCheckboxes = document.querySelectorAll('.meal-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.mealId);
            
            if (selectedIds.length === 0) {
                showMessage('Please select at least one meal to delete', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${selectedIds.length} meal(s)? This action cannot be undone.`)) {
                return;
            }

            let successCount = 0;
            let errorCount = 0;

            for (const id of selectedIds) {
                try {
                    const response = await fetch(`${API_BASE_URL}/meals/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${getAuthToken()}`
                        }
                    });

                    if (response.ok) {
                        successCount++;
                        // Animate row removal
                        const row = document.getElementById(`meal-row-${id}`);
                        if (row) {
                            row.style.transition = 'opacity 0.3s';
                            row.style.opacity = '0';
                            setTimeout(() => row.remove(), 300);
                        }
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    console.error(`Error deleting meal ${id}:`, error);
                    errorCount++;
                }
            }

            if (successCount > 0) {
                showMessage(`Successfully deleted ${successCount} meal(s)`, 'success');
                setTimeout(() => loadMealsData(), 400);
            }
            if (errorCount > 0) {
                showMessage(`Failed to delete ${errorCount} meal(s)`, 'error');
            }
        }

        async function deleteMeal(mealId, mealName) {
            if (!confirm(`Are you sure you want to delete "${mealName}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/meals/${mealId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (response.ok) {
                    showMessage('Meal deleted successfully!', 'success');
                    // Animate row removal
                    const row = document.getElementById(`meal-row-${mealId}`);
                    if (row) {
                        row.style.transition = 'opacity 0.3s';
                        row.style.opacity = '0';
                        setTimeout(() => {
                            row.remove();
                            updateSelectedCount();
                        }, 300);
                    }
                    setTimeout(() => loadMealsData(), 400);
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to delete meal', 'error');
                }
            } catch (error) {
                console.error('Error deleting meal:', error);
                showMessage('Network error', 'error');
            }
        }

        async function editMeal(mealId) {
            try {
                // Fetch the full meal data from API
                const response = await fetch(`${API_BASE_URL}/meals/all`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) {
                    showMessage('Failed to load meal data', 'error');
                    return;
                }
                
                const meals = await response.json();
                const meal = meals.find(m => m.id === mealId);
                
                if (!meal) {
                    showMessage('Meal not found', 'error');
                    return;
                }

                // Populate form with meal data
                document.getElementById('meal-name').value = meal.name || '';
                document.getElementById('meal-type').value = meal.meal_type || 'breakfast';
                document.getElementById('meal-time').value = meal.meal_time || '';
                
                // Extract week and day numbers from "Week X, Day Y" format
                const periodType = meal.period_type || 'Week 1, Day 1';
                const weekMatch = periodType.match(/Week (\d+)/);
                const dayMatch = periodType.match(/Day (\d+)/);
                if (weekMatch) {
                    document.getElementById('week-number').value = weekMatch[1];
                }
                if (dayMatch) {
                    document.getElementById('day-number').value = dayMatch[1];
                } else {
                    document.getElementById('day-number').value = '1';
                }
                
                // Populate ingredients
                populateIngredientsForEdit(meal.ingredients || '');
                
                // Populate method of preparation
                document.getElementById('method-preparation').value = meal.method_preparation || '';
                
                // Set date
                try {
                    const dateObj = new Date(meal.meal_date);
                    document.getElementById('meal-date').valueAsDate = dateObj;
                } catch (e) {
                    document.getElementById('meal-date').valueAsDate = new Date();
                }
            } catch (error) {
                console.error('Error loading meal for edit:', error);
                showMessage('Network error', 'error');
                return;
            }

            // Change the form button to update mode
            const form = document.getElementById('add-meal-form');
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.textContent = '‚úèÔ∏è Update Meal';
            submitButton.style.background = 'linear-gradient(135deg, #ff9800 0%, #fb8c00 100%)';
            
            // Store meal ID for update
            form.dataset.editingMealId = mealId;
            
            // Update form onsubmit to handle both add and update
            form.onsubmit = async (e) => {
                e.preventDefault();
                if (form.dataset.editingMealId) {
                    await updateMeal(form.dataset.editingMealId);
                } else {
                    await addMeal();
                }
            };

            // Add cancel button if not exists
            let cancelBtn = form.querySelector('.cancel-edit-btn');
            if (!cancelBtn) {
                cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.className = 'cancel-edit-btn';
                cancelBtn.textContent = '‚úñ Cancel Edit';
                cancelBtn.style.cssText = 'padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-left: 10px;';
                cancelBtn.onclick = cancelEditMode;
                submitButton.parentElement.insertBefore(cancelBtn, submitButton.nextSibling);
            }

            showMessage('Editing meal - modify fields and click Update', 'success');
        }

        function cancelEditMode() {
            const form = document.getElementById('add-meal-form');
            delete form.dataset.editingMealId;
            
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.textContent = '‚ûï Add Meal';
            submitButton.style.background = 'linear-gradient(135deg, var(--primary-green) 0%, #27ae60 100%)';
            
            const cancelBtn = form.querySelector('.cancel-edit-btn');
            if (cancelBtn) cancelBtn.remove();
            
            form.reset();
            document.getElementById('meal-date').valueAsDate = new Date();
            document.getElementById('week-number').value = '1';
            document.getElementById('day-number').value = '1';
            document.getElementById('method-preparation').value = '';
            clearIngredientsForm();
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                await addMeal();
            };
        }

        async function updateMeal(mealId) {
            const weekNumber = document.getElementById('week-number').value;
            const dayNumber = document.getElementById('day-number').value;
            const ingredients = getIngredients();
            
            if (ingredients.length === 0) {
                showMessage('Please add at least one ingredient', 'error');
                return;
            }
            
            const mealData = {
                name: document.getElementById('meal-name').value,
                meal_type: document.getElementById('meal-type').value,
                meal_time: document.getElementById('meal-time').value || null,
                period_type: `Week ${weekNumber}, Day ${dayNumber}`,
                ingredients: ingredients.join(', '),
                method_preparation: document.getElementById('method-preparation').value || null,
                meal_date: document.getElementById('meal-date').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/meals/${mealId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(mealData)
                });

                if (response.ok) {
                    showMessage('Meal updated successfully!', 'success');
                    cancelEditMode();
                    loadMealsData();
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to update meal', 'error');
                }
            } catch (error) {
                console.error('Error updating meal:', error);
                showMessage('Network error', 'error');
            }
        }

        async function addMeal() {
            const weekNumber = document.getElementById('week-number').value;
            const dayNumber = document.getElementById('day-number').value;
            const ingredients = getIngredients();
            
            if (ingredients.length === 0) {
                showMessage('Please add at least one ingredient', 'error');
                return;
            }
            
            const mealData = {
                name: document.getElementById('meal-name').value,
                meal_type: document.getElementById('meal-type').value,
                meal_time: document.getElementById('meal-time').value || null,
                period_type: `Week ${weekNumber}`,  // Format: "Week 1", "Week 2", etc.
                day_number: parseInt(dayNumber),  // Day 1-7
                ingredients: ingredients.join(', '),
                method_preparation: document.getElementById('method-preparation').value || null,
                meal_notes: document.getElementById('meal-notes').value || null,
                week_notes: document.getElementById('week-notes').value || null,
                meal_date: document.getElementById('meal-date').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/meals`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(mealData)
                });

                if (response.ok) {
                    showMessage('‚úÖ Meal added successfully!', 'success');
                    document.getElementById('add-meal-form').reset();
                    document.getElementById('meal-date').valueAsDate = new Date();
                    document.getElementById('week-number').value = '1';
                    document.getElementById('day-number').value = '1';
                    document.getElementById('method-preparation').value = '';
                    document.getElementById('meal-notes').value = '';
                    document.getElementById('week-notes').value = '';
                    document.getElementById('meal-ingredients').value = '';
                    loadMealsData();
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to add meal', 'error');
                }
            } catch (error) {
                console.error('Error adding meal:', error);
                showMessage('Network error', 'error');
            }
        }

        function downloadMealsTemplate() {
            // Create CSV content with headers and sample data
            const headers = ['name', 'meal_type', 'meal_time', 'period_type', 'day_number', 'ingredients', 'meal_notes', 'week_notes', 'meal_date', 'description', 'method_preparation'];
            const sampleData = [
                ['Lettuce, tomatoes, carrot salad', 'Breakfast', '8 AM- 11 AM', 'Week 1', '1', 'Lettuce, Tomatoes, Carrots, Olive oil', 'One medium size slice of plantain should match with atleast 2 cook spoons of soup', 'Drink atleast 2 liters of water daily. Boiled or steamed preparation methods are preferred. Use olive oil or vegetable oil only.', '2025-11-13', 'Fresh vegetable salad', 'Chop vegetables, mix with olive oil'],
                ['Cabbage with Boiled fish', 'Lunch', '12 PM- 4 PM', 'Week 1', '1', 'Cabbage, Fish, Onions, Tomatoes', '', '', '2025-11-13', 'Protein-rich lunch', 'Boil fish, steam cabbage, mix together'],
                ['Oatmeal with Berries', 'Breakfast', '08:00', 'Week 1', '2', 'Oats, Blueberries, Strawberries, Honey, Milk', '', '', '2025-11-14', 'Nutritious breakfast bowl', 'Cook oats, add berries and honey'],
                ['Grilled Chicken Salad', 'Lunch', '12:00', 'Week 2', '1', 'Chicken breast, Lettuce, Tomatoes, Olive oil, Lemon', '', 'Continue with 2 liters of water daily. Limit salt intake.', '2025-11-20', 'Healthy protein-rich salad', 'Grill chicken, chop vegetables, mix with dressing'],
                ['Salmon with Quinoa', 'Dinner', '19:00', 'Week 2', '3', 'Salmon fillet, Quinoa, Broccoli, Garlic, Olive oil', 'Include healthy fats from fish', '', '2025-11-22', 'Omega-3 rich dinner', 'Bake salmon, cook quinoa, steam broccoli']
            ];

            // Build CSV content
            let csvContent = headers.join(',') + '\n';
            sampleData.forEach(row => {
                // Escape fields that contain commas or quotes
                const escapedRow = row.map(field => {
                    if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                        return `"${field.replace(/"/g, '""')}"`;
                    }
                    return field;
                });
                csvContent += escapedRow.join(',') + '\n';
            });

            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'meals_bulk_import_template.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('‚úÖ Template downloaded successfully! Fill it with your meal data and upload.', 'success');
        }

        async function uploadMealsFile() {
            const fileInput = document.getElementById('meals-file-upload');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('Please select a file first', 'error');
                return;
            }

            showMessage('File upload feature will be implemented with backend support for CSV/Excel parsing', 'error');
            // TODO: Implement file upload endpoint in backend
        }

        // Populate Week Selector dynamically
        function populateWeekSelector() {
            const maxWeeksInput = document.getElementById('max-weeks-input');
            const weekSelector = document.getElementById('week-selector');
            const weekNumberInput = document.getElementById('week-number');
            
            // Load saved preference from localStorage, default to 52
            const savedMaxWeeks = localStorage.getItem('maxWeeks');
            let maxWeeks = savedMaxWeeks ? parseInt(savedMaxWeeks) : 52;
            
            // If input has a value, use that instead
            if (maxWeeksInput.value) {
                maxWeeks = parseInt(maxWeeksInput.value);
            }
            
            // Validate range (minimum 4 weeks, maximum 104 weeks = 2 years)
            if (maxWeeks < 4) maxWeeks = 4;
            if (maxWeeks > 104) maxWeeks = 104;
            
            maxWeeksInput.value = maxWeeks;
            
            // Save to localStorage
            localStorage.setItem('maxWeeks', maxWeeks);
            
            // Update the week-number input max attribute
            if (weekNumberInput) {
                weekNumberInput.setAttribute('max', maxWeeks);
                const currentWeekValue = parseInt(weekNumberInput.value) || 1;
                if (currentWeekValue > maxWeeks) {
                    weekNumberInput.value = maxWeeks;
                }
            }
            
            // Store current selection
            const currentSelection = weekSelector.value || 'Week 1';
            
            // Clear existing options
            weekSelector.innerHTML = '';
            
            // Generate week options
            for (let i = 1; i <= maxWeeks; i++) {
                const option = document.createElement('option');
                option.value = `Week ${i}`;
                option.textContent = `Week ${i}`;
                weekSelector.appendChild(option);
            }
            
            // Restore selection if it still exists in the new range
            if (currentSelection) {
                const weekNum = parseInt(currentSelection.replace('Week ', ''));
                if (weekNum <= maxWeeks) {
                    weekSelector.value = currentSelection;
                } else {
                    weekSelector.value = `Week ${maxWeeks}`;
                }
            }
            
            // Update weekly plan if currently viewing it
            if (document.getElementById('meals-weekly-view').style.display === 'block') {
                loadWeeklyPlan();
            }
        }

        // Sync week selector dropdown with week number input
        function syncWeekNumberWithSelector() {
            const weekSelector = document.getElementById('week-selector');
            const weekNumberInput = document.getElementById('week-number');
            
            if (weekSelector && weekNumberInput) {
                const selectedWeek = weekSelector.value; // "Week 1", "Week 2", etc.
                const weekNum = parseInt(selectedWeek.replace('Week ', ''));
                if (!isNaN(weekNum)) {
                    weekNumberInput.value = weekNum;
                }
            }
        }

        // Sync week number input with week selector dropdown
        function syncWeekSelectorWithNumber() {
            const weekSelector = document.getElementById('week-selector');
            const weekNumberInput = document.getElementById('week-number');
            
            if (weekSelector && weekNumberInput) {
                const weekNum = parseInt(weekNumberInput.value) || 1;
                const weekOption = `Week ${weekNum}`;
                
                // Check if this week exists in the dropdown
                const options = Array.from(weekSelector.options);
                const exists = options.some(opt => opt.value === weekOption);
                
                if (exists) {
                    weekSelector.value = weekOption;
                } else {
                    // If week number exceeds max, set to max
                    const maxWeeks = parseInt(document.getElementById('max-weeks-input').value) || 52;
                    if (weekNum > maxWeeks) {
                        weekNumberInput.value = maxWeeks;
                        weekSelector.value = `Week ${maxWeeks}`;
                    }
                }
            }
        }

        // Global variable to cache ingredients
        let cachedIngredients = null;
        let ingredientAutocompleteTimeout = null;

        // Fetch ingredients from database
        async function fetchIngredientsFromDB() {
            if (cachedIngredients) {
                return cachedIngredients;
            }

            const token = localStorage.getItem('authToken');
            if (!token) return [];

            try {
                const response = await fetch(`${API_BASE_URL}/ingredient-nutrition`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const ingredients = await response.json();
                    cachedIngredients = ingredients.map(ing => ing.ingredient_name);
                    return cachedIngredients;
                }
            } catch (error) {
                console.error('Error fetching ingredients:', error);
            }

            return [];
        }

        // Handle ingredient input with autocomplete
        function handleIngredientInput(event) {
            const textarea = event.target;
            const autocompleteDiv = document.getElementById('ingredients-autocomplete');
            
            // Clear previous timeout
            if (ingredientAutocompleteTimeout) {
                clearTimeout(ingredientAutocompleteTimeout);
            }

            // Get current cursor position and text
            const cursorPos = textarea.selectionStart;
            const textBeforeCursor = textarea.value.substring(0, cursorPos);
            
            // Find the current ingredient being typed (after last comma)
            const lastCommaIndex = textBeforeCursor.lastIndexOf(',');
            const currentIngredient = textBeforeCursor.substring(lastCommaIndex + 1).trim();

            // Only show autocomplete if typing something (at least 2 chars)
            if (currentIngredient.length < 2) {
                autocompleteDiv.style.display = 'none';
                return;
            }

            // Debounce the autocomplete
            ingredientAutocompleteTimeout = setTimeout(async () => {
                const ingredients = await fetchIngredientsFromDB();
                
                // Filter ingredients based on input
                const matches = ingredients.filter(ing => 
                    ing.toLowerCase().includes(currentIngredient.toLowerCase())
                ).slice(0, 10); // Limit to 10 suggestions

                if (matches.length === 0) {
                    autocompleteDiv.style.display = 'none';
                    return;
                }

                // Build autocomplete list
                autocompleteDiv.innerHTML = matches.map(ing => 
                    `<div class="autocomplete-item" 
                        style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;"
                        onmouseover="this.style.background='#f8f9fa'" 
                        onmouseout="this.style.background='white'"
                        onclick="selectIngredient('${ing.replace(/'/g, "\\'")}')">
                        ${ing}
                    </div>`
                ).join('');

                autocompleteDiv.style.display = 'block';
            }, 300);
        }

        // Select ingredient from autocomplete
        function selectIngredient(ingredientName) {
            const textarea = document.getElementById('meal-ingredients');
            const autocompleteDiv = document.getElementById('ingredients-autocomplete');
            
            const cursorPos = textarea.selectionStart;
            const textBeforeCursor = textarea.value.substring(0, cursorPos);
            const textAfterCursor = textarea.value.substring(cursorPos);
            
            // Find the current ingredient being typed
            const lastCommaIndex = textBeforeCursor.lastIndexOf(',');
            const beforeLastComma = textBeforeCursor.substring(0, lastCommaIndex + 1);
            
            // Replace current ingredient with selected one
            const newText = beforeLastComma + (beforeLastComma ? ' ' : '') + ingredientName + textAfterCursor;
            textarea.value = newText;
            
            // Move cursor after the inserted ingredient
            const newCursorPos = (beforeLastComma + (beforeLastComma ? ' ' : '') + ingredientName).length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            
            // Hide autocomplete
            autocompleteDiv.style.display = 'none';
            
            // Focus back on textarea
            textarea.focus();
        }

        // Hide autocomplete when clicking outside
        document.addEventListener('click', function(event) {
            const autocompleteDiv = document.getElementById('ingredients-autocomplete');
            const textarea = document.getElementById('meal-ingredients');
            
            if (autocompleteDiv && textarea && 
                !autocompleteDiv.contains(event.target) && 
                event.target !== textarea) {
                autocompleteDiv.style.display = 'none';
            }
        });

        // Initialize week selector when meals module opens
        function initializeMealsModule() {
            populateWeekSelector();
            
            // Add event listener for week selector change
            const weekSelector = document.getElementById('week-selector');
            if (weekSelector && !weekSelector.hasAttribute('data-listener-added')) {
                weekSelector.addEventListener('change', function() {
                    if (document.getElementById('meals-weekly-view').style.display === 'block') {
                        loadWeeklyPlan();
                    }
                });
                weekSelector.setAttribute('data-listener-added', 'true');
            }
            
            // Prefetch ingredients for autocomplete
            fetchIngredientsFromDB();
            
            // Load meals list
            loadMealsData();
        }

        // View Toggle Functions
        function showMealsListView() {
            document.getElementById('meals-list-view').style.display = 'flex';
            document.getElementById('meals-weekly-view').style.display = 'none';
            document.getElementById('list-view-btn').style.background = 'linear-gradient(135deg, var(--primary-green) 0%, #27ae60 100%)';
            document.getElementById('list-view-btn').style.color = 'white';
            document.getElementById('list-view-btn').style.border = 'none';
            document.getElementById('weekly-view-btn').style.background = 'white';
            document.getElementById('weekly-view-btn').style.color = 'var(--primary-green)';
            document.getElementById('weekly-view-btn').style.border = '2px solid var(--primary-green)';
        }

        function showWeeklyPlanView() {
            document.getElementById('meals-list-view').style.display = 'none';
            document.getElementById('meals-weekly-view').style.display = 'block';
            document.getElementById('weekly-view-btn').style.background = 'linear-gradient(135deg, var(--primary-green) 0%, #27ae60 100())';
            document.getElementById('weekly-view-btn').style.color = 'white';
            document.getElementById('weekly-view-btn').style.border = 'none';
            document.getElementById('list-view-btn').style.background = 'white';
            document.getElementById('list-view-btn').style.color = 'var(--primary-green)';
            document.getElementById('list-view-btn').style.border = '2px solid var(--primary-green)';
            
            // Load weekly plan data
            loadWeeklyPlan();
        }

        async function loadWeeklyPlan() {
            const weekSelector = document.getElementById('week-selector');
            const selectedWeek = weekSelector.value;
            const container = document.getElementById('weekly-plan-container');
            const notesContainer = document.getElementById('weekly-notes-content');
            
            container.innerHTML = '<p style="text-align: center; padding: 40px;">Loading weekly meal plan...</p>';
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                container.innerHTML = '<p style="color: red; text-align: center;">Session expired. Please login again.</p>';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/meals/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const allMeals = await response.json();
                    const weekMeals = allMeals.filter(m => m.period_type === selectedWeek);
                    
                    if (weekMeals.length === 0) {
                        container.innerHTML = `<p style="text-align: center; padding: 40px; color: var(--text-light);">No meals found for ${selectedWeek}. Add meals using the form in List View.</p>`;
                        notesContainer.textContent = 'No weekly notes available.';
                        return;
                    }

                    // Group meals by day
                    const mealsByDay = {};
                    let weeklyNotes = '';
                    
                    for (let day = 1; day <= 7; day++) {
                        mealsByDay[day] = {
                            breakfast: weekMeals.find(m => m.day_number === day && m.meal_type?.toLowerCase() === 'breakfast'),
                            lunch: weekMeals.find(m => m.day_number === day && m.meal_type?.toLowerCase() === 'lunch'),
                            dinner: weekMeals.find(m => m.day_number === day && (m.meal_type?.toLowerCase() === 'dinner' || m.meal_type?.toLowerCase() === 'supper')),
                            snack: weekMeals.find(m => m.day_number === day && m.meal_type?.toLowerCase() === 'snack'),
                            special: weekMeals.find(m => m.day_number === day && m.meal_type?.toLowerCase() === 'special')
                        };
                    }

                    // Get weekly notes from first meal that has them
                    const mealWithNotes = weekMeals.find(m => m.week_notes);
                    if (mealWithNotes) {
                        weeklyNotes = mealWithNotes.week_notes;
                    }

                    notesContainer.textContent = weeklyNotes || 'No weekly notes available for this week.';

                    // Build weekly table
                    let tableHTML = `
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 20px;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, var(--primary-green) 0%, #27ae60 100%); color: white;">
                                    <th style="padding: 15px; text-align: left; border: 1px solid #ddd; font-weight: 600; width: 80px;">Day</th>
                                    <th style="padding: 15px; text-align: left; border: 1px solid #ddd; font-weight: 600;">Breakfast<br><span style="font-weight: 400; font-size: 11px;">Time</span></th>
                                    <th style="padding: 15px; text-align: left; border: 1px solid #ddd; font-weight: 600;">Lunch<br><span style="font-weight: 400; font-size: 11px;">Time</span></th>
                                    <th style="padding: 15px; text-align: left; border: 1px solid #ddd; font-weight: 600;">Dinner/Supper<br><span style="font-weight: 400; font-size: 11px;">Time</span></th>
                                    <th style="padding: 15px; text-align: left; border: 1px solid #ddd; font-weight: 600;">Snack</th>
                                    <th style="padding: 15px; text-align: left; border: 1px solid #ddd; font-weight: 600;">Special</th>
                                    <th style="padding: 15px; text-align: left; border: 1px solid #ddd; font-weight: 600;">Meal Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    for (let day = 1; day <= 7; day++) {
                        const dayMeals = mealsByDay[day];
                        const rowBg = day % 2 === 0 ? '#f8f9fa' : 'white';
                        
                        tableHTML += `
                            <tr style="background: ${rowBg};">
                                <td style="padding: 12px; border: 1px solid #ddd; font-weight: 600; color: var(--primary-green);">Day ${day}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; vertical-align: top;">
                                    ${dayMeals.breakfast ? `
                                        <div style="margin-bottom: 5px;"><strong>${dayMeals.breakfast.name}</strong></div>
                                        ${dayMeals.breakfast.meal_time ? `<div style="color: #666; font-size: 11px; margin-bottom: 3px;">‚è∞ ${dayMeals.breakfast.meal_time}</div>` : ''}
                                        ${dayMeals.breakfast.ingredients ? `<div style="color: #666; font-size: 11px; margin-top: 5px;">${dayMeals.breakfast.ingredients}</div>` : ''}
                                    ` : '<span style="color: #999;">‚Äî</span>'}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; vertical-align: top;">
                                    ${dayMeals.lunch ? `
                                        <div style="margin-bottom: 5px;"><strong>${dayMeals.lunch.name}</strong></div>
                                        ${dayMeals.lunch.meal_time ? `<div style="color: #666; font-size: 11px; margin-bottom: 3px;">‚è∞ ${dayMeals.lunch.meal_time}</div>` : ''}
                                        ${dayMeals.lunch.ingredients ? `<div style="color: #666; font-size: 11px; margin-top: 5px;">${dayMeals.lunch.ingredients}</div>` : ''}
                                    ` : '<span style="color: #999;">‚Äî</span>'}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; vertical-align: top;">
                                    ${dayMeals.dinner ? `
                                        <div style="margin-bottom: 5px;"><strong>${dayMeals.dinner.name}</strong></div>
                                        ${dayMeals.dinner.meal_time ? `<div style="color: #666; font-size: 11px; margin-bottom: 3px;">‚è∞ ${dayMeals.dinner.meal_time}</div>` : ''}
                                        ${dayMeals.dinner.ingredients ? `<div style="color: #666; font-size: 11px; margin-top: 5px;">${dayMeals.dinner.ingredients}</div>` : ''}
                                    ` : '<span style="color: #999;">‚Äî</span>'}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; vertical-align: top;">
                                    ${dayMeals.snack ? `
                                        <div style="margin-bottom: 5px;"><strong>${dayMeals.snack.name}</strong></div>
                                        ${dayMeals.snack.ingredients ? `<div style="color: #666; font-size: 11px;">${dayMeals.snack.ingredients}</div>` : ''}
                                    ` : '<span style="color: #999;">‚Äî</span>'}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; vertical-align: top;">
                                    ${dayMeals.special ? `
                                        <div style="margin-bottom: 5px;"><strong>${dayMeals.special.name}</strong></div>
                                        ${dayMeals.special.ingredients ? `<div style="color: #666; font-size: 11px;">${dayMeals.special.ingredients}</div>` : ''}
                                    ` : '<span style="color: #999;">‚Äî</span>'}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; vertical-align: top; max-width: 200px;">
                                    ${(dayMeals.breakfast?.meal_notes || dayMeals.lunch?.meal_notes || dayMeals.dinner?.meal_notes || '‚Äî')}
                                </td>
                            </tr>
                        `;
                    }

                    tableHTML += `
                            </tbody>
                        </table>
                    `;

                    container.innerHTML = tableHTML;

                } else {
                    container.innerHTML = '<p style="color: red; text-align: center;">Failed to load meals data</p>';
                }
            } catch (error) {
                console.error('Error loading weekly plan:', error);
                container.innerHTML = '<p style="color: red; text-align: center;">Error loading weekly meal plan</p>';
            }
        }

        // Update weekly plan when week selector changes
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'week-selector') {
                loadWeeklyPlan();
            }
        });

        // Analytics Module
        async function openAnalyticsModule() {
            try {
                console.log('Analytics module clicked!');
                
                // Get auth token
                const token = getAuthToken();
                if (!token) {
                    showMessage('Please login to access analytics', 'error');
                    return;
                }

                console.log('Token retrieved, loading analytics dashboard');
                
                const analyticsHTML = `
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); min-height: 100%; padding: 0;">
                        <!-- Dashboard Header -->
                        <div style="background: white; padding: 25px; margin-bottom: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="color: var(--primary-blue); margin: 0;">Analytics Dashboard</h3>
                                <div style="display: flex; gap: 10px;">
                                    <select id="analytics-timeframe" onchange="refreshAnalytics()" style="padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 6px;">
                                        <option value="7">Last 7 Days</option>
                                        <option value="30" selected>Last 30 Days</option>
                                        <option value="90">Last 90 Days</option>
                                    </select>
                                    <button onclick="refreshAnalytics()" style="padding: 8px 16px; background: var(--light-green); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        Refresh
                                    </button>
                                </div>
                            </div>
                            <div id="analytics-overview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                <!-- Metric Cards -->
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white;">
                                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Users</div>
                                    <div style="font-size: 32px; font-weight: bold;" id="totalUsers">0</div>
                                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;" id="newUsers">+0 new</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: white;">
                                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Appointments</div>
                                    <div style="font-size: 32px; font-weight: bold;" id="totalAppointments">0</div>
                                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;" id="recentAppointments">+0 recent</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 10px; color: white;">
                                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Messages</div>
                                    <div style="font-size: 32px; font-weight: bold;" id="totalMessages">0</div>
                                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;" id="recentMessages">+0 recent</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 10px; color: white;">
                                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Meals</div>
                                    <div style="font-size: 32px; font-weight: bold;" id="totalMeals">0</div>
                                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;" id="recentMeals">+0 recent</div>
                                </div>
                            </div>
                        </div>

                        <!-- Analytics Sections -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                            <!-- User Analytics -->
                            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                                <h4 style="color: var(--primary-green); margin-bottom: 20px;">User Analytics</h4>
                                <div style="margin-bottom: 20px;">
                                    <h5 style="color: #666; font-size: 14px; margin-bottom: 10px;">User Roles</h5>
                                    <div id="userRolesData">Loading user data...</div>
                                </div>
                                <div id="userGrowthChart" style="margin-top: 20px;"></div>
                            </div>

                            <!-- Appointment Analytics -->
                            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                                <h4 style="color: var(--primary-green); margin-bottom: 20px;">Appointment Trends</h4>
                                <div style="margin-bottom: 20px;">
                                    <h5 style="color: #666; font-size: 14px; margin-bottom: 10px;">Status Distribution</h5>
                                    <div id="appointmentStatusData">Loading appointment data...</div>
                                </div>
                                <div id="appointmentTrendsChart" style="margin-top: 20px;"></div>
                                <div style="margin-top: 20px;">
                                    <h5 style="color: #666; font-size: 14px; margin-bottom: 10px;">Top Therapists</h5>
                                    <div id="topTherapists"></div>
                                </div>
                            </div>
                        </div>

                        <!-- System Metrics -->
                        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 25px;">
                            <h4 style="color: var(--primary-green); margin-bottom: 20px;">Meal Statistics</h4>
                            <div id="mealStats">Loading meal statistics...</div>
                        </div>

                        <!-- Recent Activity -->
                        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                            <h4 style="color: var(--primary-green); margin-bottom: 20px;">Recent Activity</h4>
                            <div id="recentActivity">Loading recent activities...</div>
                        </div>
                    </div>
                `;

                showLargeModal('Analytics Dashboard', analyticsHTML);
                loadAnalyticsData();
            } catch (error) {
                console.error('Error opening analytics module:', error);
                showMessage('Error opening analytics module', 'error');
            }
        }

        // Analytics Data Loading Function
        async function loadAnalyticsData() {
            const token = getAuthToken();
            const timeframe = document.getElementById('analytics-timeframe')?.value || 30;

            try {
                // Load dashboard overview
                const dashboardResponse = await fetch(`${API_BASE_URL}/analytics/dashboard?days=${timeframe}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (dashboardResponse.ok) {
                    const dashboardData = await dashboardResponse.json();
                    updateAnalyticsOverview(dashboardData);
                } else {
                    console.error('Failed to load dashboard data');
                }

                // Load user analytics
                const userResponse = await fetch(`${API_BASE_URL}/analytics/users?days=${timeframe}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    updateUserAnalytics(userData);
                } else {
                    console.error('Failed to load user analytics');
                }

                // Load appointment analytics
                const appointmentResponse = await fetch(`${API_BASE_URL}/analytics/appointments?days=${timeframe}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (appointmentResponse.ok) {
                    const appointmentData = await appointmentResponse.json();
                    updateAppointmentAnalytics(appointmentData);
                } else {
                    console.error('Failed to load appointment analytics');
                }

                // Load system metrics
                const metricsResponse = await fetch(`${API_BASE_URL}/analytics/system-metrics?days=${timeframe}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (metricsResponse.ok) {
                    const metricsData = await metricsResponse.json();
                    updateSystemMetrics(metricsData);
                } else {
                    console.error('Failed to load system metrics');
                }

                // Load recent activities
                const activitiesResponse = await fetch(`${API_BASE_URL}/analytics/activities?limit=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (activitiesResponse.ok) {
                    const activitiesData = await activitiesResponse.json();
                    updateRecentActivities(activitiesData);
                } else {
                    console.error('Failed to load activities');
                }

            } catch (error) {
                console.error('Error loading analytics data:', error);
                showMessage('Error loading analytics data', 'error');
            }
        }

        // Analytics Helper Functions
        function updateAnalyticsOverview(data) {
            const container = document.getElementById('analytics-overview');
            if (!container) return;

            container.innerHTML = `
                <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${data.total_users || 0}</div>
                    <div style="color: #666; margin-top: 5px;">Total Users</div>
                </div>
                <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">${data.total_appointments || 0}</div>
                    <div style="color: #666; margin-top: 5px;">Total Appointments</div>
                </div>
                <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #388e3c;">${data.active_users || 0}</div>
                    <div style="color: #666; margin-top: 5px;">Active Users</div>
                </div>
                <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fff3e0 0%, #ffcc02 100%); border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #f57c00;">${data.completion_rate || 0}%</div>
                    <div style="color: #666; margin-top: 5px;">Completion Rate</div>
                </div>
            `;
        }

        function updateUserAnalytics(data) {
            const container = document.getElementById('user-analytics');
            if (!container) return;

            const registrations = data.user_registrations || [];
            const roles = data.user_roles || [];

            let registrationHtml = '<h5>Recent Registrations</h5>';
            if (registrations.length > 0) {
                registrationHtml += registrations.map(reg => `
                    <div style="padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px;">
                        <strong>${reg.name}</strong> (${reg.role})<br>
                        <small style="color: #666;">Registered: ${new Date(reg.created_at).toLocaleDateString()}</small>
                    </div>
                `).join('');
            } else {
                registrationHtml += '<p style="color: #666;">No recent registrations</p>';
            }

            let rolesHtml = '<h5 style="margin-top: 20px;">User Distribution</h5>';
            if (roles.length > 0) {
                rolesHtml += roles.map(role => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                        <span style="text-transform: capitalize;">${role.role}</span>
                        <strong>${role.count}</strong>
                    </div>
                `).join('');
            } else {
                rolesHtml += '<p style="color: #666;">No user data available</p>';
            }

            container.innerHTML = registrationHtml + rolesHtml;
        }

        function updateAppointmentAnalytics(data) {
            const container = document.getElementById('appointment-analytics');
            if (!container) return;

            const trends = data.appointment_trends || [];
            const statuses = data.appointment_statuses || [];

            let trendsHtml = '<h5>Appointment Trends</h5>';
            if (trends.length > 0) {
                trendsHtml += trends.map(trend => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                        <span>${new Date(trend.date).toLocaleDateString()}</span>
                        <strong>${trend.count} appointments</strong>
                    </div>
                `).join('');
            } else {
                trendsHtml += '<p style="color: #666;">No appointment data available</p>';
            }

            let statusHtml = '<h5 style="margin-top: 20px;">Status Distribution</h5>';
            if (statuses.length > 0) {
                statusHtml += statuses.map(status => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                        <span style="text-transform: capitalize;">${status.status}</span>
                        <strong>${status.count}</strong>
                    </div>
                `).join('');
            } else {
                statusHtml += '<p style="color: #666;">No status data available</p>';
            }

            container.innerHTML = trendsHtml + statusHtml;
        }

        function updateSystemMetrics(data) {
            const container = document.getElementById('system-metrics');
            if (!container) return;

            const metrics = data.metrics || [];

            if (metrics.length > 0) {
                const metricsHtml = metrics.map(metric => `
                    <div style="padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${metric.metric_name}</strong>
                            <span style="color: var(--primary-green); font-weight: bold;">${metric.metric_value}</span>
                        </div>
                        <small style="color: #666;">Recorded: ${new Date(metric.timestamp).toLocaleString()}</small>
                    </div>
                `).join('');
                container.innerHTML = metricsHtml;
            } else {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No system metrics available</p>';
            }
        }

        function updateRecentActivities(data) {
            const container = document.getElementById('recent-activities');
            if (!container) return;

            const activities = data.activities || [];

            if (activities.length > 0) {
                const activitiesHtml = activities.map(activity => `
                    <div style="padding: 12px; border-left: 4px solid var(--primary-green); background: #f8f9fa; margin-bottom: 10px; border-radius: 0 6px 6px 0;">
                        <strong>${activity.activity_type}</strong><br>
                        <span style="color: #666;">${activity.description || 'No description'}</span><br>
                        <small style="color: #888;">User: ${activity.user_name || 'Unknown'} - ${new Date(activity.timestamp).toLocaleString()}</small>
                    </div>
                `).join('');
                container.innerHTML = activitiesHtml;
            } else {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No recent activities</p>';
            }
        }

        function refreshAnalytics() {
            loadAnalyticsData();
        }

        // Appointments Module
        async function openAppointmentsModule() {
            try {
                console.log('Opening Appointments module...');
                
                // Get auth token
                const token = getAuthToken();
                if (!token) {
                    showMessage('Please login to access appointments', 'error');
                    return;
                }

                const appointmentsHTML = `
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); min-height: 100%; padding: 0;">
                        <!-- Compact Header -->
                        <div style="background: white; padding: 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #3b82f6; margin: 0; font-size: 20px;">üìÖ Appointments</h3>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="showBookingModal()" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">+ New</button>
                                    <button onclick="refreshAppointments()" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">‚Üª</button>
                                </div>
                            </div>
                            
                            <!-- Compact View Toggle -->
                            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                                <button id="btn-list-view" onclick="switchAppointmentView('list')" style="padding: 6px 12px; border: 1px solid #3b82f6; background: #3b82f6; color: white; border-radius: 4px; cursor: pointer; font-size: 13px;">List</button>
                                <button id="btn-calendar-view" onclick="switchAppointmentView('calendar')" style="padding: 6px 12px; border: 1px solid #3b82f6; background: white; color: #3b82f6; border-radius: 4px; cursor: pointer; font-size: 13px;">Calendar</button>
                            </div>
                            
                            <!-- Filter Buttons -->
                            <div style="width: 45%; margin-bottom: 15px;" id="appointment-filters">
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    <button onclick="filterModalAppointments('all')" class="filter-btn active" data-filter="all" style="padding: 4px 8px; border: 1px solid #3b82f6; border-radius: 8px; background: #3b82f6; color: white; cursor: pointer; font-size: 11px; flex: 1; min-width: 40px;">All</button>
                                    <button onclick="filterModalAppointments('scheduled')" class="filter-btn" data-filter="scheduled" style="padding: 4px 8px; border: 1px solid #3b82f6; border-radius: 8px; background: white; color: #3b82f6; cursor: pointer; font-size: 11px; flex: 1; min-width: 50px;">Pending</button>
                                    <button onclick="filterModalAppointments('confirmed')" class="filter-btn" data-filter="confirmed" style="padding: 4px 8px; border: 1px solid #10b981; border-radius: 8px; background: white; color: #10b981; cursor: pointer; font-size: 11px; flex: 1; min-width: 60px;">Confirmed</button>
                                    <button onclick="filterModalAppointments('completed')" class="filter-btn" data-filter="completed" style="padding: 4px 8px; border: 1px solid #6b7280; border-radius: 8px; background: white; color: #6b7280; cursor: pointer; font-size: 11px; flex: 1; min-width: 40px;">Done</button>
                                    <button onclick="filterModalAppointments('cancelled')" class="filter-btn" data-filter="cancelled" style="padding: 4px 8px; border: 1px solid #ef4444; border-radius: 8px; background: white; color: #ef4444; cursor: pointer; font-size: 11px; flex: 1; min-width: 60px;">Cancelled</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Main Content Layout -->
                        <div style="display: grid; grid-template-columns: 1fr 350px; gap: 20px; height: 600px;">
                            <!-- Left Panel - Appointments List/Calendar -->
                            <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                                <div id="appointments-modal-content" style="padding: 20px; height: 100%; overflow-y: auto;">
                                    <div style="text-align: center; padding: 40px; color: #666;">Loading...</div>
                                </div>
                            </div>
                            
                            <!-- Right Panel - Monthly Calendar -->
                            <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4 style="margin: 0; color: #374151; font-size: 16px;" id="calendar-month-year"></h4>
                                    <div style="display: flex; gap: 5px;">
                                        <button onclick="changeCalendarMonth(-1)" style="padding: 4px 8px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer; font-size: 12px;">‚Äπ</button>
                                        <button onclick="changeCalendarMonth(1)" style="padding: 4px 8px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer; font-size: 12px;">‚Ä∫</button>
                                    </div>
                                </div>
                                <div id="mini-calendar"></div>
                                
                                <!-- Today's Appointments -->
                                <div style="margin-top: 20px; border-top: 1px solid #e5e7eb; padding-top: 15px;">
                                    <h5 style="margin: 0 0 10px 0; color: #374151; font-size: 14px;">Today's Schedule</h5>
                                    <div id="today-appointments" style="font-size: 13px; color: #6b7280;">
                                        <div style="padding: 8px 0; color: #9ca3af;">No appointments today</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                showLargeModal('üìÖ Appointments Management', appointmentsHTML);
                
                // Load appointments data
                await loadModalAppointments();

            } catch (error) {
                console.error('Error loading appointments module:', error);
                showMessage('Error loading appointments module', 'error');
            }
        }

        // Supporting functions for appointments modal
        async function loadModalAppointments() {
            const contentDiv = document.getElementById('appointments-modal-content');
            if (!contentDiv) return;
            
            contentDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading appointments...</div>';

            try {
                const token = getAuthToken();
                const endpoint = currentUser.role === 'admin' ? 'appointments' : 'appointments/my';
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const appointments = await response.json();
                    window.modalAppointments = appointments; // Store for filtering
                    displayModalAppointments(appointments);
                    // Initialize calendar components
                    setTimeout(() => {
                        generateMiniCalendar();
                        showTodayAppointments();
                    }, 100);
                } else {
                    contentDiv.innerHTML = '<p style="color: red; text-align: center; padding: 20px;">Failed to load appointments</p>';
                }
            } catch (error) {
                contentDiv.innerHTML = '<p style="color: red; text-align: center; padding: 20px;">Network error loading appointments</p>';
                console.error('Error loading appointments:', error);
            }
        }

        function displayModalAppointments(appointments) {
            const contentDiv = document.getElementById('appointments-modal-content');
            if (!contentDiv) return;
            
            if (!appointments || appointments.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìÖ</div>
                        <h3>No appointments yet</h3>
                        <p>Click "Book New" to schedule your first appointment</p>
                    </div>
                `;
                return;
            }

            const appointmentsHTML = appointments.map(apt => {
                const appointmentDate = new Date(apt.appointment_datetime);
                const isUpcoming = appointmentDate > new Date();
                const statusColors = {
                    'scheduled': '#3b82f6',
                    'confirmed': '#10b981', 
                    'completed': '#6b7280',
                    'cancelled': '#ef4444',
                    'no_show': '#f59e0b'
                };
                
                const typeIcons = {
                    'consultation': 'üí¨',
                    'therapy': 'üß†',
                    'follow-up': 'üìã',
                    'assessment': 'üìä',
                    'group': 'üë•'
                };
                
                return `
                    <div class="appointment-card" data-status="${apt.status}" data-type="${apt.appointment_type}" style="
                        background: #ffffff; 
                        border: 1px solid #e5e7eb; 
                        border-radius: 8px; 
                        padding: 15px; 
                        margin-bottom: 12px;
                        border-left: 4px solid ${statusColors[apt.status] || '#6b7280'};
                        transition: all 0.2s ease;
                    " onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">${typeIcons[apt.appointment_type] || 'üìÖ'}</span>
                                    <span style="font-weight: 600; color: #1f2937; font-size: 15px;">${apt.appointment_type || 'Appointment'}</span>
                                    <span style="background: ${statusColors[apt.status] || '#6b7280'}; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 500; text-transform: uppercase;">
                                        ${apt.status}
                                    </span>
                                    ${apt.sync_with_calendar ? '<span style="color: #10b981; font-size: 12px;" title="Synced with Google Calendar">üìÖ</span>' : ''}
                                </div>
                                <div style="display: flex; gap: 15px; font-size: 13px; color: #6b7280; margin-bottom: 6px;">
                                    <span>üìÖ ${appointmentDate.toLocaleDateString()}</span>
                                    <span>üïê ${appointmentDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                    <span>‚è±Ô∏è ${apt.duration_minutes || 60}min</span>
                                </div>
                                ${apt.location ? `<div style="font-size: 13px; color: #6b7280; margin-bottom: 6px;">üìç ${apt.location}</div>` : ''}
                                ${apt.notes ? `<div style="font-size: 12px; color: #374151; background: #f9fafb; padding: 6px; border-radius: 4px; margin-top: 6px;">üí≠ ${apt.notes}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 6px; margin-left: 15px;">
                                ${apt.status === 'scheduled' ? `
                                    <button onclick="confirmModalAppointment(${apt.id})" title="Confirm Appointment" style="padding: 4px 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">Confirm</button>
                                ` : ''}
                                ${['scheduled', 'confirmed'].includes(apt.status) ? `
                                    <button onclick="editModalAppointment(${apt.id})" title="Edit Appointment" style="padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">Edit</button>
                                    <button onclick="cancelModalAppointment(${apt.id})" title="Cancel Appointment" style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">Cancel</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            contentDiv.innerHTML = appointmentsHTML;
        }

        function filterModalAppointments(status) {
            // Reset all buttons to their default colors
            document.querySelectorAll('#appointment-filters .filter-btn').forEach(btn => {
                const filter = btn.getAttribute('data-filter');
                btn.style.background = 'white';
                if (filter === 'all') btn.style.color = '#3b82f6';
                else if (filter === 'scheduled') btn.style.color = '#3b82f6';
                else if (filter === 'confirmed') btn.style.color = '#10b981';
                else if (filter === 'completed') btn.style.color = '#6b7280';
                else if (filter === 'cancelled') btn.style.color = '#ef4444';
            });
            
            // Activate selected button
            const selectedBtn = document.querySelector(`[data-filter="${status}"]`);
            if (selectedBtn) {
                const btnColor = status === 'all' ? '#3b82f6' : 
                               status === 'scheduled' ? '#3b82f6' :
                               status === 'confirmed' ? '#10b981' :
                               status === 'completed' ? '#6b7280' :
                               status === 'cancelled' ? '#ef4444' : '#3b82f6';
                selectedBtn.style.background = btnColor;
                selectedBtn.style.color = 'white';
            }

            if (!window.modalAppointments) return;

            let filtered = window.modalAppointments;
            if (status !== 'all') {
                filtered = window.modalAppointments.filter(apt => apt.status === status);
            }
            
            displayModalAppointments(filtered);
        }

        function searchModalAppointments() {
            const searchTerm = document.getElementById('appointment-search').value.toLowerCase();
            if (!window.modalAppointments) return;

            const filtered = window.modalAppointments.filter(apt => {
                return apt.appointment_type.toLowerCase().includes(searchTerm) ||
                       apt.status.toLowerCase().includes(searchTerm) ||
                       (apt.location && apt.location.toLowerCase().includes(searchTerm)) ||
                       (apt.notes && apt.notes.toLowerCase().includes(searchTerm));
            });
            
            displayModalAppointments(filtered);
        }

        function switchAppointmentView(view) {
            // Update button styles
            document.querySelectorAll('#btn-list-view, #btn-calendar-view').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#3b82f6';
            });
            
            if (view === 'list') {
                document.getElementById('btn-list-view').style.background = '#3b82f6';
                document.getElementById('btn-list-view').style.color = 'white';
                loadModalAppointments();
            } else {
                document.getElementById('btn-calendar-view').style.background = '#3b82f6';
                document.getElementById('btn-calendar-view').style.color = 'white';
                showCalendarView();
            }
        }

        let currentCalendarDate = new Date();

        function showCalendarView() {
            const appointments = window.modalAppointments || [];
            const today = new Date();
            const currentMonth = currentCalendarDate.getMonth();
            const currentYear = currentCalendarDate.getFullYear();
            
            // Create calendar grid
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay()); // Start from Sunday
            
            let calendarHTML = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e5e7eb; border-radius: 8px; overflow: hidden; margin-bottom: 15px;">';
            
            // Days of week header
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                calendarHTML += `<div style="background: #f3f4f6; padding: 8px 4px; text-align: center; font-weight: 600; font-size: 12px; color: #374151;">${day}</div>`;
            });
            
            // Calendar days
            for (let i = 0; i < 42; i++) { // 6 weeks
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const isCurrentMonth = date.getMonth() === currentMonth;
                const isToday = date.toDateString() === today.toDateString();
                const dayAppointments = appointments.filter(apt => {
                    const aptDate = new Date(apt.appointment_datetime);
                    return aptDate.toDateString() === date.toDateString();
                });
                
                let dayStyle = 'background: white; padding: 8px 4px; text-align: center; min-height: 40px; position: relative; cursor: pointer;';
                if (!isCurrentMonth) dayStyle += 'color: #d1d5db;';
                if (isToday) dayStyle += 'background: #dbeafe; border: 2px solid #3b82f6;';
                
                let dayContent = `<div style="font-size: 12px; font-weight: ${isToday ? '600' : '500'};">${date.getDate()}</div>`;
                
                if (dayAppointments.length > 0) {
                    dayContent += `<div style="position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); background: #3b82f6; color: white; border-radius: 8px; font-size: 8px; padding: 1px 4px;">${dayAppointments.length}</div>`;
                }
                
                calendarHTML += `<div style="${dayStyle}" onclick="showDayAppointments('${date.toISOString()}')">${dayContent}</div>`;
            }
            
            calendarHTML += '</div>';
            
            document.getElementById('appointments-modal-content').innerHTML = `
                <div style="padding: 0;">
                    <h4 style="color: #374151; margin-bottom: 20px; text-align: center;">üìÖ Calendar View - ${firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h4>
                    ${calendarHTML}
                    <div id="selected-day-appointments" style="margin-top: 20px;">
                        <h5 style="color: #374151; margin-bottom: 10px;">Select a date to view appointments</h5>
                    </div>
                </div>
            `;
            
            // Initialize mini calendar and today's appointments
            generateMiniCalendar();
            showTodayAppointments();
        }

        function generateMiniCalendar() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            document.getElementById('calendar-month-year').textContent = 
                today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            let miniCalHTML = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; font-size: 11px;">';
            
            // Day headers
            const dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            dayHeaders.forEach(day => {
                miniCalHTML += `<div style="text-align: center; padding: 4px; font-weight: 600; color: #6b7280;">${day}</div>`;
            });
            
            // Calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const isCurrentMonth = date.getMonth() === currentMonth;
                const isToday = date.toDateString() === today.toDateString();
                
                let dayStyle = 'text-align: center; padding: 4px; cursor: pointer; border-radius: 2px;';
                if (!isCurrentMonth) dayStyle += 'color: #d1d5db;';
                if (isToday) dayStyle += 'background: #3b82f6; color: white; font-weight: 600;';
                else dayStyle += 'color: #374151;';
                
                miniCalHTML += `<div style="${dayStyle}">${date.getDate()}</div>`;
            }
            
            miniCalHTML += '</div>';
            document.getElementById('mini-calendar').innerHTML = miniCalHTML;
        }

        function changeCalendarMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            if (document.getElementById('btn-calendar-view').style.background === 'rgb(59, 130, 246)') {
                showCalendarView();
            }
            generateMiniCalendar();
        }

        function showDayAppointments(dateStr) {
            const date = new Date(dateStr);
            const appointments = window.modalAppointments || [];
            const dayAppointments = appointments.filter(apt => {
                const aptDate = new Date(apt.appointment_datetime);
                return aptDate.toDateString() === date.toDateString();
            });
            
            const selectedDiv = document.getElementById('selected-day-appointments');
            if (dayAppointments.length === 0) {
                selectedDiv.innerHTML = `
                    <h5 style="color: #374151; margin-bottom: 10px;">üìÖ ${date.toLocaleDateString()}</h5>
                    <p style="color: #6b7280; font-size: 14px;">No appointments scheduled</p>
                `;
                return;
            }
            
            const appointmentsHTML = dayAppointments.map(apt => {
                const time = new Date(apt.appointment_datetime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const statusColors = {
                    'scheduled': '#3b82f6',
                    'confirmed': '#10b981',
                    'completed': '#6b7280',
                    'cancelled': '#ef4444'
                };
                
                return `
                    <div style="background: #f9fafb; border-left: 3px solid ${statusColors[apt.status]}; padding: 10px; margin-bottom: 8px; border-radius: 4px;">
                        <div style="font-weight: 600; font-size: 14px; color: #1f2937;">${time} - ${apt.appointment_type}</div>
                        <div style="font-size: 12px; color: #6b7280;">Duration: ${apt.duration_minutes}min</div>
                        ${apt.location ? `<div style="font-size: 12px; color: #6b7280;">üìç ${apt.location}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            selectedDiv.innerHTML = `
                <h5 style="color: #374151; margin-bottom: 10px;">üìÖ ${date.toLocaleDateString()}</h5>
                ${appointmentsHTML}
            `;
        }

        function showTodayAppointments() {
            const today = new Date();
            const appointments = window.modalAppointments || [];
            const todayAppointments = appointments.filter(apt => {
                const aptDate = new Date(apt.appointment_datetime);
                return aptDate.toDateString() === today.toDateString();
            });
            
            const todayDiv = document.getElementById('today-appointments');
            if (todayAppointments.length === 0) {
                todayDiv.innerHTML = '<div style="padding: 8px 0; color: #9ca3af;">No appointments today</div>';
                return;
            }
            
            const appointmentsHTML = todayAppointments.map(apt => {
                const time = new Date(apt.appointment_datetime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                return `
                    <div style="padding: 6px 0; border-bottom: 1px solid #f3f4f6;">
                        <div style="font-weight: 500; font-size: 13px; color: #1f2937;">${time} ${apt.appointment_type}</div>
                        <div style="font-size: 11px; color: #6b7280;">${apt.duration_minutes}min</div>
                    </div>
                `;
            }).join('');
            
            todayDiv.innerHTML = appointmentsHTML;
        }

        function refreshAppointments() {
            loadModalAppointments();
        }

        async function confirmModalAppointment(id) {
            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/appointments/${id}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'confirmed' })
                });

                if (response.ok) {
                    showMessage('Appointment confirmed successfully', 'success');
                    loadModalAppointments();
                } else {
                    showMessage('Failed to confirm appointment', 'error');
                }
            } catch (error) {
                console.error('Error confirming appointment:', error);
                showMessage('Error confirming appointment', 'error');
            }
        }

        async function cancelModalAppointment(id) {
            if (!confirm('Are you sure you want to cancel this appointment?')) return;

            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/appointments/${id}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'cancelled' })
                });

                if (response.ok) {
                    showMessage('Appointment cancelled successfully', 'success');
                    loadModalAppointments();
                } else {
                    showMessage('Failed to cancel appointment', 'error');
                }
            } catch (error) {
                console.error('Error cancelling appointment:', error);
                showMessage('Error cancelling appointment', 'error');
            }
        }

        function editModalAppointment(id) {
            // This would open an edit modal - for now show a message
            showMessage('Edit functionality will be available in the next update', 'info');
        }

        function showBookingModal() {
            const bookingHTML = `
                <div style="padding: 20px;">
                    <h3 style="color: #3b82f6; margin-bottom: 20px;">Book New Appointment</h3>
                    <form id="booking-form" onsubmit="createAppointment(event)" style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="display: flex; gap: 15px;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Therapist:</label>
                                <select id="booking-therapist" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="">Select therapist...</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Appointment Type:</label>
                                <select id="booking-type" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="consultation">Consultation</option>
                                    <option value="therapy">Therapy Session</option>
                                    <option value="follow-up">Follow-up</option>
                                    <option value="assessment">Assessment</option>
                                    <option value="group">Group Session</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Date:</label>
                                <input type="date" id="booking-date" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Time:</label>
                                <input type="time" id="booking-time" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Duration:</label>
                                <select id="booking-duration" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="30">30 minutes</option>
                                    <option value="45">45 minutes</option>
                                    <option value="60" selected>60 minutes</option>
                                    <option value="90">90 minutes</option>
                                    <option value="120">2 hours</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Location:</label>
                                <select id="booking-location" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="Office Room 101">Office Room 101</option>
                                    <option value="Office Room 102">Office Room 102</option>
                                    <option value="Office Room 103">Office Room 103</option>
                                    <option value="Online">Online Session</option>
                                    <option value="Phone">Phone Call</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Notes (Optional):</label>
                            <textarea id="booking-notes" placeholder="Any special requirements or notes..." rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                                Google Calendar Sync
                            </label>
                            <button type="button" onclick="configureGoogleCalendar()" style="padding: 6px 16px; background: #4285f4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; margin-bottom: 8px; display: block;">
                                Configure
                            </button>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="booking-calendar-sync" checked style="width: 16px; height: 16px;">
                                <span id="modal-calendar-sync-status" style="font-size: 12px; color: #6b7280;">
                                    ${localStorage.getItem('googleCalendarConfigured') === 'true' ? '‚úÖ Configured and ready' : '‚ùå Not configured'}
                                </span>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button type="button" onclick="document.getElementById('booking-modal').remove()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Cancel
                            </button>
                            <button type="submit" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Book Appointment
                            </button>
                        </div>
                    </form>
                </div>
            `;

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'booking-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                justify-content: center; align-items: center;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; border-radius: 12px; max-width: 600px; width: 90%;
                max-height: 80vh; overflow-y: auto;
            `;
            modalContent.innerHTML = bookingHTML;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Load therapists
            loadTherapistsForBooking();
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('booking-date').min = today;
        }

        async function loadTherapistsForBooking() {
            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/therapists`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const therapists = await response.json();
                    const select = document.getElementById('booking-therapist');
                    if (select) {
                        select.innerHTML = '<option value="">Select therapist...</option>' +
                            therapists.map(t => `<option value="${t.id}">${t.name || t.username}</option>`).join('');
                    }
                } else {
                    console.error('Failed to load therapists');
                }
            } catch (error) {
                console.error('Error loading therapists:', error);
            }
        }

        async function createAppointment(event) {
            event.preventDefault();
            
            const formData = {
                therapist_id: parseInt(document.getElementById('booking-therapist').value),
                appointment_datetime: document.getElementById('booking-date').value + 'T' + document.getElementById('booking-time').value,
                duration_minutes: parseInt(document.getElementById('booking-duration').value),
                appointment_type: document.getElementById('booking-type').value,
                location: document.getElementById('booking-location').value,
                notes: document.getElementById('booking-notes').value || null,
                sync_with_calendar: document.getElementById('booking-calendar-sync').checked
            };

            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/appointments`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showMessage('Appointment booked successfully!', 'success');
                    document.getElementById('booking-modal').remove();
                    loadModalAppointments(); // Refresh appointments list
                } else {
                    const error = await response.json();
                    showMessage(`Failed to book appointment: ${error.detail || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error booking appointment:', error);
                showMessage('Error booking appointment. Please try again.', 'error');
            }
        }

        // Messages Module
        async function openMessagesModule() {
            try {
                console.log('Messages module clicked!');
                
                // Get auth token
                const token = getAuthToken();
                if (!token) {
                    showMessage('Please login to access messages', 'error');
                    return;
                }

                console.log('Token retrieved, loading messages dashboard');
                
                const messagesHTML = `
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); min-height: 100%; padding: 0;">
                        <!-- Messages Header -->
                        <div style="background: white; padding: 25px; margin-bottom: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="color: var(--primary-blue); margin: 0;">üí¨ Messages Center</h3>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="showComposeModal()" style="padding: 8px 16px; background: var(--primary-green); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        ‚úâÔ∏è Compose
                                    </button>
                                    <button onclick="refreshMessages()" style="padding: 8px 16px; background: var(--light-green); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        üîÑ Refresh
                                    </button>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <button id="btn-all-messages" onclick="switchMessageView('all')" style="padding: 8px 16px; border: 2px solid var(--primary-green); background: var(--primary-green); color: white; border-radius: 6px; cursor: pointer;">
                                    All Messages
                                </button>
                                <button id="btn-inbox" onclick="switchMessageView('inbox')" style="padding: 8px 16px; border: 2px solid var(--primary-blue); background: white; color: var(--primary-blue); border-radius: 6px; cursor: pointer;">
                                    Inbox
                                </button>
                                <button id="btn-sent" onclick="switchMessageView('sent')" style="padding: 8px 16px; border: 2px solid var(--primary-blue); background: white; color: var(--primary-blue); border-radius: 6px; cursor: pointer;">
                                    Sent
                                </button>
                                <button id="btn-unread" onclick="switchMessageView('unread')" style="padding: 8px 16px; border: 2px solid var(--primary-blue); background: white; color: var(--primary-blue); border-radius: 6px; cursor: pointer;">
                                    Unread Only
                                </button>
                            </div>
                            <div id="message-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                Loading statistics...
                            </div>
                        </div>

                        <!-- Messages List -->
                        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                            <h4 style="color: var(--primary-green); margin-bottom: 20px;">Messages</h4>
                            <div id="messages-container" style="max-height: 600px; overflow-y: auto;">
                                Loading messages...
                            </div>
                        </div>
                    </div>
                `;

                showLargeModal('Messages Center', messagesHTML);
                loadMessagesData();
            } catch (error) {
                console.error('Error opening messages module:', error);
                showMessage('Error opening messages module', 'error');
            }
        }

        // Messages Data Loading Functions
        let currentMessageView = 'all';
        let allMessagesData = [];

        async function loadMessagesData() {
            const token = getAuthToken();

            try {
                // Load all messages (admin only)
                const allResponse = await fetch(`${API_BASE_URL}/messages/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Load inbox messages
                const inboxResponse = await fetch(`${API_BASE_URL}/messages/inbox`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Load sent messages
                const sentResponse = await fetch(`${API_BASE_URL}/messages/sent`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Get user list for name resolution
                const usersResponse = await fetch(`${API_BASE_URL}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                let allMessages = [];
                let inboxMessages = [];
                let sentMessages = [];
                let users = [];

                if (allResponse.ok) {
                    allMessages = await allResponse.json();
                }
                if (inboxResponse.ok) {
                    inboxMessages = await inboxResponse.json();
                }
                if (sentResponse.ok) {
                    sentMessages = await sentResponse.json();
                }
                if (usersResponse.ok) {
                    users = await usersResponse.json();
                }

                // Store data globally
                allMessagesData = {
                    all: allMessages,
                    inbox: inboxMessages,
                    sent: sentMessages,
                    users: users
                };

                updateMessageStats();
                displayMessages(currentMessageView);

            } catch (error) {
                console.error('Error loading messages data:', error);
                showMessage('Error loading messages data', 'error');
            }
        }

        function updateMessageStats() {
            const container = document.getElementById('message-stats');
            if (!container) return;

            const { all, inbox, sent } = allMessagesData;
            const unreadCount = inbox.filter(msg => !msg.read).length;

            container.innerHTML = `
                <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 8px;">
                    <div style="font-size: 18px; font-weight: bold; color: #1976d2;">${all.length}</div>
                    <div style="color: #666; margin-top: 5px;">Total Messages</div>
                </div>
                <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); border-radius: 8px;">
                    <div style="font-size: 18px; font-weight: bold; color: #388e3c;">${inbox.length}</div>
                    <div style="color: #666; margin-top: 5px;">Inbox</div>
                </div>
                <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #fff3e0 0%, #ffcc02 100%); border-radius: 8px;">
                    <div style="font-size: 18px; font-weight: bold; color: #f57c00;">${sent.length}</div>
                    <div style="color: #666; margin-top: 5px;">Sent</div>
                </div>
                <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-radius: 8px;">
                    <div style="font-size: 18px; font-weight: bold; color: #d32f2f;">${unreadCount}</div>
                    <div style="color: #666; margin-top: 5px;">Unread</div>
                </div>
            `;
        }

        function switchMessageView(view) {
            currentMessageView = view;
            
            // Update button styles
            const buttons = ['btn-all-messages', 'btn-inbox', 'btn-sent', 'btn-unread'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.style.background = 'white';
                    btn.style.color = 'var(--primary-blue)';
                }
            });

            const activeBtn = document.getElementById(`btn-${view === 'all' ? 'all-messages' : view}`);
            if (activeBtn) {
                activeBtn.style.background = 'var(--primary-blue)';
                activeBtn.style.color = 'white';
            }

            displayMessages(view);
        }

        function displayMessages(view) {
            const container = document.getElementById('messages-container');
            if (!container) return;

            const { all, inbox, sent, users } = allMessagesData;
            let messages = [];

            switch (view) {
                case 'all':
                    messages = all;
                    break;
                case 'inbox':
                    messages = inbox;
                    break;
                case 'sent':
                    messages = sent;
                    break;
                case 'unread':
                    messages = inbox.filter(msg => !msg.read);
                    break;
            }

            if (messages.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No messages found</p>';
                return;
            }

            const getUserName = (userId) => {
                const user = users.find(u => u.id === userId);
                return user ? user.name : `User #${userId}`;
            };

            const messagesHtml = messages.map(message => {
                const isRead = message.read ? '‚úÖ' : 'üî¥';
                const readClass = message.read ? 'opacity: 0.8;' : 'font-weight: bold;';

                return `
                    <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px; ${readClass}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <h5 style="margin: 0; color: var(--primary-green);">${isRead} ${message.subject}</h5>
                            <div style="display: flex; gap: 10px;">
                                ${view === 'inbox' && !message.read ? `<button onclick="markAsRead(${message.id})" style="padding: 4px 8px; background: var(--primary-green); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Mark Read</button>` : ''}
                                <button onclick="deleteMessage(${message.id})" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 14px; color: #666;">
                            <div><strong>From:</strong> ${getUserName(message.sender_id)}</div>
                            <div><strong>To:</strong> ${getUserName(message.recipient_id)}</div>
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            <strong>Date:</strong> ${new Date(message.timestamp).toLocaleString()}
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 10px;">
                            ${message.content}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = messagesHtml;
        }

        async function markAsRead(messageId) {
            const token = getAuthToken();

            try {
                const response = await fetch(`${API_BASE_URL}/messages/${messageId}/read`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showMessage('Message marked as read', 'success');
                    loadMessagesData(); // Refresh data
                } else {
                    showMessage('Failed to mark message as read', 'error');
                }
            } catch (error) {
                console.error('Error marking message as read:', error);
                showMessage('Error marking message as read', 'error');
            }
        }

        async function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) {
                return;
            }

            const token = getAuthToken();

            try {
                const response = await fetch(`${API_BASE_URL}/messages/${messageId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showMessage('Message deleted successfully', 'success');
                    loadMessagesData(); // Refresh data
                } else {
                    showMessage('Failed to delete message', 'error');
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                showMessage('Error deleting message', 'error');
            }
        }

        function showComposeModal() {
            const { users } = allMessagesData;
            
            const userOptions = users.map(user => 
                `<option value="${user.id}">${user.name} (${user.role})</option>`
            ).join('');

            const composeHTML = `
                <div style="padding: 20px;">
                    <h3 style="color: var(--primary-green); margin-bottom: 20px;">Compose New Message</h3>
                    <form id="compose-message-form" onsubmit="sendMessage(event)" style="display: flex; flex-direction: column; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Recipient:</label>
                            <select id="recipient-select" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                <option value="">Select recipient...</option>
                                ${userOptions}
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Subject:</label>
                            <input type="text" id="message-subject" required placeholder="Enter subject" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Message:</label>
                            <textarea id="message-content" required placeholder="Enter your message" rows="6" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="document.getElementById('compose-modal').remove()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Cancel
                            </button>
                            <button type="submit" style="padding: 10px 20px; background: var(--primary-green); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Send Message
                            </button>
                        </div>
                    </form>
                </div>
            `;

            // Create compose modal
            const modal = document.createElement('div');
            modal.id = 'compose-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; 
                justify-content: center; z-index: 10001; padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
                    ${composeHTML}
                </div>
            `;

            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        async function sendMessage(event) {
            event.preventDefault();
            
            const recipientId = document.getElementById('recipient-select').value;
            const subject = document.getElementById('message-subject').value;
            const content = document.getElementById('message-content').value;

            if (!recipientId || !subject || !content) {
                showMessage('Please fill in all fields', 'error');
                return;
            }

            const token = getAuthToken();

            try {
                const response = await fetch(`${API_BASE_URL}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        recipient_id: parseInt(recipientId),
                        subject: subject,
                        content: content
                    })
                });

                if (response.ok) {
                    showMessage('Message sent successfully!', 'success');
                    document.getElementById('compose-modal').remove();
                    loadMessagesData(); // Refresh messages
                } else {
                    const error = await response.json();
                    showMessage(`Failed to send message: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showMessage('Error sending message', 'error');
            }
        }

        function refreshMessages() {
            loadMessagesData();
        }

        // System Settings Module
        async function openSettingsModule() {
            try {
                // Get auth token
                const token = getAuthToken();
                if (!token) {
                    showMessage('Please login to access settings', 'error');
                    return;
                }

                // Fetch current settings from backend
                const response = await fetch(`${API_BASE_URL}/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                let settings = [];
                if (response.ok) {
                    settings = await response.json();
                } else if (response.status === 403) {
                    showMessage('Admin access required to view settings', 'error');
                    return;
                } else {
                    console.warn('Failed to load settings:', response.status);
                }

                const settingsHTML = `
                    <div style="display: flex; gap: 20px; min-height: 600px;">
                        <!-- Left side - Settings Form -->
                        <div style="flex: 0 0 450px; background: var(--bg-light); padding: 25px; border-radius: 12px; overflow-y: auto;">
                            <h3 style="color: var(--primary-green); margin-bottom: 20px; font-size: 20px;">System Settings</h3>
                            
                            <!-- Add New Setting Form -->
                            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary-green);">
                                <h4 style="color: var(--text-dark); margin-bottom: 15px;">Add New Setting</h4>
                                <form id="new-setting-form" onsubmit="createSetting(event)">
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Setting Key</label>
                                        <input type="text" id="setting-key" required placeholder="e.g., email.smtp.host" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                    </div>
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Setting Value</label>
                                        <input type="text" id="setting-value" required placeholder="Setting value" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Type</label>
                                            <select id="setting-type" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                                <option value="string">String</option>
                                                <option value="integer">Integer</option>
                                                <option value="boolean">Boolean</option>
                                                <option value="json">JSON</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Category</label>
                                            <select id="setting-category" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                                <option value="general">General</option>
                                                <option value="email">Email</option>
                                                <option value="appointments">Appointments</option>
                                                <option value="payments">Payments</option>
                                                <option value="api">API</option>
                                                <option value="security">Security</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Description</label>
                                        <textarea id="setting-description" placeholder="Optional description" rows="2" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit;"></textarea>
                                    </div>
                                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="setting-public" style="margin: 0;">
                                            <span style="font-size: 14px;">Public (visible to non-admin users)</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="setting-editable" checked style="margin: 0;">
                                            <span style="font-size: 14px;">Editable</span>
                                        </label>
                                    </div>
                                    <button type="submit" style="width: 100%; padding: 10px; background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        ‚ûï Add Setting
                                    </button>
                                </form>
                            </div>

                            <!-- Filter Controls -->
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="color: var(--text-dark); margin-bottom: 10px;">Filter Settings</h4>
                                <select id="category-filter" onchange="filterSettings()" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                    <option value="">All Categories</option>
                                    <option value="general">General</option>
                                    <option value="email">Email</option>
                                    <option value="appointments">Appointments</option>
                                    <option value="payments">Payments</option>
                                    <option value="api">API</option>
                                    <option value="security">Security</option>
                                </select>
                            </div>
                        </div>

                        <!-- Right side - Settings List -->
                        <div style="flex: 1; background: white; padding: 25px; border-radius: 12px; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div>
                                    <h3 style="color: var(--primary-green); margin: 0 0 5px 0;">Current Settings</h3>
                                    <p id="settings-count" style="margin: 0; font-size: 13px; color: var(--text-light);">Loading...</p>
                                </div>
                                <button onclick="loadSettings()" style="padding: 8px 16px; background: var(--light-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    üîÑ Refresh
                                </button>
                            </div>
                            <div id="settings-list" style="max-height: 500px; overflow-y: auto;">
                                Loading settings...
                            </div>
                        </div>
                    </div>
                `;

                showLargeModal('System Settings', settingsHTML);
                loadSettingsData(settings);
            } catch (error) {
                console.error('Error opening settings module:', error);
                showMessage('Error opening settings module', 'error');
            }
        }

        // Settings Module Supporting Functions
        function loadSettingsData(settings) {
            const settingsList = document.getElementById('settings-list');
            if (!settings || settings.length === 0) {
                settingsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
                        <p style="color: var(--text-light); font-size: 16px; margin-bottom: 10px;">üìã No settings configured yet.</p>
                        <p style="color: var(--text-light); font-size: 14px;">Use the form on the left to add your first system setting.</p>
                    </div>
                `;
                return;
            }

            // Group settings by category
            const settingsByCategory = settings.reduce((acc, setting) => {
                if (!acc[setting.category]) {
                    acc[setting.category] = [];
                }
                acc[setting.category].push(setting);
                return acc;
            }, {});

            let html = '';
            for (const [category, categorySettings] of Object.entries(settingsByCategory)) {
                html += `
                    <div class="settings-category" data-category="${category}" style="margin-bottom: 25px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid var(--border-color); text-transform: capitalize;">
                            ${category} Settings (${categorySettings.length})
                        </h4>
                `;
                
                categorySettings.forEach(setting => {
                    const typeIcon = {
                        'string': 'üìù',
                        'integer': 'üî¢', 
                        'boolean': '‚òëÔ∏è',
                        'json': '{ }'
                    }[setting.setting_type] || 'üìù';
                    
                    // Format setting key to be more readable
                    const displayKey = setting.setting_key
                        .replace(/_/g, ' ')
                        .split('.')
                        .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                        .join(' ‚Üí ');

                    html += `
                        <div class="setting-item" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${setting.is_public ? '#4caf50' : '#ff9800'};">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0 0 5px 0; color: var(--text-dark); font-size: 13px; font-weight: 600;">
                                        ${displayKey}
                                        ${setting.is_public ? '<span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 8px;">PUBLIC</span>' : ''}
                                        ${!setting.is_editable ? '<span style="background: #757575; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 8px;">READ-ONLY</span>' : ''}
                                    </h5>
                                    <p style="margin: 0 0 5px 0; color: var(--text-light); font-size: 11px; font-style: italic;">
                                        ${setting.setting_key}
                                    </p>
                                    <p style="margin: 0 0 8px 0; color: var(--text-dark); font-size: 12px;">
                                        ${setting.description || 'No description'}
                                    </p>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button onclick="editSetting('${setting.setting_key}')" style="padding: 4px 8px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        Edit
                                    </button>
                                    ${setting.is_editable ? `<button onclick="deleteSetting('${setting.setting_key}')" style="padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>` : ''}
                                </div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid var(--border-color);">
                                <code style="color: var(--text-dark); font-family: 'Courier New', monospace; word-break: break-all;">
                                    ${setting.setting_value}
                                </code>
                            </div>
                            <div style="margin-top: 8px; font-size: 11px; color: var(--text-light);">
                                Type: ${setting.setting_type} | Category: ${setting.category} | 
                                Updated: ${new Date(setting.updated_at).toLocaleDateString()}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }

            settingsList.innerHTML = html;
            
            // Update settings count
            const settingsCount = document.getElementById('settings-count');
            if (settingsCount) {
                const categoryCount = Object.keys(settingsByCategory).length;
                settingsCount.textContent = `Total: ${settings.length} settings across ${categoryCount} ${categoryCount === 1 ? 'category' : 'categories'}`;
            }
            
            // Apply current filter if any
            const filterSelect = document.getElementById('category-filter');
            if (filterSelect && filterSelect.value) {
                filterSettings();
            }
        }

        async function createSetting(event) {
            event.preventDefault();
            
            const settingData = {
                setting_key: document.getElementById('setting-key').value,
                setting_value: document.getElementById('setting-value').value,
                setting_type: document.getElementById('setting-type').value,
                category: document.getElementById('setting-category').value,
                description: document.getElementById('setting-description').value || null,
                is_public: document.getElementById('setting-public').checked,
                is_editable: document.getElementById('setting-editable').checked
            };

            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(settingData)
                });

                if (response.ok) {
                    showMessage('‚úÖ Setting created successfully!', 'success');
                    document.getElementById('new-setting-form').reset();
                    loadSettings(); // Refresh the settings list
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to create setting', 'error');
                }
            } catch (error) {
                console.error('Error creating setting:', error);
                showMessage('Network error while creating setting', 'error');
            }
        }

        async function loadSettings() {
            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const settings = await response.json();
                    loadSettingsData(settings);
                } else {
                    showMessage('Failed to load settings', 'error');
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                showMessage('Error loading settings', 'error');
            }
        }

        function filterSettings() {
            const selectedCategory = document.getElementById('category-filter').value;
            const categoryDivs = document.querySelectorAll('.settings-category');
            const settingsList = document.getElementById('settings-list');
            
            if (categoryDivs.length === 0) {
                // No settings loaded yet
                return;
            }
            
            let visibleCount = 0;
            
            categoryDivs.forEach(div => {
                if (!selectedCategory || div.dataset.category === selectedCategory) {
                    div.style.display = 'block';
                    visibleCount++;
                } else {
                    div.style.display = 'none';
                }
            });
            
            // Show message if no settings match the filter
            if (visibleCount === 0 && selectedCategory) {
                const existingNoMatch = settingsList.querySelector('.no-match-message');
                if (!existingNoMatch) {
                    const noMatchMsg = document.createElement('div');
                    noMatchMsg.className = 'no-match-message';
                    noMatchMsg.style.cssText = 'color: var(--text-light); text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; margin-top: 20px;';
                    noMatchMsg.innerHTML = `
                        <p style="font-size: 16px; margin-bottom: 10px;">üì≠ No settings found for category: <strong>${selectedCategory}</strong></p>
                        <p style="font-size: 14px; color: var(--text-light);">Try selecting a different category or add a new setting.</p>
                    `;
                    settingsList.appendChild(noMatchMsg);
                }
            } else {
                // Remove no-match message if it exists
                const existingNoMatch = settingsList.querySelector('.no-match-message');
                if (existingNoMatch) {
                    existingNoMatch.remove();
                }
            }
        }

        async function editSetting(settingKey) {
            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/settings/${settingKey}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const setting = await response.json();
                    showEditSettingModal(setting);
                } else {
                    showMessage('Failed to load setting details', 'error');
                }
            } catch (error) {
                console.error('Error loading setting:', error);
                showMessage('Error loading setting', 'error');
            }
        }

        function showEditSettingModal(setting) {
            const editHTML = `
                <div style="padding: 20px; max-width: 500px;">
                    <h3 style="color: var(--primary-green); margin-bottom: 20px;">Edit Setting: ${setting.setting_key}</h3>
                    <form id="edit-setting-form" onsubmit="updateSetting(event, '${setting.setting_key}')">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Setting Value</label>
                            <textarea id="edit-setting-value" rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: 'Courier New', monospace;">${setting.setting_value}</textarea>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Description</label>
                            <textarea id="edit-setting-description" rows="2" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit;">${setting.description || ''}</textarea>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="edit-setting-public" ${setting.is_public ? 'checked' : ''}>
                                <span style="font-size: 14px;">Public</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="edit-setting-editable" ${setting.is_editable ? 'checked' : ''}>
                                <span style="font-size: 14px;">Editable</span>
                            </label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button type="submit" style="padding: 10px; background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                üíæ Update Setting
                            </button>
                            <button type="button" onclick="closeModal()" style="padding: 10px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                ‚úñ Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showLargeModal('Edit Setting', editHTML);
        }

        async function updateSetting(event, settingKey) {
            event.preventDefault();
            
            const updateData = {
                setting_value: document.getElementById('edit-setting-value').value,
                description: document.getElementById('edit-setting-description').value || null,
                is_public: document.getElementById('edit-setting-public').checked,
                is_editable: document.getElementById('edit-setting-editable').checked
            };

            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/settings/${settingKey}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    showMessage('‚úÖ Setting updated successfully!', 'success');
                    closeModal();
                    loadSettings(); // Refresh the settings list
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to update setting', 'error');
                }
            } catch (error) {
                console.error('Error updating setting:', error);
                showMessage('Network error while updating setting', 'error');
            }
        }

        async function deleteSetting(settingKey) {
            if (!confirm(`Are you sure you want to delete the setting "${settingKey}"?`)) {
                return;
            }

            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/settings/${settingKey}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showMessage('‚úÖ Setting deleted successfully!', 'success');
                    loadSettings(); // Refresh the settings list
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to delete setting', 'error');
                }
            } catch (error) {
                console.error('Error deleting setting:', error);
                showMessage('Network error while deleting setting', 'error');
            }
        }

        // Analytics Module Supporting Functions
        async function loadAnalyticsData() {
            try {
                const timeRange = document.getElementById('analyticsTimeRange')?.value || 30;
                await Promise.all([
                    loadDashboardData(timeRange),
                    loadUserAnalytics(timeRange),
                    loadAppointmentAnalytics(timeRange)
                ]);
            } catch (error) {
                console.error('Error loading analytics data:', error);
                showMessage('Error loading analytics data', 'error');
            }
        }

        async function loadDashboardData(days = 30) {
            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/analytics/dashboard?days=${days}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateDashboardMetrics(data);
                    updateRecentActivity(data.recent_activities);
                } else {
                    throw new Error('Failed to load dashboard data');
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('totalUsers').textContent = 'Error';
            }
        }

        async function loadUserAnalytics(days = 30) {
            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/analytics/users?days=${days}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateUserAnalytics(data);
                } else {
                    throw new Error('Failed to load user analytics');
                }
            } catch (error) {
                console.error('Error loading user analytics:', error);
                document.getElementById('userRolesData').innerHTML = '<div style="color: red;">Error loading user data</div>';
            }
        }

        async function loadAppointmentAnalytics(days = 30) {
            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/analytics/appointments?days=${days}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateAppointmentAnalytics(data);
                } else {
                    throw new Error('Failed to load appointment analytics');
                }
            } catch (error) {
                console.error('Error loading appointment analytics:', error);
                document.getElementById('appointmentStatusData').innerHTML = '<div style="color: red;">Error loading appointment data</div>';
            }
        }

        function updateDashboardMetrics(data) {
            // Update metric cards
            document.getElementById('totalUsers').textContent = data.user_stats.total_users.toLocaleString();
            document.getElementById('newUsers').textContent = `+${data.user_stats.new_users} new`;

            document.getElementById('totalAppointments').textContent = data.appointment_stats.total_appointments.toLocaleString();
            document.getElementById('recentAppointments').textContent = `+${data.appointment_stats.recent_appointments} recent`;

            document.getElementById('totalMessages').textContent = data.message_stats.total_messages.toLocaleString();
            document.getElementById('recentMessages').textContent = `+${data.message_stats.recent_messages} recent`;

            document.getElementById('totalMeals').textContent = data.meal_stats.total_meals.toLocaleString();
            document.getElementById('recentMeals').textContent = `+${data.meal_stats.recent_meals} recent`;

            // Update meal stats section
            const mealStatsHtml = `
                <div class="data-table">
                    <h4>Meal Type Distribution</h4>
                    ${Object.entries(data.meal_stats.type_distribution || {}).map(([type, count]) => `
                        <div class="status-item">
                            <span class="item-label">${type}</span>
                            <span class="item-value">${count}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="data-table" style="margin-top: 15px;">
                    <h4>System Information</h4>
                    <div class="status-item">
                        <span class="item-label">Total Ingredients</span>
                        <span class="item-value">${data.system_stats.total_ingredients}</span>
                    </div>
                    <div class="status-item">
                        <span class="item-label">System Settings</span>
                        <span class="item-value">${data.system_stats.total_settings}</span>
                    </div>
                </div>
            `;
            document.getElementById('mealStats').innerHTML = mealStatsHtml;
        }

        function updateUserAnalytics(data) {
            // Update user roles distribution
            const userRolesHtml = data.role_distribution.map(role => `
                <div class="role-item">
                    <span class="item-label">${role.role}</span>
                    <span class="item-value">${role.count}</span>
                </div>
            `).join('');
            document.getElementById('userRolesData').innerHTML = userRolesHtml;

            // Update user growth chart placeholder with simple text representation
            if (data.user_growth && data.user_growth.length > 0) {
                const chartHtml = `
                    <div style="text-align: center; padding: 20px;">
                        <h4>User Registration Trend</h4>
                        <div style="font-size: 1.2em; margin: 15px 0;">
                            <strong>${data.total_users}</strong> total users
                        </div>
                        <div style="font-size: 0.9em; color: #666;">
                            Active users: <strong>${data.active_users || 'N/A'}</strong>
                        </div>
                        <div style="margin-top: 15px; font-size: 0.85em; color: #888;">
                            Recent registrations: ${data.user_growth.slice(-7).map(d => d.count).reduce((a, b) => a + b, 0)} (last 7 days)
                        </div>
                    </div>
                `;
                document.getElementById('userGrowthChart').innerHTML = chartHtml;
            }
        }

        function updateAppointmentAnalytics(data) {
            // Update appointment status distribution
            const statusHtml = data.status_distribution.map(status => `
                <div class="status-item">
                    <span class="item-label">${status.status}</span>
                    <span class="item-value">${status.count}</span>
                </div>
            `).join('');
            document.getElementById('appointmentStatusData').innerHTML = statusHtml;

            // Update appointment trends chart
            if (data.appointment_trends && data.appointment_trends.length > 0) {
                const totalRecent = data.appointment_trends.reduce((sum, trend) => sum + trend.count, 0);
                const chartHtml = `
                    <div style="text-align: center; padding: 20px;">
                        <h4>Appointment Booking Trends</h4>
                        <div style="font-size: 1.2em; margin: 15px 0;">
                            <strong>${totalRecent}</strong> appointments in selected period
                        </div>
                        <div style="font-size: 0.9em; color: #666;">
                            Peak day: ${data.appointment_trends.sort((a, b) => b.count - a.count)[0]?.date || 'N/A'}
                        </div>
                    </div>
                `;
                document.getElementById('appointmentTrendsChart').innerHTML = chartHtml;
            }

            // Update top therapists
            if (data.top_therapists && data.top_therapists.length > 0) {
                const therapistsHtml = data.top_therapists.map((therapist, index) => `
                    <div class="therapist-item">
                        <span class="item-label">#${index + 1} ${therapist.therapist}</span>
                        <span class="item-value">${therapist.count} appointments</span>
                    </div>
                `).join('');
                document.getElementById('topTherapists').innerHTML = therapistsHtml;
            } else {
                document.getElementById('topTherapists').innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No therapist data available</div>';
            }
        }

        function updateRecentActivity(activities) {
            if (activities && activities.length > 0) {
                const activityHtml = activities.map(activity => `
                    <div class="activity-item">
                        <div>
                            <span class="activity-type">${activity.activity_type}</span>
                            ${activity.activity_data ? `<div style="font-size: 0.85em; color: #666; margin-top: 2px;">${activity.activity_data}</div>` : ''}
                        </div>
                        <div class="activity-time">${new Date(activity.timestamp).toLocaleString()}</div>
                    </div>
                `).join('');
                document.getElementById('recentActivity').innerHTML = activityHtml;
            } else {
                document.getElementById('recentActivity').innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No recent activity available</div>';
            }
        }

        async function refreshAnalytics() {
            const button = event?.target;
            if (button) {
                button.disabled = true;
                button.textContent = 'üîÑ Loading...';
            }

            try {
                await loadAnalyticsData();
                showMessage('‚úÖ Analytics data refreshed!', 'success');
            } catch (error) {
                showMessage('Error refreshing analytics data', 'error');
            } finally {
                if (button) {
                    button.disabled = false;
                    button.textContent = 'üîÑ Refresh';
                }
            }
        }

        async function exportAnalytics() {
            try {
                const timeRange = document.getElementById('analyticsTimeRange')?.value || 30;
                const token = getAuthToken();
                
                // Collect all analytics data for export
                const [dashboardData, userAnalytics, appointmentAnalytics] = await Promise.all([
                    fetch(`${API_BASE_URL}/analytics/dashboard?days=${timeRange}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json()),
                    fetch(`${API_BASE_URL}/analytics/users?days=${timeRange}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json()),
                    fetch(`${API_BASE_URL}/analytics/appointments?days=${timeRange}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json())
                ]);

                const exportData = {
                    generated_at: new Date().toISOString(),
                    time_range_days: timeRange,
                    dashboard: dashboardData,
                    users: userAnalytics,
                    appointments: appointmentAnalytics
                };

                // Create and download JSON file
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mindlab-analytics-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showMessage('‚úÖ Analytics report exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting analytics:', error);
                showMessage('Error exporting analytics report', 'error');
            }
        }

        // Log user activity for analytics tracking
        async function logUserActivity(activityType, activityData = null) {
            try {
                const token = getAuthToken();
                if (!token) return; // Don't log if not authenticated

                await fetch(`${API_BASE_URL}/analytics/activity`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        activity_type: activityType,
                        activity_data: activityData,
                        user_agent: navigator.userAgent
                    })
                });
            } catch (error) {
                // Silently fail for activity logging to not disrupt user experience
                console.log('Activity logging failed:', error);
            }
        }

        // Nutrient Management Module (Main Panel: Ingredient Nutrition)
        async function openNutrientManagementModule() {
            const ingredientHTML = `
                <div style="display: flex; gap: 20px; min-height: 600px;">
                    <!-- Left side - Form and Upload -->
                    <div style="flex: 0 0 450px; background: var(--bg-light); padding: 25px; border-radius: 12px; overflow-y: auto;">
                        <!-- Log Nutrient Intake Button -->
                        <div style="margin-bottom: 20px;">
                            <button onclick="openLogNutrientIntake()" style="width: 100%; padding: 10px 16px; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; box-shadow: 0 2px 4px rgba(74, 144, 226, 0.3); transition: all 0.3s;">
                                üìä Log Nutrient Intake
                            </button>
                        </div>
                        
                        <h3 style="color: var(--primary-green); margin-bottom: 20px;">Add Ingredient Nutrition</h3>
                        
                        <!-- Manual Entry Form -->
                        <form id="add-ingredient-nutrition-form" style="margin-bottom: 30px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Ingredient Name *</label>
                                <input type="text" id="ingredient-name" required placeholder="e.g., Chicken Breast" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Serving Size</label>
                                <input type="text" id="serving-size" placeholder="e.g., 100g, 1 cup" value="100g" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Calories</label>
                                    <input type="number" id="calories" step="0.1" min="0" value="0" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Protein (g)</label>
                                    <input type="number" id="protein" step="0.1" min="0" value="0" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Carbs (g)</label>
                                    <input type="number" id="carbohydrates" step="0.1" min="0" value="0" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Fat (g)</label>
                                    <input type="number" id="fat" step="0.1" min="0" value="0" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Fiber (g)</label>
                                    <input type="number" id="fiber" step="0.1" min="0" value="0" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Sugar (g)</label>
                                    <input type="number" id="sugar" step="0.1" min="0" value="0" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Sodium (mg)</label>
                                    <input type="number" id="sodium" step="0.1" min="0" value="0" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Cholesterol (mg)</label>
                                    <input type="number" id="cholesterol" step="0.1" min="0" value="0" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                            </div>
                            
                            <details style="margin-bottom: 15px;">
                                <summary style="cursor: pointer; font-weight: 600; color: var(--primary-green); padding: 10px; background: white; border-radius: 6px;">+ Show Vitamins & Minerals</summary>
                                <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Vitamin A (mcg)</label>
                                            <input type="number" id="vitamin-a" step="0.1" min="0" value="0" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Vitamin C (mg)</label>
                                            <input type="number" id="vitamin-c" step="0.1" min="0" value="0" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Vitamin D (mcg)</label>
                                            <input type="number" id="vitamin-d" step="0.1" min="0" value="0" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Calcium (mg)</label>
                                            <input type="number" id="calcium" step="0.1" min="0" value="0" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Iron (mg)</label>
                                            <input type="number" id="iron" step="0.1" min="0" value="0" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Potassium (mg)</label>
                                            <input type="number" id="potassium" step="0.1" min="0" value="0" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                        </div>
                                    </div>
                                </div>
                            </details>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Notes</label>
                                <textarea id="ingredient-notes" rows="2" placeholder="Additional information..." style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; resize: vertical; font-family: inherit;"></textarea>
                            </div>
                            
                            <button type="submit" style="width: 100%; padding: 12px; background: linear-gradient(135deg, var(--primary-green) 0%, #27ae60 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Add Ingredient</button>
                        </form>

                        <!-- File Upload Section -->
                        <div style="border-top: 2px solid var(--border-color); padding-top: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: var(--primary-green); margin: 0; font-size: 16px;">Bulk Import</h3>
                                <button onclick="downloadIngredientNutritionTemplate()" style="width: 30%; min-width: 120px; padding: 6px 12px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: clamp(11px, 1.8vw, 12px); font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 5px; white-space: nowrap;">
                                    Download Template
                                </button>
                            </div>
                            <p style="font-size: 12px; color: var(--text-light); margin-bottom: 10px;">Upload CSV or Excel with columns:<br><em>ingredient_name, serving_size, calories, protein, carbohydrates, fat, fiber, sugar, sodium, cholesterol, vitamin_a, vitamin_c, vitamin_d, calcium, iron, potassium</em></p>
                            <input type="file" id="ingredient-nutrition-file-upload" accept=".csv,.xlsx,.xls" style="margin-bottom: 10px; font-size: 14px;">
                            <button onclick="uploadIngredientNutritionFile()" style="width: 100%; padding: 10px; background: var(--secondary-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Upload File</button>
                        </div>
                    </div>

                    <!-- Right side - Data Table -->
                    <div style="flex: 1; background: white; padding: 25px; border-radius: 12px; overflow: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--primary-green); margin: 0; white-space: nowrap;">Ingredient Nutrition Database</h3>
                            <button onclick="loadIngredientNutritionData()" style="padding: 8px 16px; background: var(--accent-green); color: white; border: none; border-radius: 6px; cursor: pointer;">Refresh</button>
                        </div>
                        <div id="ingredient-nutrition-table-container">
                            <p style="text-align: center; color: var(--text-light);">Loading...</p>
                        </div>
                    </div>
                </div>
            `;
            
            showLargeModal('ü•ó Nutrient Management', ingredientHTML);
            
            // Load data
            loadIngredientNutritionData();
            
            // Setup form submission
            document.getElementById('add-ingredient-nutrition-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addIngredientNutrition();
            });
        }

        // Log Nutrient Intake (Secondary Panel - accessed via button)
        async function openLogNutrientIntake() {
            const nutrientsHTML = `
                <div style="display: flex; gap: 20px; min-height: 600px;">
                    <!-- Left side - Forms and Upload -->
                    <div style="flex: 0 0 420px; background: var(--bg-light); padding: 25px; border-radius: 12px; overflow-y: auto;">
                        <!-- Back to Ingredient Nutrition Button -->
                        <div style="margin-bottom: 20px;">
                            <button onclick="openNutrientManagementModule()" style="width: 100%; padding: 10px 16px; background: linear-gradient(135deg, #d2691e 0%, #cd853f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; box-shadow: 0 2px 4px rgba(210, 105, 30, 0.3); transition: all 0.3s;">
                                ‚Üê Back to Ingredient Nutrition
                            </button>
                        </div>
                        
                        <h3 style="color: var(--primary-green); margin-bottom: 20px;">Log Nutrient Intake</h3>
                        
                        <!-- Manual Entry Form -->
                        <form id="add-nutrient-form" style="margin-bottom: 30px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Nutrient Name</label>
                                <input type="text" id="nutrient-name" required placeholder="e.g., Vitamin C" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Amount</label>
                                <input type="number" id="nutrient-amount" required min="0" step="0.1" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Unit</label>
                                <select id="nutrient-unit" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                    <option value="mg">mg (milligrams)</option>
                                    <option value="g">g (grams)</option>
                                    <option value="mcg">mcg (micrograms)</option>
                                    <option value="IU">IU (International Units)</option>
                                    <option value="ml">ml (milliliters)</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Date</label>
                                <input type="date" id="nutrient-date" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            <button type="submit" style="width: 100%; padding: 12px; background: var(--primary-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Log Nutrient</button>
                        </form>

                        <!-- File Upload Section -->
                        <div style="border-top: 2px solid var(--border-color); padding-top: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: var(--primary-green); margin: 0; font-size: 16px;">Bulk Import</h3>
                                <button onclick="downloadNutrientsTemplate()" style="width: 30%; min-width: 120px; padding: 6px 12px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: clamp(11px, 1.8vw, 12px); font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 5px; white-space: nowrap;">
                                    Download Template
                                </button>
                            </div>
                            <p style="font-size: 12px; color: var(--text-light); margin-bottom: 10px;">Upload CSV or Excel file with columns:<br><em>nutrient_name, amount, unit, date_tracked</em></p>
                            <input type="file" id="nutrients-file-upload" accept=".csv,.xlsx,.xls" style="margin-bottom: 10px; font-size: 14px;">
                            <button onclick="uploadNutrientsFile()" style="width: 100%; padding: 10px; background: var(--secondary-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Upload File</button>
                        </div>
                    </div>

                    <!-- Right side - Data Table -->
                    <div style="flex: 1; background: white; padding: 25px; border-radius: 12px; overflow: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--primary-green); margin: 0;">All Nutrient Logs</h3>
                            <button onclick="loadNutrientsData()" style="padding: 8px 16px; background: var(--accent-green); color: white; border: none; border-radius: 6px; cursor: pointer;">Refresh</button>
                        </div>
                        <div id="nutrients-table-container">
                            <p style="text-align: center; color: var(--text-light);">Loading nutrients data...</p>
                        </div>
                    </div>
                </div>
            `;
            
            showLargeModal('üìä Log Nutrient Intake', nutrientsHTML);
            
            // Set today's date as default
            document.getElementById('nutrient-date').valueAsDate = new Date();
            
            // Load nutrients data
            loadNutrientsData();
            
            // Setup form submission
            document.getElementById('add-nutrient-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addNutrient();
            });
        }

        async function loadNutrientsData() {
            const container = document.getElementById('nutrients-table-container');
            container.innerHTML = '<p style="text-align: center; color: var(--text-light);">Loading...</p>';
            
            // Always get fresh token from localStorage
            const token = localStorage.getItem('authToken');
            if (!token) {
                container.innerHTML = '<p style="color: red; text-align: center;">Session expired. Please login again.</p>';
                logout();
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/nutrients/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const nutrients = await response.json();
                    
                    if (nutrients.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No nutrient logs yet. Add your first entry!</p>';
                        return;
                    }

                    container.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--bg-light); border-bottom: 2px solid var(--primary-green);">
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Nutrient Name</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Amount</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Unit</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Date</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">User ID</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${nutrients.map(nutrient => `
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 12px;">${nutrient.nutrient_name}</td>
                                        <td style="padding: 12px; text-align: center;">${nutrient.amount}</td>
                                        <td style="padding: 12px; text-align: center;">${nutrient.unit}</td>
                                        <td style="padding: 12px; text-align: center;">${new Date(nutrient.date_tracked).toLocaleDateString()}</td>
                                        <td style="padding: 12px; text-align: center;">${nutrient.user_id}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p style="color: red; text-align: center;">Failed to load nutrients data</p>';
                }
            } catch (error) {
                console.error('Error loading nutrients:', error);
                container.innerHTML = '<p style="color: red; text-align: center;">Network error loading nutrients</p>';
            }
        }

        async function addNutrient() {
            const nutrientData = {
                nutrient_name: document.getElementById('nutrient-name').value,
                amount: parseFloat(document.getElementById('nutrient-amount').value),
                unit: document.getElementById('nutrient-unit').value,
                date_tracked: document.getElementById('nutrient-date').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/nutrients`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(nutrientData)
                });

                if (response.ok) {
                    showMessage('Nutrient logged successfully!', 'success');
                    document.getElementById('add-nutrient-form').reset();
                    document.getElementById('nutrient-date').valueAsDate = new Date();
                    loadNutrientsData();
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to log nutrient', 'error');
                }
            } catch (error) {
                console.error('Error logging nutrient:', error);
                showMessage('Network error logging nutrient', 'error');
            }
        }

        function downloadNutrientsTemplate() {
            // Create CSV content with headers and sample data
            const headers = ['nutrient_name', 'amount', 'unit', 'date_tracked', 'notes'];
            const sampleData = [
                ['Vitamin C', '1000', 'mg', '2025-11-13', 'Daily supplement'],
                ['Vitamin D', '2000', 'IU', '2025-11-13', 'Morning dose'],
                ['Calcium', '500', 'mg', '2025-11-13', 'With breakfast'],
                ['Iron', '18', 'mg', '2025-11-14', 'Multivitamin'],
                ['Omega-3', '1000', 'mg', '2025-11-14', 'Fish oil capsule']
            ];

            // Build CSV content
            let csvContent = headers.join(',') + '\n';
            sampleData.forEach(row => {
                const escapedRow = row.map(field => {
                    if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                        return `"${field.replace(/"/g, '""')}"`;
                    }
                    return field;
                });
                csvContent += escapedRow.join(',') + '\n';
            });

            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'nutrients_bulk_import_template.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('‚úÖ Nutrients template downloaded successfully!', 'success');
        }

        async function uploadNutrientsFile() {
            const fileInput = document.getElementById('nutrients-file-upload');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('Please select a file first', 'error');
                return;
            }

            showMessage('File upload feature will be implemented with backend support for CSV/Excel parsing', 'error');
            // TODO: Implement file upload endpoint in backend
        }

        async function addIngredientNutrition() {
            const ingredientData = {
                ingredient_name: document.getElementById('ingredient-name').value,
                serving_size: document.getElementById('serving-size').value || '100g',
                calories: parseFloat(document.getElementById('calories').value) || 0,
                protein: parseFloat(document.getElementById('protein').value) || 0,
                carbohydrates: parseFloat(document.getElementById('carbohydrates').value) || 0,
                fat: parseFloat(document.getElementById('fat').value) || 0,
                fiber: parseFloat(document.getElementById('fiber').value) || 0,
                sugar: parseFloat(document.getElementById('sugar').value) || 0,
                sodium: parseFloat(document.getElementById('sodium').value) || 0,
                cholesterol: parseFloat(document.getElementById('cholesterol').value) || 0,
                vitamin_a: parseFloat(document.getElementById('vitamin-a').value) || 0,
                vitamin_c: parseFloat(document.getElementById('vitamin-c').value) || 0,
                vitamin_d: parseFloat(document.getElementById('vitamin-d').value) || 0,
                calcium: parseFloat(document.getElementById('calcium').value) || 0,
                iron: parseFloat(document.getElementById('iron').value) || 0,
                potassium: parseFloat(document.getElementById('potassium').value) || 0,
                notes: document.getElementById('ingredient-notes').value || null
            };

            try {
                const response = await fetch(`${API_BASE_URL}/ingredient-nutrition`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(ingredientData)
                });

                if (response.ok) {
                    showMessage('Ingredient nutrition added successfully!', 'success');
                    document.getElementById('add-ingredient-nutrition-form').reset();
                    document.getElementById('serving-size').value = '100g';
                    loadIngredientNutritionData();
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to add ingredient nutrition', 'error');
                }
            } catch (error) {
                console.error('Error adding ingredient nutrition:', error);
                showMessage('Network error', 'error');
            }
        }

        async function loadIngredientNutritionData() {
            const container = document.getElementById('ingredient-nutrition-table-container');
            container.innerHTML = '<p style="text-align: center; color: var(--text-light);">Loading...</p>';
            
            // Always get fresh token from localStorage
            const token = localStorage.getItem('authToken');
            if (!token) {
                container.innerHTML = '<p style="color: red; text-align: center;">Session expired. Please login again.</p>';
                logout();
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/ingredient-nutrition`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const ingredients = await response.json();
                    
                    if (ingredients.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No ingredient data yet. Add your first ingredient!</p>';
                        return;
                    }

                    container.innerHTML = `
                        <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: var(--bg-light); border-bottom: 2px solid var(--primary-green);">
                                    <th style="padding: 10px; text-align: left; font-weight: 600;">Ingredient</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">Serving</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">Calories</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">Protein</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">Carbs</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">Fat</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600; width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${ingredients.map(ing => `
                                    <tr style="border-bottom: 1px solid var(--border-color);" id="ingredient-row-${ing.id}">
                                        <td style="padding: 10px; font-weight: 500;">${ing.ingredient_name}</td>
                                        <td style="padding: 10px; text-align: center;">${ing.serving_size || '-'}</td>
                                        <td style="padding: 10px; text-align: center;">${ing.energy_kcal || 0}</td>
                                        <td style="padding: 10px; text-align: center;">${ing.protein_g || 0}g</td>
                                        <td style="padding: 10px; text-align: center;">${ing.carb_g || 0}g</td>
                                        <td style="padding: 10px; text-align: center;">${ing.fat_g || 0}g</td>
                                        <td style="padding: 10px; text-align: center;">
                                            <button onclick="viewIngredientNutrition(${ing.id})" style="padding: 4px 8px; background: #0dcaf0; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 4px;">View</button>
                                            <button onclick="deleteIngredientNutrition(${ing.id}, '${ing.ingredient_name}')" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        </div>
                    `;
                } else {
                    const errorText = await response.text();
                    console.error('API Error Response:', response.status, errorText);
                    container.innerHTML = `<p style="color: red; text-align: center;">Failed to load data (Status: ${response.status})<br><small>${errorText.substring(0, 100)}</small></p>`;
                }
            } catch (error) {
                console.error('Error loading ingredient nutrition:', error);
                container.innerHTML = `<p style="color: red; text-align: center;">Network error: ${error.message}<br><small>Check console for details</small></p>`;
            }
        }

        async function editIngredientNutrition(ingredientId) {
            try {
                const response = await fetch(`${API_BASE_URL}/ingredient-nutrition`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) {
                    showMessage('Failed to load ingredient data', 'error');
                    return;
                }
                
                const ingredients = await response.json();
                const ingredient = ingredients.find(ing => ing.id === ingredientId);
                
                if (!ingredient) {
                    showMessage('Ingredient not found', 'error');
                    return;
                }

                // Populate form
                document.getElementById('ingredient-name').value = ingredient.ingredient_name || '';
                document.getElementById('serving-size').value = ingredient.serving_size || '100g';
                document.getElementById('calories').value = ingredient.calories || 0;
                document.getElementById('protein').value = ingredient.protein || 0;
                document.getElementById('carbohydrates').value = ingredient.carbohydrates || 0;
                document.getElementById('fat').value = ingredient.fat || 0;
                document.getElementById('fiber').value = ingredient.fiber || 0;
                document.getElementById('sugar').value = ingredient.sugar || 0;
                document.getElementById('sodium').value = ingredient.sodium || 0;
                document.getElementById('cholesterol').value = ingredient.cholesterol || 0;
                document.getElementById('vitamin-a').value = ingredient.vitamin_a || 0;
                document.getElementById('vitamin-c').value = ingredient.vitamin_c || 0;
                document.getElementById('vitamin-d').value = ingredient.vitamin_d || 0;
                document.getElementById('calcium').value = ingredient.calcium || 0;
                document.getElementById('iron').value = ingredient.iron || 0;
                document.getElementById('potassium').value = ingredient.potassium || 0;
                document.getElementById('ingredient-notes').value = ingredient.notes || '';

                // Change button to update mode
                const form = document.getElementById('add-ingredient-nutrition-form');
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.textContent = '‚úèÔ∏è Update Ingredient';
                submitButton.style.background = 'linear-gradient(135deg, #ff9800 0%, #fb8c00 100%)';
                
                // Store ingredient ID for update
                form.dataset.editingIngredientId = ingredientId;
                
                // Update form onsubmit
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    if (form.dataset.editingIngredientId) {
                        await updateIngredientNutrition(form.dataset.editingIngredientId);
                    } else {
                        await addIngredientNutrition();
                    }
                };

                // Add cancel button
                let cancelBtn = form.querySelector('.cancel-edit-btn');
                if (!cancelBtn) {
                    cancelBtn = document.createElement('button');
                    cancelBtn.type = 'button';
                    cancelBtn.className = 'cancel-edit-btn';
                    cancelBtn.textContent = '‚úñ Cancel Edit';
                    cancelBtn.style.cssText = 'width: 100%; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 10px;';
                    cancelBtn.onclick = cancelIngredientEdit;
                    submitButton.parentElement.appendChild(cancelBtn);
                }

                showMessage('Editing ingredient - modify fields and click Update', 'success');
            } catch (error) {
                console.error('Error loading ingredient for edit:', error);
                showMessage('Network error', 'error');
            }
        }

        function cancelIngredientEdit() {
            const form = document.getElementById('add-ingredient-nutrition-form');
            delete form.dataset.editingIngredientId;
            
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.textContent = '‚ûï Add Ingredient';
            submitButton.style.background = 'linear-gradient(135deg, var(--primary-green) 0%, #27ae60 100%)';
            
            const cancelBtn = form.querySelector('.cancel-edit-btn');
            if (cancelBtn) cancelBtn.remove();
            
            form.reset();
            document.getElementById('serving-size').value = '100g';
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                await addIngredientNutrition();
            };
        }

        async function viewIngredientNutrition(ingredientId) {
            try {
                const response = await fetch(`${API_BASE_URL}/ingredient-nutrition`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) {
                    showMessage('Failed to load ingredient details', 'error');
                    return;
                }
                
                const ingredients = await response.json();
                const ing = ingredients.find(i => i.id === ingredientId);
                
                if (!ing) {
                    showMessage('Ingredient not found', 'error');
                    return;
                }
                
                const viewHTML = `
                    <div id="ingredient-detail-view" style="max-height: 70vh; overflow-y: auto; padding: 20px;">
                        <!-- Read-Only View -->
                        <div id="view-mode">
                            <h3 style="color: var(--primary-green); margin-top: 0;">${ing.ingredient_name || 'Unknown'}</h3>
                            
                            ${ing.main_category ? `<p><strong>Category:</strong> ${ing.main_category}${ing.sub_category ? ' ‚Üí ' + ing.sub_category : ''}</p>` : ''}
                            ${ing.state ? `<p><strong>State:</strong> ${ing.state}</p>` : ''}
                            <p><strong>Serving Size:</strong> ${ing.serving_size || '100g'}</p>
                            ${ing.unique_id ? `<p style="font-size: 12px; color: #666;"><strong>ID:</strong> ${ing.unique_id}</p>` : ''}
                            
                            <hr style="margin: 15px 0; border: 1px solid #e0e0e0;">
                            <h4 style="color: var(--primary-green);">Macronutrients</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Energy:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.energy_kcal || 0).toFixed(1)} kcal</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Protein:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.protein_g || 0).toFixed(1)}g</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Carbohydrates:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.carb_g || 0).toFixed(1)}g</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Fat:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.fat_g || 0).toFixed(1)}g</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Fiber:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.fiber_g || 0).toFixed(1)}g</strong></td></tr>
                                <tr><td style="padding: 5px 0;">Sugar:</td><td style="padding: 5px 0; text-align: right;"><strong>${(ing.sugar_g || 0).toFixed(1)}g</strong></td></tr>
                            </table>
                            
                            <hr style="margin: 15px 0; border: 1px solid #e0e0e0;">
                            <h4 style="color: var(--primary-green);">Minerals</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Calcium:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.calcium_mg || 0).toFixed(1)}mg</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Iron:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.iron_mg || 0).toFixed(1)}mg</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Zinc:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.zinc_mg || 0).toFixed(2)}mg</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Magnesium:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.magnesium_mg || 0).toFixed(1)}mg</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Potassium:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.potassium_mg || 0).toFixed(1)}mg</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Sodium:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.sodium_mg || 0).toFixed(1)}mg</strong></td></tr>
                                <tr><td style="padding: 5px 0;">Cholesterol:</td><td style="padding: 5px 0; text-align: right;"><strong>${(ing.cholesterol_mg || 0).toFixed(1)}mg</strong></td></tr>
                            </table>
                            
                            <hr style="margin: 15px 0; border: 1px solid #e0e0e0;">
                            <h4 style="color: var(--primary-green);">Vitamins</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Vitamin A:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.vitamin_a_mcg || 0).toFixed(1)}¬µg</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Vitamin C:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.vitamin_c_mg || 0).toFixed(1)}mg</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Vitamin D:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.vitamin_d_mcg || 0).toFixed(1)}¬µg</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Vitamin E:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.vitamin_e_mg || 0).toFixed(2)}mg</strong></td></tr>
                                <tr><td style="padding: 5px 0;">Vitamin K:</td><td style="padding: 5px 0; text-align: right;"><strong>${(ing.vitamin_k_mcg || 0).toFixed(1)}¬µg</strong></td></tr>
                            </table>
                            
                            <hr style="margin: 15px 0; border: 1px solid #e0e0e0;">
                            <h4 style="color: var(--primary-green);">B Vitamin Complex</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Vitamin B1 (Thiamine):</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.vitamin_b1_mg || 0).toFixed(3)}mg</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Vitamin B2 (Riboflavin):</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.vitamin_b2_mg || 0).toFixed(3)}mg</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Vitamin B3 (Niacin):</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.vitamin_b3_mg || 0).toFixed(2)}mg</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Vitamin B5 (Pantothenic Acid):</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.vitamin_b5_mg || 0).toFixed(3)}mg</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Vitamin B6:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.vitamin_b6_mg || 0).toFixed(3)}mg</strong></td></tr>
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Vitamin B9 (Folate):</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.vitamin_b9_mcg || 0).toFixed(1)}¬µg</strong></td></tr>
                                <tr><td style="padding: 5px 0;">Vitamin B12:</td><td style="padding: 5px 0; text-align: right;"><strong>${(ing.vitamin_b12_mcg || 0).toFixed(2)}¬µg</strong></td></tr>
                            </table>
                            
                            <hr style="margin: 15px 0; border: 1px solid #e0e0e0;">
                            <h4 style="color: var(--primary-green);">Essential Fatty Acids</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">Omega-3:</td><td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;"><strong>${(ing.omega3_g || 0).toFixed(3)}g</strong></td></tr>
                                <tr><td style="padding: 5px 0;">Omega-6:</td><td style="padding: 5px 0; text-align: right;"><strong>${(ing.omega6_g || 0).toFixed(3)}g</strong></td></tr>
                            </table>
                            
                            ${ing.health_benefits ? `<hr style="margin: 15px 0; border: 1px solid #e0e0e0;"><h4 style="color: var(--primary-green);">Health Benefits</h4><p style="background: #f8f9fa; padding: 10px; border-radius: 5px;">${ing.health_benefits}</p>` : ''}
                            ${ing.phytochemicals ? `<hr style="margin: 15px 0; border: 1px solid #e0e0e0;"><h4 style="color: var(--primary-green);">Phytochemicals</h4><p style="background: #f8f9fa; padding: 10px; border-radius: 5px;">${ing.phytochemicals}</p>` : ''}
                            ${ing.source_notes ? `<hr style="margin: 15px 0; border: 1px solid #e0e0e0;"><h4 style="color: var(--primary-green);">Source Notes</h4><p style="font-size: 13px; background: #f8f9fa; padding: 10px; border-radius: 5px;">${ing.source_notes}</p>` : ''}
                            ${ing.reference_primary ? `<hr style="margin: 15px 0; border: 1px solid #e0e0e0;"><h4 style="color: var(--primary-green);">Reference</h4><p style="font-size: 12px; color: #666; background: #f8f9fa; padding: 10px; border-radius: 5px;">${ing.reference_primary}</p>` : ''}
                            
                            <div style="margin-top: 20px;">
                                <button type="button" onclick="toggleEditMode(${ingredientId})" style="width: 10%; padding: 6px 12px; background: #D2691E; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 13px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: background 0.2s;" onmouseover="this.style.background='#C1591D'" onmouseout="this.style.background='#D2691E'">
                                    Edit
                                </button>
                            </div>
                        </div>
                        
                        <!-- Edit Mode (Hidden by default) -->
                        <div id="edit-mode" style="display: none;">
                            <form id="edit-ingredient-form" onsubmit="event.preventDefault(); saveIngredientChanges(${ingredientId});">
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: var(--primary-green);">Ingredient Name</label>
                                    <input type="text" id="edit-ingredient-name" value="${ing.ingredient_name || ''}" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; font-weight: 600;">
                                </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Category</label>
                                    <input type="text" id="edit-main-category" value="${ing.main_category || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Sub-Category</label>
                                    <input type="text" id="edit-sub-category" value="${ing.sub_category || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Serving Size</label>
                                    <input type="text" id="edit-serving-size" value="${ing.serving_size || '100g'}" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">State</label>
                                    <input type="text" id="edit-state" value="${ing.state || ''}" placeholder="raw, cooked, etc." style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                            </div>
                            
                            <hr style="margin: 20px 0; border: 1px solid #e0e0e0;">
                            <h4 style="color: var(--primary-green); margin-bottom: 15px;">Macronutrients</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Energy (kcal)</label>
                                    <input type="number" id="edit-energy-kcal" value="${ing.energy_kcal || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Protein (g)</label>
                                    <input type="number" id="edit-protein-g" value="${ing.protein_g || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Carbohydrates (g)</label>
                                    <input type="number" id="edit-carb-g" value="${ing.carb_g || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Fat (g)</label>
                                    <input type="number" id="edit-fat-g" value="${ing.fat_g || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Fiber (g)</label>
                                    <input type="number" id="edit-fiber-g" value="${ing.fiber_g || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Sugar (g)</label>
                                    <input type="number" id="edit-sugar-g" value="${ing.sugar_g || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                            </div>
                            
                            <hr style="margin: 20px 0; border: 1px solid #e0e0e0;">
                            <h4 style="color: var(--primary-green); margin-bottom: 15px;">Minerals</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Calcium (mg)</label>
                                    <input type="number" id="edit-calcium-mg" value="${ing.calcium_mg || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Iron (mg)</label>
                                    <input type="number" id="edit-iron-mg" value="${ing.iron_mg || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Zinc (mg)</label>
                                    <input type="number" id="edit-zinc-mg" value="${ing.zinc_mg || 0}" step="0.01" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Magnesium (mg)</label>
                                    <input type="number" id="edit-magnesium-mg" value="${ing.magnesium_mg || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Potassium (mg)</label>
                                    <input type="number" id="edit-potassium-mg" value="${ing.potassium_mg || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Sodium (mg)</label>
                                    <input type="number" id="edit-sodium-mg" value="${ing.sodium_mg || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Cholesterol (mg)</label>
                                    <input type="number" id="edit-cholesterol-mg" value="${ing.cholesterol_mg || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                            </div>
                            
                            <hr style="margin: 20px 0; border: 1px solid #e0e0e0;">
                            <h4 style="color: var(--primary-green); margin-bottom: 15px;">Vitamins</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Vitamin A (¬µg)</label>
                                    <input type="number" id="edit-vitamin-a-mcg" value="${ing.vitamin_a_mcg || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Vitamin C (mg)</label>
                                    <input type="number" id="edit-vitamin-c-mg" value="${ing.vitamin_c_mg || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Vitamin D (¬µg)</label>
                                    <input type="number" id="edit-vitamin-d-mcg" value="${ing.vitamin_d_mcg || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Vitamin E (mg)</label>
                                    <input type="number" id="edit-vitamin-e-mg" value="${ing.vitamin_e_mg || 0}" step="0.01" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Vitamin K (¬µg)</label>
                                    <input type="number" id="edit-vitamin-k-mcg" value="${ing.vitamin_k_mcg || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                            </div>
                            
                            <hr style="margin: 20px 0; border: 1px solid #e0e0e0;">
                            <h4 style="color: var(--primary-green); margin-bottom: 15px;">B Vitamin Complex</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">B1 Thiamine (mg)</label>
                                    <input type="number" id="edit-vitamin-b1-mg" value="${ing.vitamin_b1_mg || 0}" step="0.001" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">B2 Riboflavin (mg)</label>
                                    <input type="number" id="edit-vitamin-b2-mg" value="${ing.vitamin_b2_mg || 0}" step="0.001" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">B3 Niacin (mg)</label>
                                    <input type="number" id="edit-vitamin-b3-mg" value="${ing.vitamin_b3_mg || 0}" step="0.01" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">B5 Pantothenic Acid (mg)</label>
                                    <input type="number" id="edit-vitamin-b5-mg" value="${ing.vitamin_b5_mg || 0}" step="0.001" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">B6 (mg)</label>
                                    <input type="number" id="edit-vitamin-b6-mg" value="${ing.vitamin_b6_mg || 0}" step="0.001" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">B9 Folate (¬µg)</label>
                                    <input type="number" id="edit-vitamin-b9-mcg" value="${ing.vitamin_b9_mcg || 0}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">B12 (¬µg)</label>
                                    <input type="number" id="edit-vitamin-b12-mcg" value="${ing.vitamin_b12_mcg || 0}" step="0.01" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                            </div>
                            
                            <hr style="margin: 20px 0; border: 1px solid #e0e0e0;">
                            <h4 style="color: var(--primary-green); margin-bottom: 15px;">Essential Fatty Acids</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Omega-3 (g)</label>
                                    <input type="number" id="edit-omega3-g" value="${ing.omega3_g || 0}" step="0.001" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Omega-6 (g)</label>
                                    <input type="number" id="edit-omega6-g" value="${ing.omega6_g || 0}" step="0.001" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                            </div>
                            
                            <hr style="margin: 20px 0; border: 1px solid #e0e0e0;">
                            <h4 style="color: var(--primary-green); margin-bottom: 15px;">Additional Information</h4>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Health Benefits</label>
                                <textarea id="edit-health-benefits" rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit;">${ing.health_benefits || ''}</textarea>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Phytochemicals</label>
                                <textarea id="edit-phytochemicals" rows="2" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit;">${ing.phytochemicals || ''}</textarea>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Source Notes</label>
                                <textarea id="edit-source-notes" rows="2" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit;">${ing.source_notes || ''}</textarea>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Reference</label>
                                <textarea id="edit-reference-primary" rows="2" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit;">${ing.reference_primary || ''}</textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <button type="submit" style="width: 100%; padding: 12px; background: linear-gradient(135deg, var(--primary-green) 0%, #27ae60 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 16px;">
                                    üíæ Save Changes
                                </button>
                                <button type="button" onclick="cancelEdit(${ingredientId})" style="width: 100%; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 16px;">
                                    ‚úñ Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                showLargeModal(`Edit Ingredient: ${ing.ingredient_name}`, viewHTML);
            } catch (error) {
                console.error('Error loading ingredient details:', error);
                showMessage('Network error loading ingredient', 'error');
            }
        }

        async function saveIngredientChanges(ingredientId) {
            const ingredientData = {
                ingredient_name: document.getElementById('edit-ingredient-name').value,
                main_category: document.getElementById('edit-main-category').value || null,
                sub_category: document.getElementById('edit-sub-category').value || null,
                serving_size: document.getElementById('edit-serving-size').value || '100g',
                state: document.getElementById('edit-state').value || null,
                
                // Macronutrients
                energy_kcal: parseFloat(document.getElementById('edit-energy-kcal').value) || 0,
                protein_g: parseFloat(document.getElementById('edit-protein-g').value) || 0,
                carb_g: parseFloat(document.getElementById('edit-carb-g').value) || 0,
                fat_g: parseFloat(document.getElementById('edit-fat-g').value) || 0,
                fiber_g: parseFloat(document.getElementById('edit-fiber-g').value) || 0,
                sugar_g: parseFloat(document.getElementById('edit-sugar-g').value) || 0,
                
                // Minerals
                calcium_mg: parseFloat(document.getElementById('edit-calcium-mg').value) || 0,
                iron_mg: parseFloat(document.getElementById('edit-iron-mg').value) || 0,
                zinc_mg: parseFloat(document.getElementById('edit-zinc-mg').value) || 0,
                magnesium_mg: parseFloat(document.getElementById('edit-magnesium-mg').value) || 0,
                potassium_mg: parseFloat(document.getElementById('edit-potassium-mg').value) || 0,
                sodium_mg: parseFloat(document.getElementById('edit-sodium-mg').value) || 0,
                cholesterol_mg: parseFloat(document.getElementById('edit-cholesterol-mg').value) || 0,
                
                // Vitamins
                vitamin_a_mcg: parseFloat(document.getElementById('edit-vitamin-a-mcg').value) || 0,
                vitamin_c_mg: parseFloat(document.getElementById('edit-vitamin-c-mg').value) || 0,
                vitamin_d_mcg: parseFloat(document.getElementById('edit-vitamin-d-mcg').value) || 0,
                vitamin_e_mg: parseFloat(document.getElementById('edit-vitamin-e-mg').value) || 0,
                vitamin_k_mcg: parseFloat(document.getElementById('edit-vitamin-k-mcg').value) || 0,
                
                // B Vitamins
                vitamin_b1_mg: parseFloat(document.getElementById('edit-vitamin-b1-mg').value) || 0,
                vitamin_b2_mg: parseFloat(document.getElementById('edit-vitamin-b2-mg').value) || 0,
                vitamin_b3_mg: parseFloat(document.getElementById('edit-vitamin-b3-mg').value) || 0,
                vitamin_b5_mg: parseFloat(document.getElementById('edit-vitamin-b5-mg').value) || 0,
                vitamin_b6_mg: parseFloat(document.getElementById('edit-vitamin-b6-mg').value) || 0,
                vitamin_b9_mcg: parseFloat(document.getElementById('edit-vitamin-b9-mcg').value) || 0,
                vitamin_b12_mcg: parseFloat(document.getElementById('edit-vitamin-b12-mcg').value) || 0,
                
                // Fatty Acids
                omega3_g: parseFloat(document.getElementById('edit-omega3-g').value) || 0,
                omega6_g: parseFloat(document.getElementById('edit-omega6-g').value) || 0,
                
                // Additional Info
                health_benefits: document.getElementById('edit-health-benefits').value || null,
                phytochemicals: document.getElementById('edit-phytochemicals').value || null,
                source_notes: document.getElementById('edit-source-notes').value || null,
                reference_primary: document.getElementById('edit-reference-primary').value || null
            };

            try {
                const response = await fetch(`${API_BASE_URL}/ingredient-nutrition/${ingredientId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(ingredientData)
                });

                if (response.ok) {
                    showMessage('‚úÖ Ingredient updated successfully!', 'success');
                    closeModal();
                    loadIngredientNutritionData();
                    // Re-open in view mode to show updated data
                    setTimeout(() => viewIngredientNutrition(ingredientId), 300);
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to update ingredient', 'error');
                }
            } catch (error) {
                console.error('Error updating ingredient:', error);
                showMessage('Network error while updating', 'error');
            }
        }

        function cancelEdit(ingredientId) {
            closeModal();
            // Re-open in view mode
            setTimeout(() => viewIngredientNutrition(ingredientId), 300);
        }

        function toggleEditMode(ingredientId) {
            const viewMode = document.getElementById('view-mode');
            const editMode = document.getElementById('edit-mode');
            const modalTitle = document.querySelector('#custom-modal h2');
            
            if (editMode.style.display === 'none') {
                // Switch to edit mode
                viewMode.style.display = 'none';
                editMode.style.display = 'block';
                if (modalTitle) {
                    const ingredientName = document.getElementById('edit-ingredient-name').value;
                    modalTitle.textContent = `Edit Ingredient: ${ingredientName}`;
                }
            } else {
                // Switch to view mode
                viewMode.style.display = 'block';
                editMode.style.display = 'none';
                if (modalTitle) {
                    const ingredientName = document.getElementById('edit-ingredient-name').value;
                    modalTitle.textContent = `Ingredient Details: ${ingredientName}`;
                }
            }
        }

        async function updateIngredientNutrition(ingredientId) {
            const ingredientData = {
                ingredient_name: document.getElementById('ingredient-name').value,
                serving_size: document.getElementById('serving-size').value || '100g',
                calories: parseFloat(document.getElementById('calories').value) || 0,
                protein: parseFloat(document.getElementById('protein').value) || 0,
                carbohydrates: parseFloat(document.getElementById('carbohydrates').value) || 0,
                fat: parseFloat(document.getElementById('fat').value) || 0,
                fiber: parseFloat(document.getElementById('fiber').value) || 0,
                sugar: parseFloat(document.getElementById('sugar').value) || 0,
                sodium: parseFloat(document.getElementById('sodium').value) || 0,
                cholesterol: parseFloat(document.getElementById('cholesterol').value) || 0,
                vitamin_a: parseFloat(document.getElementById('vitamin-a').value) || 0,
                vitamin_c: parseFloat(document.getElementById('vitamin-c').value) || 0,
                vitamin_d: parseFloat(document.getElementById('vitamin-d').value) || 0,
                calcium: parseFloat(document.getElementById('calcium').value) || 0,
                iron: parseFloat(document.getElementById('iron').value) || 0,
                potassium: parseFloat(document.getElementById('potassium').value) || 0,
                notes: document.getElementById('ingredient-notes').value || null
            };

            try {
                const response = await fetch(`${API_BASE_URL}/ingredient-nutrition/${ingredientId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(ingredientData)
                });

                if (response.ok) {
                    showMessage('Ingredient nutrition updated successfully!', 'success');
                    cancelIngredientEdit();
                    loadIngredientNutritionData();
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to update ingredient nutrition', 'error');
                }
            } catch (error) {
                console.error('Error updating ingredient nutrition:', error);
                showMessage('Network error', 'error');
            }
        }

        async function deleteIngredientNutrition(ingredientId, ingredientName) {
            if (!confirm(`Are you sure you want to delete nutritional data for "${ingredientName}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/ingredient-nutrition/${ingredientId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (response.ok) {
                    showMessage(`Ingredient "${ingredientName}" deleted successfully!`, 'success');
                    loadIngredientNutritionData();
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to delete ingredient', 'error');
                }
            } catch (error) {
                console.error('Error deleting ingredient:', error);
                showMessage('Network error', 'error');
            }
        }

        async function uploadIngredientNutritionFile() {
            const fileInput = document.getElementById('ingredient-nutrition-file-upload');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('Please select a file first', 'error');
                return;
            }

            showMessage('File upload feature will be implemented with backend support for CSV/Excel parsing', 'error');
            // TODO: Implement file upload endpoint in backend
        }

        function downloadIngredientNutritionTemplate() {
            // Create CSV content with headers and sample data
            const headers = [
                'ingredient_name', 'serving_size', 'energy_kcal', 'protein_g', 'carb_g', 'fat_g', 
                'fiber_g', 'sugar_g', 'sodium_mg', 'cholesterol_mg', 'calcium_mg', 'iron_mg', 
                'potassium_mg', 'vitamin_a_mcg', 'vitamin_c_mg', 'vitamin_d_mcg'
            ];
            const sampleData = [
                ['Chicken Breast', '100g', '165', '31', '0', '3.6', '0', '0', '74', '85', '15', '1.04', '256', '21', '0', '0.1'],
                ['Brown Rice', '100g', '111', '2.6', '23', '0.9', '1.8', '0.4', '5', '0', '10', '0.4', '43', '0', '0', '0'],
                ['Broccoli', '100g', '34', '2.8', '7', '0.4', '2.6', '1.7', '33', '0', '47', '0.7', '316', '31', '89.2', '0'],
                ['Salmon', '100g', '208', '20', '0', '13', '0', '0', '59', '63', '12', '0.8', '363', '12', '0', '11'],
                ['Almonds', '100g', '579', '21', '22', '50', '12.5', '4.4', '1', '0', '269', '3.7', '733', '0', '0', '0'],
                ['Lettuce', '100g', '15', '1.4', '2.9', '0.2', '1.3', '0.8', '28', '0', '36', '0.9', '194', '370', '9.2', '0'],
                ['Tomatoes', '100g', '18', '0.9', '3.9', '0.2', '1.2', '2.6', '5', '0', '10', '0.3', '237', '42', '13.7', '0'],
                ['Carrots', '100g', '41', '0.9', '9.6', '0.2', '2.8', '4.7', '69', '0', '33', '0.3', '320', '835', '5.9', '0'],
                ['Olive Oil', '1 tbsp', '119', '0', '0', '13.5', '0', '0', '0', '0', '0', '0.1', '0', '0', '0', '0'],
                ['Eggs', '100g', '155', '13', '1.1', '11', '0', '1.1', '124', '373', '56', '1.8', '138', '160', '0', '2'],
                ['Spinach', '100g', '23', '2.9', '3.6', '0.4', '2.2', '0.4', '79', '0', '99', '2.7', '558', '469', '28.1', '0'],
                ['Banana', '100g', '89', '1.1', '22.8', '0.3', '2.6', '12.2', '1', '0', '5', '0.3', '358', '3', '8.7', '0'],
                ['Apple', '100g', '52', '0.3', '13.8', '0.2', '2.4', '10.4', '1', '0', '6', '0.1', '107', '3', '4.6', '0'],
                ['Greek Yogurt', '100g', '59', '10', '3.6', '0.4', '0', '3.6', '36', '5', '110', '0.1', '141', '2', '0.8', '0'],
                ['Sweet Potato', '100g', '86', '1.6', '20.1', '0.1', '3', '4.2', '55', '0', '30', '0.6', '337', '709', '2.4', '0']
            ];

            // Build CSV content
            let csvContent = headers.join(',') + '\n';
            sampleData.forEach(row => {
                const escapedRow = row.map(field => {
                    if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                        return `"${field.replace(/"/g, '""')}"`;
                    }
                    return field;
                });
                csvContent += escapedRow.join(',') + '\n';
            });

            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'ingredient_nutrition_bulk_import_template.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('‚úÖ Ingredient nutrition template downloaded successfully! (53+ ingredients in database)', 'success');
        }

        // ============================================================================
        // SUBSCRIPTION PLANS & FEATURES MODULE
        // ============================================================================
        
        let currentSubscriptionView = 'plans'; // 'plans', 'features', or 'subscriptions'
        let userCurrency = { code: 'USD', symbol: '$', rate: 1 }; // Default currency
        
        // Currency mapping based on geolocation
        const currencyMap = {
            'US': { code: 'USD', symbol: '$', rate: 1 },
            'GB': { code: 'GBP', symbol: '¬£', rate: 0.79 },
            'EU': { code: 'EUR', symbol: '‚Ç¨', rate: 0.92 },
            'CA': { code: 'CAD', symbol: 'C$', rate: 1.35 },
            'AU': { code: 'AUD', symbol: 'A$', rate: 1.52 },
            'IN': { code: 'INR', symbol: '‚Çπ', rate: 83.12 },
            'NG': { code: 'NGN', symbol: '‚Ç¶', rate: 1520 },
            'KE': { code: 'KES', symbol: 'KSh', rate: 150 },
            'ZA': { code: 'ZAR', symbol: 'R', rate: 18.5 },
            'BR': { code: 'BRL', symbol: 'R$', rate: 4.97 },
            'MX': { code: 'MXN', symbol: 'Mex$', rate: 17.1 },
            'JP': { code: 'JPY', symbol: '¬•', rate: 149.5 },
            'CN': { code: 'CNY', symbol: '¬•', rate: 7.24 },
            'SG': { code: 'SGD', symbol: 'S$', rate: 1.34 },
            'CM': { code: 'XAF', symbol: 'FCFA', rate: 615, suffixSymbol: true }, // Cameroon
            'CF': { code: 'XAF', symbol: 'FCFA', rate: 615, suffixSymbol: true }, // Central African Republic
            'TD': { code: 'XAF', symbol: 'FCFA', rate: 615, suffixSymbol: true }, // Chad
            'CG': { code: 'XAF', symbol: 'FCFA', rate: 615, suffixSymbol: true }, // Republic of Congo
            'GA': { code: 'XAF', symbol: 'FCFA', rate: 615, suffixSymbol: true }, // Gabon
            'GQ': { code: 'XAF', symbol: 'FCFA', rate: 615, suffixSymbol: true }  // Equatorial Guinea
        };
        
        // Detect user currency based on geolocation
        async function detectUserCurrency() {
            try {
                // Try to get geolocation from IP
                const response = await fetch('https://ipapi.co/json/');
                if (response.ok) {
                    const data = await response.json();
                    const countryCode = data.country_code;
                    
                    // Check if we have currency mapping for this country
                    if (currencyMap[countryCode]) {
                        userCurrency = currencyMap[countryCode];
                    } else if (data.currency) {
                        // Use API's currency info as fallback
                        userCurrency = {
                            code: data.currency,
                            symbol: getCurrencySymbol(data.currency),
                            rate: 1 // Will need manual rate update
                        };
                    }
                    
                    console.log('Detected currency:', userCurrency.code, 'for country:', countryCode);
                    return userCurrency;
                }
            } catch (error) {
                console.log('Could not detect location, using USD:', error);
            }
            return userCurrency; // Return default USD
        }
        
        // Get currency symbol from code
        function getCurrencySymbol(code) {
            const symbols = {
                'USD': '$', 'GBP': '¬£', 'EUR': '‚Ç¨', 'CAD': 'C$', 'AUD': 'A$',
                'INR': '‚Çπ', 'NGN': '‚Ç¶', 'KES': 'KSh', 'ZAR': 'R', 'BRL': 'R$',
                'MXN': 'Mex$', 'JPY': '¬•', 'CNY': '¬•', 'SGD': 'S$', 'XAF': 'FCFA'
            };
            return symbols[code] || code;
        }
        
        // Format price with user's currency
        function formatPrice(usdPrice) {
            // Use cached real-time rate for XAF if available
            let rate = userCurrency.rate;
            if (userCurrency.code === 'XAF' && xafRateCache.timestamp) {
                rate = xafRateCache.rate;
            }
            
            const convertedPrice = usdPrice * rate;
            
            // Format based on currency
            if (userCurrency.code === 'XAF') {
                // XAF: no decimals, symbol after amount
                return `${Math.round(convertedPrice).toLocaleString()} ${userCurrency.symbol}`;
            } else if (userCurrency.code === 'JPY' || userCurrency.code === 'KRW') {
                // JPY/KRW: no decimals, symbol before
                return `${userCurrency.symbol}${Math.round(convertedPrice).toLocaleString()}`;
            } else {
                // Default: 2 decimals, symbol before
                return `${userCurrency.symbol}${convertedPrice.toFixed(2)}`;
            }
        }
        
        // Show currency selector
        function showCurrencySelector() {
            const currencies = Object.entries(currencyMap).map(([country, curr]) => 
                `<option value="${curr.code}" ${curr.code === userCurrency.code ? 'selected' : ''}>
                    ${curr.code} (${curr.symbol})
                </option>`
            ).join('');
            
            return `
                <div style="display: inline-block; margin-left: 10px;">
                    <select onchange="changeCurrency(this.value)" style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: white; cursor: pointer;">
                        ${currencies}
                    </select>
                </div>
            `;
        }
        
        // Change currency
        function changeCurrency(currencyCode) {
            const currency = Object.values(currencyMap).find(c => c.code === currencyCode);
            if (currency) {
                userCurrency = currency;
                console.log('Currency changed to:', userCurrency.code);
                // Reload the current view to update prices
                loadSubscriptionView();
            }
        }
        
        // Cache for real-time XAF rate (to avoid excessive API calls)
        let xafRateCache = {
            rate: 615,
            timestamp: 0,
            cacheDuration: 3600000 // 1 hour in milliseconds
        };
        
        // Get real-time exchange rate for XAF to USD
        async function getRealTimeXAFRate() {
            // Check if we have a recent cached rate
            const now = Date.now();
            if (xafRateCache.timestamp && (now - xafRateCache.timestamp) < xafRateCache.cacheDuration) {
                console.log('Using cached XAF rate:', xafRateCache.rate);
                return xafRateCache.rate;
            }
            
            try {
                // Using exchangerate-api.com (free tier: 1500 requests/month)
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                if (response.ok) {
                    const data = await response.json();
                    if (data.rates && data.rates.XAF) {
                        const rate = data.rates.XAF; // XAF per 1 USD
                        // Update cache
                        xafRateCache = {
                            rate: rate,
                            timestamp: now,
                            cacheDuration: 3600000
                        };
                        console.log('Fetched fresh XAF rate:', rate);
                        return rate;
                    }
                }
            } catch (error) {
                console.log('Could not fetch real-time rate, using cached/default:', error);
            }
            
            // Return cached rate or fallback
            console.log('Using cached/default XAF rate:', xafRateCache.rate);
            return xafRateCache.rate;
        }
        
        // Convert XAF to USD using real-time rate
        async function convertXAFToUSD(xafAmount) {
            const rate = await getRealTimeXAFRate();
            return xafAmount / rate;
        }
        
        // Convert USD to XAF using real-time rate
        async function convertUSDToXAF(usdAmount) {
            const rate = await getRealTimeXAFRate();
            return usdAmount * rate;
        }
        
        // Update price conversion display in real-time
        async function updatePriceConversion(formType) {
            const inputId = `price-input-${formType}`;
            const displayId = `usd-equivalent-${formType}`;
            
            const inputElement = document.getElementById(inputId);
            const displayElement = document.getElementById(displayId);
            
            if (!inputElement || !displayElement) return;
            
            const amount = parseFloat(inputElement.value);
            
            if (isNaN(amount) || amount <= 0) {
                displayElement.innerHTML = '';
                return;
            }
            
            if (userCurrency.code === 'XAF') {
                // Show real-time USD equivalent
                const rate = await getRealTimeXAFRate();
                const usdEquivalent = amount / rate;
                displayElement.innerHTML = `‚âà $${usdEquivalent.toFixed(2)} USD (Rate: 1 USD = ${Math.round(rate).toLocaleString()} FCFA)`;
                displayElement.style.color = '#10b981'; // Green color
            } else if (userCurrency.code !== 'USD') {
                // Show USD equivalent for other currencies
                const usdEquivalent = amount / userCurrency.rate;
                displayElement.innerHTML = `‚âà $${usdEquivalent.toFixed(2)} USD`;
                displayElement.style.color = '#6b7280'; // Gray color
            } else {
                displayElement.innerHTML = '';
            }
        }
        
        async function openSubscriptionModule() {
            console.log('openSubscriptionModule called');
            const token = getAuthToken();
            if (!token) {
                showMessage('Please log in to access Subscription management', 'error');
                return;
            }

            console.log('Token valid, rendering subscription module');
            
            // Detect user currency based on geolocation
            await detectUserCurrency();
            
            currentSubscriptionView = 'plans';
            await renderSubscriptionModule();
        }
        
        async function renderSubscriptionModule() {
            const token = getAuthToken();
            
            const subscriptionHTML = `
                <div style="padding: 20px; background: var(--bg-light); min-height: 600px;">
                    <!-- Header with Currency Selector -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <h3 style="color: var(--text-dark); margin: 0;">üí≥ Subscription Management</h3>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 12px; color: var(--text-light);">Currency:</span>
                                ${showCurrencySelector()}
                            </div>
                        </div>
                    </div>
                    
                    <!-- View Tabs -->
                    <div style="display: flex; gap: 10px; margin-bottom: 25px; background: white; padding: 10px; border-radius: 8px;">
                        <button 
                            onclick="switchSubscriptionView('plans')" 
                            id="tab-plans"
                            style="flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                            üìã Subscription Plans
                        </button>
                        <button 
                            onclick="switchSubscriptionView('features')" 
                            id="tab-features"
                            style="flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                            ‚≠ê Features
                        </button>
                        <button 
                            onclick="switchSubscriptionView('subscriptions')" 
                            id="tab-subscriptions"
                            style="flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                            üë• User Subscriptions
                        </button>
                    </div>

                    <!-- Content Area -->
                    <div id="subscription-content"></div>
                </div>
            `;
            
            showLargeModal('üí≥ Subscription Management', subscriptionHTML);
            updateSubscriptionTabStyles();
            await loadSubscriptionView();
        }
        
        function switchSubscriptionView(view) {
            currentSubscriptionView = view;
            updateSubscriptionTabStyles();
            loadSubscriptionView();
        }
        
        function updateSubscriptionTabStyles() {
            const tabs = {
                'plans': document.getElementById('tab-plans'),
                'features': document.getElementById('tab-features'),
                'subscriptions': document.getElementById('tab-subscriptions')
            };
            
            Object.keys(tabs).forEach(key => {
                if (tabs[key]) {
                    if (key === currentSubscriptionView) {
                        tabs[key].style.background = 'var(--primary-green)';
                        tabs[key].style.color = 'white';
                    } else {
                        tabs[key].style.background = 'var(--bg-light)';
                        tabs[key].style.color = 'var(--text-dark)';
                    }
                }
            });
        }
        
        async function loadSubscriptionView() {
            const contentDiv = document.getElementById('subscription-content');
            if (!contentDiv) return;
            
            contentDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><p>Loading...</p></div>';
            
            if (currentSubscriptionView === 'plans') {
                await loadPlansView();
            } else if (currentSubscriptionView === 'features') {
                await loadFeaturesView();
            } else if (currentSubscriptionView === 'subscriptions') {
                await loadUserSubscriptionsView();
            }
        }
        
        // ===========================
        // SUBSCRIPTION PLANS VIEW
        // ===========================
        
        async function loadPlansView() {
            const token = getAuthToken();
            const contentDiv = document.getElementById('subscription-content');
            
            // Fetch real-time XAF rate if using XAF currency
            if (userCurrency.code === 'XAF') {
                await getRealTimeXAFRate(); // This will populate the cache
            }
            
            try {
                contentDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><p>Loading subscription plans...</p></div>';
                
                const [plansResponse, featuresResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/subscription-plans`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${API_BASE_URL}/subscription-features`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);
                
                if (!plansResponse.ok) {
                    const errorText = await plansResponse.text();
                    console.error('Plans API Error:', plansResponse.status, errorText);
                    contentDiv.innerHTML = `<div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
                        <p style="color: red;">Failed to load plans (Status: ${plansResponse.status})</p>
                        <p style="font-size: 12px; color: var(--text-light);">${errorText.substring(0, 200)}</p>
                    </div>`;
                    return;
                }
                
                const plans = await plansResponse.json();
                const allFeatures = featuresResponse.ok ? await featuresResponse.json() : [];
                
                console.log('Loaded plans:', plans.length);
                
                if (plans.length === 0) {
                    contentDiv.innerHTML = `
                        <div style="background: white; padding: 40px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 20px;">üí≥</div>
                            <h3 style="color: var(--text-dark); margin-bottom: 10px;">No Subscription Plans Yet</h3>
                            <p style="color: var(--text-light); margin-bottom: 20px;">Create your first subscription plan to get started</p>
                            <button onclick="showAddPlanModal([])" style="padding: 12px 24px; background: var(--primary-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                + Create First Plan
                            </button>
                        </div>
                    `;
                    return;
                }
                
                const plansHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                        ${plans.map(plan => createPlanCard(plan)).join('')}
                        
                        <!-- Add New Plan Card -->
                        <div style="background: white; border: 2px dashed var(--border-color); border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s;" 
                             onclick="showAddPlanModal([])">
                            <div style="font-size: 48px; color: var(--primary-green); margin-bottom: 15px;">+</div>
                            <h3 style="color: var(--text-dark); margin: 0 0 5px 0;">Add New Plan</h3>
                            <p style="color: var(--text-light); margin: 0; font-size: 14px;">Create a subscription tier</p>
                        </div>
                    </div>
                `;
                
                contentDiv.innerHTML = plansHTML;
                
            } catch (error) {
                console.error('Error loading plans:', error);
                contentDiv.innerHTML = `<div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
                    <p style="color: red;">Error: ${error.message}</p>
                    <p style="font-size: 12px; color: var(--text-light);">Check console for details</p>
                </div>`;
            }
        }
        
        function createPlanCard(plan) {
            const popularBadge = plan.is_popular ? '<span style="background: #fbbf24; color: #78350f; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">POPULAR</span>' : '';
            const statusBadge = plan.is_active ? 
                '<span style="color: #10b981; font-size: 12px;">‚óè Active</span>' : 
                '<span style="color: #6b7280; font-size: 12px;">‚óè Inactive</span>';
            
            // Get the price from the database (assumes USD)
            const basePrice = parseFloat(plan.price || plan.price_monthly || 0);
            const formattedPrice = formatPrice(basePrice);
            
            return `
                <div style="background: white; border-radius: 12px; padding: 25px; border: 2px solid ${plan.is_popular ? '#fbbf24' : 'var(--border-color)'}; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h3 style="color: var(--text-dark); margin: 0 0 5px 0;">${plan.plan_name}</h3>
                            ${popularBadge}
                        </div>
                        ${statusBadge}
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <div style="font-size: 32px; font-weight: 700; color: var(--primary-green);">
                            ${formattedPrice}<span style="font-size: 16px; color: var(--text-light);">/${plan.billing_cycle || 'month'}</span>
                        </div>
                        ${userCurrency.code !== 'USD' ? `<div style="color: var(--text-light); font-size: 12px; margin-top: 4px;">‚âà $${basePrice.toFixed(2)} USD</div>` : ''}
                    </div>
                    
                    <p style="color: var(--text-light); font-size: 14px; margin: 15px 0;">${plan.description || 'No description'}</p>
                    
                    <div style="margin: 15px 0; padding: 15px; background: var(--bg-light); border-radius: 8px;">
                        <div style="font-size: 12px; color: var(--text-light); margin-bottom: 8px;">Features Included:</div>
                        <div style="font-size: 13px; color: var(--text-dark);">
                            ${plan.features && plan.features.length > 0 ? 
                                plan.features.slice(0, 3).map(f => `‚úì ${f.feature_name}`).join('<br>') + 
                                (plan.features.length > 3 ? `<br><em style="color: var(--text-light);">+${plan.features.length - 3} more features</em>` : '')
                                : 'No features assigned yet'}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="editPlan(${plan.id})" style="flex: 1; padding: 10px; background: var(--primary-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Edit
                        </button>
                        <button onclick="managePlanFeatures(${plan.id}, '${plan.plan_name}')" style="flex: 1; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Features
                        </button>
                        <button onclick="deletePlan(${plan.id}, '${plan.plan_name}')" style="padding: 10px 15px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Delete
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function showAddPlanModal(allFeatures) {
            const modalHTML = `
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: var(--text-dark); margin: 0;">Create Subscription Plan</h2>
                        <button type="button" onclick="closeModal(); openSubscriptionModule();" style="padding: 4px 8px; width: 20%; min-width: 60px; background: var(--border-color); color: var(--text-dark); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: clamp(12px, 2vw, 14px); white-space: nowrap;">
                            ‚Üê Back
                        </button>
                    </div>
                    
                    <form id="add-plan-form" onsubmit="submitNewPlan(event)">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">Plan Name *</label>
                            <input type="text" name="plan_name" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">Plan Code * <span style="font-size: 12px; color: var(--text-light);">(e.g., 'basic', 'premium')</span></label>
                            <input type="text" name="plan_code" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">Description</label>
                            <textarea name="description" rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;"></textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">
                                    Monthly Price (in ${userCurrency.code}) *
                                </label>
                                <input type="number" 
                                       name="price_monthly" 
                                       id="price-input-add"
                                       step="${userCurrency.code === 'XAF' ? '1' : '0.01'}" 
                                       required 
                                       oninput="updatePriceConversion('add')"
                                       style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                <div id="usd-equivalent-add" style="font-size: 12px; color: var(--text-light); margin-top: 5px;"></div>
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">Yearly Price (${userCurrency.code})</label>
                                <input type="number" name="price_yearly" step="${userCurrency.code === 'XAF' ? '1' : '0.01'}" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">Max Appointments/Month</label>
                                <input type="number" name="max_appointments_per_month" placeholder="Leave empty for unlimited" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">Max Health Records</label>
                                <input type="number" name="max_health_records" placeholder="Leave empty for unlimited" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="priority_support" style="margin-right: 8px;">
                                <span style="color: var(--text-dark);">Priority Support</span>
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="is_popular" style="margin-right: 8px;">
                                <span style="color: var(--text-dark);">Mark as Popular</span>
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">Display Order</label>
                            <input type="number" name="display_order" value="0" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" style="flex: 1; padding: 12px; background: var(--primary-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Create Plan
                            </button>
                            <button type="button" onclick="closeModal()" style="padding: 12px 20px; background: var(--border-color); color: var(--text-dark); border: none; border-radius: 6px; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showLargeModal('Create Subscription Plan', modalHTML);
        }
        
        async function submitNewPlan(event) {
            event.preventDefault();
            const token = getAuthToken();
            const form = event.target;
            const formData = new FormData(form);
            
            // Convert prices back to USD if using XAF or other currency
            let priceMonthlyInUSD = parseFloat(formData.get('price_monthly'));
            let priceYearlyInUSD = formData.get('price_yearly') ? parseFloat(formData.get('price_yearly')) : null;
            
            if (userCurrency.code === 'XAF') {
                const rate = await getRealTimeXAFRate();
                priceMonthlyInUSD = priceMonthlyInUSD / rate;
                if (priceYearlyInUSD) priceYearlyInUSD = priceYearlyInUSD / rate;
            } else if (userCurrency.code !== 'USD') {
                priceMonthlyInUSD = priceMonthlyInUSD / userCurrency.rate;
                if (priceYearlyInUSD) priceYearlyInUSD = priceYearlyInUSD / userCurrency.rate;
            }
            
            const planData = {
                plan_name: formData.get('plan_name'),
                plan_code: formData.get('plan_code'),
                description: formData.get('description') || '',
                price_monthly: priceMonthlyInUSD,
                price_yearly: priceYearlyInUSD,
                max_appointments_per_month: formData.get('max_appointments_per_month') ? parseInt(formData.get('max_appointments_per_month')) : null,
                max_health_records: formData.get('max_health_records') ? parseInt(formData.get('max_health_records')) : null,
                priority_support: formData.get('priority_support') === 'on',
                is_popular: formData.get('is_popular') === 'on',
                display_order: parseInt(formData.get('display_order') || 0),
                is_active: true
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/subscription-plans`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(planData)
                });
                
                if (response.ok) {
                    showMessage('‚úÖ Subscription plan created successfully!', 'success');
                    closeModal();
                    await openSubscriptionModule();
                } else {
                    const error = await response.json();
                    showMessage(`Failed to create plan: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Error creating plan:', error);
                showMessage('Failed to create subscription plan', 'error');
            }
        }
        
        async function deletePlan(planId, planName) {
            if (!confirm(`Are you sure you want to delete the plan "${planName}"? This cannot be undone.`)) return;
            
            const token = getAuthToken();
            
            try {
                const response = await fetch(`${API_BASE_URL}/subscription-plans/${planId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    showMessage('‚úÖ Plan deleted successfully!', 'success');
                    await loadPlansView();
                } else {
                    const error = await response.json();
                    showMessage(`Failed to delete plan: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting plan:', error);
                showMessage('Failed to delete plan', 'error');
            }
        }
        
        async function editPlan(planId) {
            const token = getAuthToken();
            
            try {
                // Fetch plan details
                const planResponse = await fetch(`${API_BASE_URL}/subscription-plans/${planId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!planResponse.ok) {
                    showMessage('Failed to load plan details', 'error');
                    return;
                }
                
                const plan = await planResponse.json();
                
                // Fetch all features
                const featuresResponse = await fetch(`${API_BASE_URL}/subscription-features`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const allFeatures = featuresResponse.ok ? await featuresResponse.json() : [];
                
                // Get real-time rate for XAF to ensure consistency
                let currentRate = userCurrency.rate;
                if (userCurrency.code === 'XAF') {
                    currentRate = await getRealTimeXAFRate();
                }
                
                // Create edit modal
                const modalHTML = `
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px;">
                            <h2 style="color: var(--text-dark); margin: 0; flex: 1; min-width: 0;">Edit Subscription Plan</h2>
                            <button type="button" onclick="closeModal(); openSubscriptionModule();" style="padding: 4px 8px; width: 20%; min-width: 60px; background: var(--border-color); color: var(--text-dark); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap; flex-shrink: 0;">
                                ‚Üê Back
                            </button>
                        </div>
                        
                        <form id="edit-plan-form" onsubmit="submitEditPlan(event, ${planId})">>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">Plan Name *</label>
                                <input type="text" name="plan_name" value="${plan.plan_name}" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">Description</label>
                                <textarea name="description" rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">${plan.description || ''}</textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">
                                        Price (in ${userCurrency.code}) *
                                    </label>
                                    <input type="number" 
                                           step="${userCurrency.code === 'XAF' ? '1' : '0.01'}" 
                                           id="price-input-edit" 
                                           name="price" 
                                           value="${plan.price_monthly ? (plan.price_monthly * currentRate).toFixed(userCurrency.code === 'XAF' ? 0 : 2) : 0}" 
                                           required 
                                           oninput="updatePriceConversion('edit')"
                                           style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                    <div id="usd-equivalent-edit" style="font-size: 12px; color: var(--text-light); margin-top: 5px;"></div>
                                </div>
                                
                                <div>
                                    <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">Billing Cycle *</label>
                                    <select name="billing_cycle" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                        <option value="monthly" ${plan.billing_cycle === 'monthly' ? 'selected' : ''}>Monthly</option>
                                        <option value="quarterly" ${plan.billing_cycle === 'quarterly' ? 'selected' : ''}>Quarterly</option>
                                        <option value="yearly" ${plan.billing_cycle === 'yearly' ? 'selected' : ''}>Yearly</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" name="is_active" ${plan.is_active ? 'checked' : ''} style="width: 18px; height: 18px;">
                                    <span style="color: var(--text-dark); font-weight: 600;">Active Plan</span>
                                </label>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" onclick="closeModal()" style="padding: 10px 20px; background: var(--border-color); color: var(--text-dark); border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    Cancel
                                </button>
                                <button type="submit" style="padding: 10px 20px; background: var(--primary-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    üíæ Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                showLargeModal('Edit Subscription Plan', modalHTML);
                
            } catch (error) {
                console.error('Error loading plan for edit:', error);
                showMessage('Failed to load plan details', 'error');
            }
        }
        
        async function submitEditPlan(event, planId) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const token = getAuthToken();
            
            // Convert price back to USD if using XAF or other currency
            let priceInUSD = parseFloat(formData.get('price'));
            if (userCurrency.code === 'XAF') {
                const rate = await getRealTimeXAFRate();
                priceInUSD = priceInUSD / rate;
            } else if (userCurrency.code !== 'USD') {
                priceInUSD = priceInUSD / userCurrency.rate;
            }
            
            const planData = {
                plan_name: formData.get('plan_name'),
                description: formData.get('description') || null,
                price_monthly: priceInUSD,
                billing_cycle: formData.get('billing_cycle'),
                is_active: formData.has('is_active')
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/subscription-plans/${planId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(planData)
                });
                
                if (response.ok) {
                    showMessage('‚úÖ Plan updated successfully!', 'success');
                    closeModal();
                    await openSubscriptionModule();
                } else {
                    const error = await response.json();
                    showMessage(`Failed to update plan: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Error updating plan:', error);
                showMessage('Failed to update subscription plan', 'error');
            }
        }
        
        async function managePlanFeatures(planId, planName) {
            const token = getAuthToken();
            
            try {
                // Fetch all features
                const featuresResponse = await fetch(`${API_BASE_URL}/subscription-features`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!featuresResponse.ok) {
                    showMessage('Failed to load features', 'error');
                    return;
                }
                
                const allFeatures = await featuresResponse.json();
                
                // Fetch plan's current features
                const planResponse = await fetch(`${API_BASE_URL}/subscription-plans/${planId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const plan = planResponse.ok ? await planResponse.json() : { features: [] };
                const planFeatureIds = new Set(plan.features.map(f => f.id));
                
                // Group features by category
                const grouped = allFeatures.reduce((acc, feature) => {
                    const cat = feature.category || 'Other';
                    if (!acc[cat]) acc[cat] = [];
                    acc[cat].push(feature);
                    return acc;
                }, {});
                
                const modalHTML = `
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 700px; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h2 style="color: var(--text-dark); margin: 0;">Manage Features</h2>
                            <button type="button" onclick="closeModal(); openSubscriptionModule();" style="padding: 4px 8px; width: 20%; min-width: 60px; background: var(--border-color); color: var(--text-dark); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: clamp(12px, 2vw, 14px); white-space: nowrap;">
                                ‚Üê Back
                            </button>
                        </div>
                        <p style="color: var(--text-light); margin: 0 0 20px 0;">Plan: <strong>${planName}</strong></p>
                        
                        <div id="features-list">
                            ${Object.keys(grouped).map(category => `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: var(--text-dark); margin: 0 0 10px 0; padding-bottom: 8px; border-bottom: 2px solid var(--primary-green);">${category}</h4>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        ${grouped[category].map(feature => `
                                            <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-light); border-radius: 8px; cursor: pointer;">
                                                <input 
                                                    type="checkbox" 
                                                    data-feature-id="${feature.id}"
                                                    ${planFeatureIds.has(feature.id) ? 'checked' : ''}
                                                    onchange="togglePlanFeature(${planId}, ${feature.id}, this.checked)"
                                                    style="width: 18px; height: 18px;"
                                                >
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 600; color: var(--text-dark);">${feature.feature_name}</div>
                                                    <div style="font-size: 12px; color: var(--text-light);">${feature.description || 'No description'}</div>
                                                </div>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="margin-top: 20px; text-align: right;">
                            <button onclick="closeModal(); loadPlansView();" style="padding: 10px 20px; background: var(--primary-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                ‚úì Done
                            </button>
                        </div>
                    </div>
                `;
                
                showLargeModal('Manage Plan Features', modalHTML);
                
            } catch (error) {
                console.error('Error loading features:', error);
                showMessage('Failed to load features', 'error');
            }
        }
        
        async function togglePlanFeature(planId, featureId, isChecked) {
            const token = getAuthToken();
            
            try {
                const url = `${API_BASE_URL}/subscription-plans/${planId}/features/${featureId}`;
                const method = isChecked ? 'POST' : 'DELETE';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    showMessage(isChecked ? '‚úÖ Feature added' : '‚úÖ Feature removed', 'success');
                } else {
                    const error = await response.json();
                    showMessage(`Failed: ${error.detail}`, 'error');
                    // Revert checkbox on error
                    event.target.checked = !isChecked;
                }
            } catch (error) {
                console.error('Error toggling feature:', error);
                showMessage('Failed to update feature', 'error');
                // Revert checkbox on error
                event.target.checked = !isChecked;
            }
        }
        
        // ===========================
        // FEATURES VIEW
        // ===========================
        
        async function loadFeaturesView() {
            const token = getAuthToken();
            
            try {
                const response = await fetch(`${API_BASE_URL}/subscription-features`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const features = response.ok ? await response.json() : [];
                
                // Group by category
                const grouped = features.reduce((acc, feature) => {
                    const cat = feature.category || 'Other';
                    if (!acc[cat]) acc[cat] = [];
                    acc[cat].push(feature);
                    return acc;
                }, {});
                
                const contentDiv = document.getElementById('subscription-content');
                
                const featuresHTML = `
                    <div style="background: white; border-radius: 12px; padding: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--text-dark); margin: 0;">Subscription Features</h3>
                            <button onclick="showAddFeatureModal()" style="padding: 10px 20px; background: var(--primary-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                + Add Feature
                            </button>
                        </div>
                        
                        ${Object.keys(grouped).map(category => `
                            <div style="margin-bottom: 25px;">
                                <h4 style="color: var(--text-dark); margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid var(--primary-green);">${category}</h4>
                                <div style="display: grid; gap: 10px;">
                                    ${grouped[category].map(feature => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg-light); border-radius: 8px;">
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 4px;">${feature.feature_name}</div>
                                                <div style="font-size: 12px; color: var(--text-light); margin-bottom: 4px;">Code: ${feature.feature_code}</div>
                                                <div style="font-size: 13px; color: var(--text-dark);">${feature.description || 'No description'}</div>
                                            </div>
                                            <div style="display: flex; gap: 10px; align-items: center;">
                                                <span style="color: ${feature.is_active ? '#10b981' : '#6b7280'}; font-size: 12px;">
                                                    ${feature.is_active ? '‚óè Active' : '‚óè Inactive'}
                                                </span>
                                                <button onclick="deleteFeature(${feature.id})" style="padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                contentDiv.innerHTML = featuresHTML;
                
            } catch (error) {
                console.error('Error loading features:', error);
                showMessage('Failed to load features', 'error');
            }
        }
        
        async function showAddFeatureModal() {
            const modalHTML = `
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: var(--text-dark); margin: 0;">Add Subscription Feature</h2>
                        <button type="button" onclick="closeModal(); openSubscriptionModule();" style="padding: 4px 8px; width: 20%; min-width: 60px; background: var(--border-color); color: var(--text-dark); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: clamp(12px, 2vw, 14px); white-space: nowrap;">
                            ‚Üê Back
                        </button>
                    </div>
                    
                    <form id="add-feature-form" onsubmit="submitNewFeature(event)">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">Feature Name *</label>
                            <input type="text" name="feature_name" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">Feature Code * <span style="font-size: 12px; color: var(--text-light);">(e.g., 'appointments_booking')</span></label>
                            <input type="text" name="feature_code" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">Category</label>
                            <select name="category" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                                <option value="appointments">Appointments</option>
                                <option value="nutrition">Nutrition</option>
                                <option value="health_tracking">Health Tracking</option>
                                <option value="fitness">Fitness</option>
                                <option value="support">Support</option>
                                <option value="reports">Reports</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 5px;">Description</label>
                            <textarea name="description" rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" style="flex: 1; padding: 12px; background: var(--primary-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Create Feature
                            </button>
                            <button type="button" onclick="closeModal()" style="padding: 12px 20px; background: var(--border-color); color: var(--text-dark); border: none; border-radius: 6px; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showLargeModal('Add Subscription Feature', modalHTML);
        }
        
        async function submitNewFeature(event) {
            event.preventDefault();
            const token = getAuthToken();
            const form = event.target;
            const formData = new FormData(form);
            
            const featureData = {
                feature_name: formData.get('feature_name'),
                feature_code: formData.get('feature_code'),
                description: formData.get('description') || '',
                category: formData.get('category'),
                is_active: true
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/subscription-features`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(featureData)
                });
                
                if (response.ok) {
                    showMessage('‚úÖ Feature created successfully!', 'success');
                    closeModal();
                    await openSubscriptionModule();
                } else {
                    const error = await response.json();
                    showMessage(`Failed to create feature: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Error creating feature:', error);
                showMessage('Failed to create feature', 'error');
            }
        }
        
        async function deleteFeature(featureId) {
            if (!confirm('Are you sure you want to delete this feature?')) return;
            
            const token = getAuthToken();
            
            try {
                const response = await fetch(`${API_BASE_URL}/subscription-features/${featureId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    showMessage('‚úÖ Feature deleted successfully!', 'success');
                    await loadFeaturesView();
                } else {
                    const error = await response.json();
                    showMessage(`Failed to delete feature: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting feature:', error);
                showMessage('Failed to delete feature', 'error');
            }
        }
        
        // ===========================
        // USER SUBSCRIPTIONS VIEW
        // ===========================
        
        async function loadUserSubscriptionsView() {
            const token = getAuthToken();
            
            try {
                const response = await fetch(`${API_BASE_URL}/subscriptions/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const subscriptions = response.ok ? await response.json() : [];
                
                const contentDiv = document.getElementById('subscription-content');
                
                const subscriptionsHTML = `
                    <div style="background: white; border-radius: 12px; padding: 25px;">
                        <h3 style="color: var(--text-dark); margin: 0 0 20px 0;">User Subscriptions</h3>
                        
                        ${subscriptions.length === 0 ? 
                            '<p style="text-align: center; color: var(--text-light); padding: 40px;">No user subscriptions yet</p>' :
                            `
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: var(--bg-light);">
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">User ID</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">Plan ID</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">Billing Cycle</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">Amount</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">Status</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">Start Date</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">Auto Renew</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${subscriptions.map(sub => `
                                            <tr style="border-bottom: 1px solid var(--border-color);">
                                                <td style="padding: 12px;">${sub.user_id}</td>
                                                <td style="padding: 12px;">${sub.plan_id}</td>
                                                <td style="padding: 12px;">${sub.billing_cycle}</td>
                                                <td style="padding: 12px;">$${sub.amount_paid} ${sub.currency}</td>
                                                <td style="padding: 12px;">
                                                    <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; 
                                                        background: ${sub.status === 'active' ? '#d1fae5' : '#fee2e2'}; 
                                                        color: ${sub.status === 'active' ? '#065f46' : '#991b1b'};">
                                                        ${sub.status}
                                                    </span>
                                                </td>
                                                <td style="padding: 12px;">${new Date(sub.start_date).toLocaleDateString()}</td>
                                                <td style="padding: 12px;">${sub.auto_renew ? '‚úÖ Yes' : '‚ùå No'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            `
                        }
                    </div>
                `;
                
                contentDiv.innerHTML = subscriptionsHTML;
                
            } catch (error) {
                console.error('Error loading subscriptions:', error);
                showMessage('Failed to load user subscriptions', 'error');
            }
        }

        // ============================================================================
        // SECURITY MODULE
        // ============================================================================
        async function openSecurityModule() {
            const token = getAuthToken();
            if (!token) {
                showMessage('Please log in to access Security module', 'error');
                return;
            }

            try {
                // Load security dashboard data
                const dashboardResponse = await fetch(`${API_BASE_URL}/security/dashboard`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                let dashboardData = { 
                    total_events: 0, failed_logins: 0, active_alerts: 0, high_risk_events: 0,
                    recent_events: [], recent_login_attempts: [], recent_alerts: [], login_success_rate: 0
                };

                if (dashboardResponse.ok) {
                    dashboardData = await dashboardResponse.json();
                }

                const securityHTML = `
                    <div style="margin-bottom: 30px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #90caf9 100%); padding: 25px; border-radius: 12px; text-align: center; color: #0d47a1;">
                                <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${dashboardData.total_events}</div>
                                <div style="font-size: 14px; font-weight: 500;">Total Security Events</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffebee 0%, #ef9a9a 100%); padding: 25px; border-radius: 12px; text-align: center; color: #b71c1c;">
                                <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${dashboardData.failed_logins}</div>
                                <div style="font-size: 14px; font-weight: 500;">Failed Login Attempts</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffcc02 100%); padding: 25px; border-radius: 12px; text-align: center; color: #e65100;">
                                <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${dashboardData.active_alerts}</div>
                                <div style="font-size: 14px; font-weight: 500;">Active Security Alerts</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f3e5f5 0%, #ba68c8 100%); padding: 25px; border-radius: 12px; text-align: center; color: #4a148c;">
                                <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${dashboardData.high_risk_events}</div>
                                <div style="font-size: 14px; font-weight: 500;">High Risk Events</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 350px; gap: 25px; margin-bottom: 30px;">
                            <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                                <h3 style="color: #1565c0; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                                    Login Success Rate
                                </h3>
                                <div style="text-align: center; padding: 20px;">
                                    <div style="font-size: 48px; font-weight: bold; color: ${dashboardData.login_success_rate > 90 ? '#4caf50' : dashboardData.login_success_rate > 70 ? '#ff9800' : '#f44336'};">
                                        ${dashboardData.login_success_rate}%
                                    </div>
                                    <div style="color: #666; margin-top: 10px;">Authentication Success Rate (Last 30 Days)</div>
                                </div>
                            </div>
                            <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                                <h3 style="color: #1565c0; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                                    Quick Actions
                                </h3>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <button onclick="loadSecurityEvents()" style="padding: 12px 16px; background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                                        View Security Events
                                    </button>
                                    <button onclick="loadLoginAttempts()" style="padding: 12px 16px; background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                                        View Login Attempts
                                    </button>
                                    <button onclick="loadAuditLogs()" style="padding: 12px 16px; background: linear-gradient(135deg, #ffa726 0%, #f57400 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                                        View Audit Logs
                                    </button>
                                    <button onclick="loadSecurityAlerts()" style="padding: 12px 16px; background: linear-gradient(135deg, #ef5350 0%, #d32f2f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                                        View Security Alerts
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                            <h3 style="color: #1565c0; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                                Security Monitoring Dashboard
                            </h3>
                            <div id="security-content-area" style="min-height: 400px;">
                                <div style="text-align: center; padding: 60px 20px; color: #666;">
                                    <div style="font-size: 64px; margin-bottom: 20px;">üõ°Ô∏è</div>
                                    <h4 style="color: #1565c0; margin-bottom: 10px;">Security Center</h4>
                                    <p>Select an action above to view detailed security information.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                showLargeModal('üîí Security & Audit Management', securityHTML);

            } catch (error) {
                console.error('Error loading Security module:', error);
                showMessage('Error loading Security module', 'error');
            }
        }

        async function loadSecurityEvents() {
            const token = getAuthToken();
            const contentArea = document.getElementById('security-content-area');
            
            contentArea.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="color: #666;">Loading security events...</div></div>';

            try {
                const response = await fetch(`${API_BASE_URL}/security/events?limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const events = await response.json();
                    displaySecurityEvents(events);
                } else {
                    throw new Error('Failed to load security events');
                }
            } catch (error) {
                console.error('Error loading security events:', error);
                contentArea.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #f44336;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                        <div>Error loading security events</div>
                    </div>
                `;
            }
        }

        function displaySecurityEvents(events) {
            const contentArea = document.getElementById('security-content-area');
            
            if (!events || events.length === 0) {
                contentArea.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #666;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üîç</div>
                        <h4 style="color: #1565c0;">No Security Events Found</h4>
                        <p>No security events have been recorded yet.</p>
                    </div>
                `;
                return;
            }

            const eventsHTML = events.map(event => {
                const timestamp = new Date(event.timestamp).toLocaleString();
                const riskColor = {
                    'low': '#4caf50',
                    'medium': '#ff9800',
                    'high': '#f44336',
                    'critical': '#d32f2f'
                }[event.risk_level] || '#666';

                return `
                    <div style="background: #f8f9fa; border-left: 4px solid ${riskColor}; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1565c0; margin-bottom: 5px;">${event.event_type}</div>
                                <div style="color: #666; font-size: 14px;">${event.event_category} ‚Ä¢ ${timestamp}</div>
                            </div>
                            <span style="background: ${riskColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                ${event.risk_level.toUpperCase()}
                            </span>
                        </div>
                        <div style="color: #333; margin-bottom: 8px;">${event.details || 'No additional details'}</div>
                        <div style="font-size: 13px; color: #888;">
                            IP: ${event.ip_address || 'N/A'} ‚Ä¢ 
                            Endpoint: ${event.endpoint || 'N/A'} ‚Ä¢ 
                            Method: ${event.method || 'N/A'} ‚Ä¢ 
                            Status: ${event.status_code || 'N/A'}
                        </div>
                    </div>
                `;
            }).join('');

            contentArea.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #1565c0; margin: 0;">Security Events (${events.length})</h4>
                </div>
                ${eventsHTML}
            `;
        }

        async function loadLoginAttempts() {
            const token = getAuthToken();
            const contentArea = document.getElementById('security-content-area');
            
            contentArea.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="color: #666;">Loading login attempts...</div></div>';

            try {
                const response = await fetch(`${API_BASE_URL}/security/login-attempts?limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const attempts = await response.json();
                    displayLoginAttempts(attempts);
                } else {
                    throw new Error('Failed to load login attempts');
                }
            } catch (error) {
                console.error('Error loading login attempts:', error);
                contentArea.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #f44336;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                        <div>Error loading login attempts</div>
                    </div>
                `;
            }
        }

        function displayLoginAttempts(attempts) {
            const contentArea = document.getElementById('security-content-area');
            
            if (!attempts || attempts.length === 0) {
                contentArea.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #666;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üîê</div>
                        <h4 style="color: #1565c0;">No Login Attempts Found</h4>
                        <p>No login attempts have been recorded yet.</p>
                    </div>
                `;
                return;
            }

            const attemptsHTML = attempts.map(attempt => {
                const timestamp = new Date(attempt.attempted_at).toLocaleString();
                const statusColor = attempt.success ? '#4caf50' : '#f44336';
                const statusText = attempt.success ? 'SUCCESS' : 'FAILED';
                const statusIcon = attempt.success ? '‚úÖ' : '‚ùå';

                return `
                    <div style="background: #f8f9fa; border-left: 4px solid ${statusColor}; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1565c0; margin-bottom: 5px;">${attempt.username}</div>
                                <div style="color: #666; font-size: 14px;">${timestamp}</div>
                            </div>
                            <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                ${statusIcon} ${statusText}
                            </span>
                        </div>
                        <div style="font-size: 13px; color: #888;">
                            IP Address: ${attempt.ip_address || 'N/A'} ‚Ä¢ 
                            User Agent: ${(attempt.user_agent || 'N/A').substring(0, 80)}${(attempt.user_agent || '').length > 80 ? '...' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            contentArea.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #1565c0; margin: 0;">Login Attempts (${attempts.length})</h4>
                </div>
                ${attemptsHTML}
            `;
        }

        async function loadAuditLogs() {
            const token = getAuthToken();
            const contentArea = document.getElementById('security-content-area');
            
            contentArea.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="color: #666;">Loading audit logs...</div></div>';

            try {
                const response = await fetch(`${API_BASE_URL}/security/audit-logs?limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const logs = await response.json();
                    displayAuditLogs(logs);
                } else {
                    throw new Error('Failed to load audit logs');
                }
            } catch (error) {
                console.error('Error loading audit logs:', error);
                contentArea.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #f44336;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                        <div>Error loading audit logs</div>
                    </div>
                `;
            }
        }

        function displayAuditLogs(logs) {
            const contentArea = document.getElementById('security-content-area');
            
            if (!logs || logs.length === 0) {
                contentArea.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #666;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üìã</div>
                        <h4 style="color: #1565c0;">No Audit Logs Found</h4>
                        <p>No audit logs have been recorded yet.</p>
                    </div>
                `;
                return;
            }

            const logsHTML = logs.map(log => {
                const timestamp = new Date(log.timestamp).toLocaleString();
                const actionColor = {
                    'create': '#4caf50',
                    'update': '#ff9800',
                    'delete': '#f44336',
                    'view': '#2196f3'
                }[log.action.toLowerCase().split(' ')[0]] || '#666';

                return `
                    <div style="background: #f8f9fa; border-left: 4px solid ${actionColor}; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1565c0; margin-bottom: 5px;">${log.action}</div>
                                <div style="color: #666; font-size: 14px;">${log.resource_type} ‚Ä¢ ${timestamp}</div>
                            </div>
                        </div>
                        <div style="color: #333; margin-bottom: 8px;">Resource ID: ${log.resource_id || 'N/A'}</div>
                        <div style="font-size: 13px; color: #888;">
                            IP Address: ${log.ip_address || 'N/A'} ‚Ä¢ 
                            User ID: ${log.user_id || 'N/A'}
                        </div>
                    </div>
                `;
            }).join('');

            contentArea.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #1565c0; margin: 0;">Audit Logs (${logs.length})</h4>
                </div>
                ${logsHTML}
            `;
        }

        async function loadSecurityAlerts() {
            const token = getAuthToken();
            const contentArea = document.getElementById('security-content-area');
            
            contentArea.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="color: #666;">Loading security alerts...</div></div>';

            try {
                const response = await fetch(`${API_BASE_URL}/security/alerts?limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const alerts = await response.json();
                    displaySecurityAlerts(alerts);
                } else {
                    throw new Error('Failed to load security alerts');
                }
            } catch (error) {
                console.error('Error loading security alerts:', error);
                contentArea.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #f44336;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                        <div>Error loading security alerts</div>
                    </div>
                `;
            }
        }

        function displaySecurityAlerts(alerts) {
            const contentArea = document.getElementById('security-content-area');
            
            if (!alerts || alerts.length === 0) {
                contentArea.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #666;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üö®</div>
                        <h4 style="color: #1565c0;">No Security Alerts Found</h4>
                        <p>No security alerts have been recorded yet.</p>
                    </div>
                `;
                return;
            }

            const alertsHTML = alerts.map(alert => {
                const timestamp = new Date(alert.created_at).toLocaleString();
                const severityColor = {
                    'low': '#4caf50',
                    'medium': '#ff9800',
                    'high': '#f44336',
                    'critical': '#d32f2f'
                }[alert.severity] || '#666';

                const resolvedText = alert.resolved ? 'RESOLVED' : 'ACTIVE';
                const resolvedColor = alert.resolved ? '#4caf50' : '#f44336';

                return `
                    <div style="background: #f8f9fa; border-left: 4px solid ${severityColor}; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1565c0; margin-bottom: 5px;">${alert.title}</div>
                                <div style="color: #666; font-size: 14px;">${alert.alert_type} ‚Ä¢ ${timestamp}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <span style="background: ${severityColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                    ${alert.severity.toUpperCase()}
                                </span>
                                <span style="background: ${resolvedColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                    ${resolvedText}
                                </span>
                            </div>
                        </div>
                        <div style="color: #333; margin-bottom: 8px;">${alert.description}</div>
                        <div style="font-size: 13px; color: #888;">
                            IP: ${alert.ip_address || 'N/A'} ‚Ä¢ 
                            Endpoint: ${alert.endpoint || 'N/A'}
                            ${alert.resolved ? ` ‚Ä¢ Resolved: ${new Date(alert.resolved_at).toLocaleString()}` : ''}
                        </div>
                        ${!alert.resolved ? `
                            <div style="margin-top: 10px;">
                                <button onclick="resolveSecurityAlert(${alert.id})" style="padding: 6px 12px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    ‚úÖ Mark as Resolved
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            contentArea.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #1565c0; margin: 0;">Security Alerts (${alerts.length})</h4>
                </div>
                ${alertsHTML}
            `;
        }

        async function resolveSecurityAlert(alertId) {
            const token = getAuthToken();
            const notes = prompt('Optional resolution notes:');

            try {
                const response = await fetch(`${API_BASE_URL}/security/alerts/${alertId}/resolve`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ resolution_notes: notes })
                });

                if (response.ok) {
                    showMessage('Security alert resolved successfully', 'success');
                    loadSecurityAlerts(); // Refresh the alerts list
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to resolve alert', 'error');
                }
            } catch (error) {
                console.error('Error resolving security alert:', error);
                showMessage('Network error', 'error');
            }
        }

        // Large Modal helper function for Meals/Nutrients
        function showLargeModal(title, content) {
            // Remove existing modal if any
            const existingModal = document.getElementById('custom-modal');
            if (existingModal) existingModal.remove();

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'custom-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; width: 95%; max-width: 1400px; height: 90vh; max-height: 900px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.4); display: flex; flex-direction: column;">
                    <div style="background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                        <h2 style="margin: 0; color: white; font-size: 24px;">${title}</h2>
                        <button onclick="document.getElementById('custom-modal').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 28px; line-height: 1; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">√ó</button>
                    </div>
                    <div style="padding: 30px; overflow-y: auto; flex: 1;">
                        ${content}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            // Close on ESC key
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }

        // ==========================================
        // AI CHATBOT MODULE
        // ==========================================
        
        async function openAIChatbotModule() {
            const chatbotHTML = `
                <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 75vh;">
                    <!-- Left Sidebar - Conversations & Settings -->
                    <div style="background: white; border-radius: 12px; padding: 20px; overflow-y: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <!-- AI Provider Settings -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: var(--primary-green); margin-bottom: 15px; font-size: 16px;">‚öôÔ∏è AI Settings</h4>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">AI Provider</label>
                                <select id="ai-provider" onchange="updateAIProviderSettings()" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px;">
                                    <option value="ollama">Ollama (Local)</option>
                                    <option value="openrouter">OpenRouter</option>
                                    <option value="openai">OpenAI</option>
                                </select>
                            </div>
                            <div id="ai-provider-config">
                                <!-- Dynamic config based on provider -->
                            </div>
                            <button onclick="saveAISettings()" style="width: 100%; padding: 8px; background: var(--primary-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;">
                                Save Settings
                            </button>
                        </div>

                        <!-- WhatsApp Integration -->
                        <div style="margin-bottom: 25px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #0284c7;">
                            <h4 style="color: #0284c7; margin-bottom: 15px; font-size: 16px;">üí¨ WhatsApp</h4>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">Status</label>
                                <div id="whatsapp-status" style="font-size: 13px; color: #666;">
                                    <span id="whatsapp-status-indicator">üî¥</span> Not Connected
                                </div>
                            </div>
                            <button onclick="toggleWhatsAppConnection()" id="whatsapp-toggle-btn" style="width: 100%; padding: 8px; background: #25D366; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; margin-bottom: 8px;">
                                Connect WhatsApp
                            </button>
                            <button onclick="openWhatsAppSettings()" style="width: 100%; padding: 8px; background: #0284c7; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;">
                                WhatsApp Settings
                            </button>
                        </div>

                        <!-- Conversation List -->
                        <div>
                            <h4 style="color: var(--primary-green); margin-bottom: 15px; font-size: 16px;">üí¨ Conversations</h4>
                            <div id="conversation-list" style="max-height: 300px; overflow-y: auto;">
                                <!-- Conversations will be loaded here -->
                            </div>
                            <button onclick="startNewConversation()" style="width: 100%; padding: 8px; background: #f3f4f6; color: #374151; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; margin-top: 10px;">
                                + New Conversation
                            </button>
                        </div>
                    </div>

                    <!-- Right Panel - Chat Interface -->
                    <div style="background: white; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <!-- Chat Header -->
                        <div style="padding: 20px; border-bottom: 1px solid var(--border-color); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px 12px 0 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="margin: 0; color: white; font-size: 18px;" id="chat-header-title">AI Assistant</h3>
                                    <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;" id="chat-header-subtitle">Ready to help</p>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="exportConversation()" style="padding: 6px 12px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                        Export
                                    </button>
                                    <button onclick="clearCurrentConversation()" style="padding: 6px 12px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                        Clear
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Messages -->
                        <div id="chat-messages" style="flex: 1; padding: 20px; overflow-y: auto; background: #f9fafb;">
                            <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                                <div style="font-size: 48px; margin-bottom: 15px;">ü§ñ</div>
                                <p style="margin: 0; font-size: 16px; color: #6b7280;">Start a conversation with the AI assistant</p>
                                <p style="margin: 10px 0 0 0; font-size: 13px;">Ask questions, get insights, or manage patient communications</p>
                            </div>
                        </div>

                        <!-- Chat Input -->
                        <div style="padding: 20px; border-top: 1px solid var(--border-color); background: white; border-radius: 0 0 12px 12px;">
                            <!-- Attachments Preview Area -->
                            <div id="attachments-preview" style="display: none; margin-bottom: 15px; padding: 10px; background: #f9fafb; border-radius: 8px; border: 1px dashed #d1d5db;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 12px; font-weight: 500; color: #6b7280;">Attachments</span>
                                    <button onclick="clearAttachments()" style="padding: 2px 8px; background: #fee2e2; color: #991b1b; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                        Clear All
                                    </button>
                                </div>
                                <div id="attachment-items" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    <!-- Attachment previews will appear here -->
                                </div>
                            </div>

                            <!-- WhatsApp Recipient Selection -->
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 6px; font-size: 12px; font-weight: 500; color: #6b7280;">
                                    Send To (WhatsApp):
                                </label>
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                                    <select id="whatsapp-recipient" onchange="updateChatMode()" style="width: 60%; padding: 8px 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 13px; background: white; cursor: pointer; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='var(--border-color)'">
                                        <option value="">Select recipient...</option>
                                        <option value="all">üì¢ All Patients (Broadcast)</option>
                                        <optgroup label="Recent Patients">
                                            <!-- Will be populated from database -->
                                        </optgroup>
                                    </select>
                                    <button onclick="refreshWhatsAppRecipients()" title="Refresh recipient list" style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; font-size: 12px; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                                        üîÑ
                                    </button>
                                </div>
                                
                                <!-- Chat Mode Toggle -->
                                <div id="chat-mode-toggle" style="display: none; padding: 8px 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 8px; margin-bottom: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            <span style="font-size: 12px; font-weight: 600; color: white; display: block;">üí¨ Direct WhatsApp Mode</span>
                                            <span style="font-size: 11px; color: rgba(255,255,255,0.9);">Messages sent directly to recipient</span>
                                        </div>
                                        <button onclick="toggleChatMode()" style="width: 25%; padding: 4px 12px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500;">
                                            Switch to AI
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="ai-mode-toggle" style="display: none; padding: 8px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; margin-bottom: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            <span style="font-size: 12px; font-weight: 600; color: white; display: block;">ü§ñ AI Assistant Mode</span>
                                            <span style="font-size: 11px; color: rgba(255,255,255,0.9);">Chat with AI about selected patient</span>
                                        </div>
                                        <button onclick="toggleChatMode()" style="width: 25%; padding: 4px 12px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500;">
                                            Switch to Direct
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Input Area with Attachment Support -->
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; gap: 10px; align-items: stretch;">
                                    <div style="width: 80%; position: relative;">
                                        <textarea id="chat-input" placeholder="Type your message here... (Shift+Enter for new line, Enter to send)" style="width: 100%; padding: 12px 45px 12px 12px; border: 2px solid var(--border-color); border-radius: 10px; resize: vertical; font-family: inherit; font-size: 14px; min-height: 80px; max-height: 300px; transition: border-color 0.2s;" onkeydown="handleChatKeypress(event)" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='var(--border-color)'"></textarea>
                                        
                                        <!-- Attachment Button (positioned inside textarea) -->
                                        <div style="position: absolute; right: 8px; bottom: 8px; display: flex; gap: 6px;">
                                            <input type="file" id="chat-attachment-input" multiple accept="image/*,.pdf,.doc,.docx,.txt,.csv,.xlsx" style="display: none;" onchange="handleAttachmentSelect(event)">
                                            <button onclick="document.getElementById('chat-attachment-input').click()" title="Attach files (images, documents)" style="width: 36px; height: 36px; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%)'; this.style.transform=''">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <button onclick="sendChatMessage()" id="send-btn" style="width: 20%; padding: 0 10px; min-height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; white-space: nowrap; font-size: 15px; transition: all 0.2s; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)'">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="22" y1="2" x2="11" y2="13"></line>
                                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                        </svg>
                                        Send
                                    </button>
                                </div>
                                
                                <!-- Helper Text -->
                                <div style="margin-top: 8px; font-size: 11px; color: #9ca3af; display: flex; justify-content: space-between; align-items: center;">
                                    <span>üí° Tip: Use quick actions below or attach files for better context</span>
                                    <span id="char-count" style="color: #6b7280;"></span>
                                </div>
                            </div>

                            <!-- Quick Action Prompts (Below input for better visibility) -->
                            <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                                    <span style="font-size: 12px; color: #6b7280; font-weight: 500;">Quick Actions:</span>
                                    <button onclick="insertQuickPrompt('patient_summary')" style="padding: 6px 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s; box-shadow: 0 1px 3px rgba(16, 185, 129, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 6px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 1px 3px rgba(16, 185, 129, 0.3)'">
                                        üìä Patient Summary
                                    </button>
                                    <button onclick="insertQuickPrompt('appointment_reminder')" style="padding: 6px 12px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s; box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 6px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 1px 3px rgba(59, 130, 246, 0.3)'">
                                        üìÖ Reminder
                                    </button>
                                    <button onclick="insertQuickPrompt('health_analysis')" style="padding: 6px 12px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s; box-shadow: 0 1px 3px rgba(139, 92, 246, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 6px rgba(139, 92, 246, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 1px 3px rgba(139, 92, 246, 0.3)'">
                                        üìà Analysis
                                    </button>
                                    <button onclick="insertQuickPrompt('meal_plans')" style="padding: 6px 12px; background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s; box-shadow: 0 1px 3px rgba(6, 182, 212, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 6px rgba(6, 182, 212, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 1px 3px rgba(6, 182, 212, 0.3)'">
                                        üçΩÔ∏è Meal Plans
                                    </button>
                                    <button onclick="insertQuickPrompt('medication_guide')" style="padding: 6px 12px; background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s; box-shadow: 0 1px 3px rgba(236, 72, 153, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 6px rgba(236, 72, 153, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 1px 3px rgba(236, 72, 153, 0.3)'">
                                        üíä Medication
                                    </button>
                                    <button onclick="insertQuickPrompt('treatment_plan')" style="padding: 6px 12px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s; box-shadow: 0 1px 3px rgba(245, 158, 11, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 6px rgba(245, 158, 11, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 1px 3px rgba(245, 158, 11, 0.3)'">
                                        üè• Treatment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            showLargeModal('ü§ñ AI Chatbot & WhatsApp Integration', chatbotHTML);
            initializeChatbot();
        }

        // Chatbot State
        let currentConversationId = null;
        let chatHistory = [];
        let isDirectWhatsAppMode = false; // New: Track chat mode
        let aiSettings = {
            provider: 'ollama',
            ollamaUrl: 'http://localhost:11434',
            ollamaModel: 'llama3.2',
            openrouterKey: '',
            openrouterModel: 'anthropic/claude-3.5-sonnet',
            openaiKey: '',
            openaiModel: 'gpt-4',
            systemPrompt: 'You are a helpful AI assistant for a healthcare platform. Provide professional, empathetic, and accurate responses.'
        };

        let whatsappConnected = false;
        let whatsappSettings = {
            phoneNumber: '',
            webhookUrl: '',
            apiKey: ''
        };

        function updateChatMode() {
            const recipientSelect = document.getElementById('whatsapp-recipient');
            const selectedRecipient = recipientSelect.value;
            const recipientName = recipientSelect.options[recipientSelect.selectedIndex].text;
            
            const chatModeToggle = document.getElementById('chat-mode-toggle');
            const aiModeToggle = document.getElementById('ai-mode-toggle');
            const quickActionsContainer = document.getElementById('chat-quick-actions');
            
            if (selectedRecipient && selectedRecipient !== '') {
                // Show mode toggle when recipient is selected
                if (isDirectWhatsAppMode) {
                    chatModeToggle.style.display = 'block';
                    aiModeToggle.style.display = 'none';
                    // Disable quick actions in Direct WhatsApp mode (they're AI-specific)
                    if (quickActionsContainer) {
                        quickActionsContainer.style.opacity = '0.5';
                        quickActionsContainer.style.pointerEvents = 'none';
                    }
                } else {
                    chatModeToggle.style.display = 'none';
                    aiModeToggle.style.display = 'block';
                    // Enable quick actions in AI mode
                    if (quickActionsContainer) {
                        quickActionsContainer.style.opacity = '1';
                        quickActionsContainer.style.pointerEvents = 'auto';
                    }
                }
                
                // Update chat header
                updateChatHeader(selectedRecipient, recipientName);
            } else {
                // Hide mode toggle when no recipient
                chatModeToggle.style.display = 'none';
                aiModeToggle.style.display = 'none';
                isDirectWhatsAppMode = false;
                
                // Enable quick actions when no recipient (default AI mode)
                if (quickActionsContainer) {
                    quickActionsContainer.style.opacity = '1';
                    quickActionsContainer.style.pointerEvents = 'auto';
                }
                
                // Reset to AI mode
                document.getElementById('chat-header-title').textContent = 'AI Assistant';
                document.getElementById('chat-header-subtitle').textContent = 'Ready to help';
            }
        }
        
        function toggleChatMode() {
            isDirectWhatsAppMode = !isDirectWhatsAppMode;
            updateChatMode();
        }
        
        function updateChatHeader(selectedRecipient, recipientName) {
            const headerTitle = document.getElementById('chat-header-title');
            const headerSubtitle = document.getElementById('chat-header-subtitle');
            
            if (isDirectWhatsAppMode) {
                headerTitle.textContent = `üí¨ ${recipientName.split(' - ')[0]}`;
                headerSubtitle.textContent = selectedRecipient === 'all' 
                    ? 'Broadcasting to all patients via WhatsApp' 
                    : `Direct WhatsApp: ${selectedRecipient}`;
            } else {
                headerTitle.textContent = `ü§ñ AI Chat: ${recipientName.split(' - ')[0]}`;
                headerSubtitle.textContent = selectedRecipient === 'all'
                    ? 'AI assistance for all patients'
                    : `AI assistance with patient context`;
            }
        }

        function initializeChatbot() {
            // Load saved settings
            const savedSettings = localStorage.getItem('aiChatbotSettings');
            if (savedSettings) {
                aiSettings = { ...aiSettings, ...JSON.parse(savedSettings) };
            }

            const savedWhatsApp = localStorage.getItem('whatsappSettings');
            if (savedWhatsApp) {
                whatsappSettings = { ...whatsappSettings, ...JSON.parse(savedWhatsApp) };
            }

            // Set UI values
            document.getElementById('ai-provider').value = aiSettings.provider;
            updateAIProviderSettings();

            // Load conversations
            loadConversations();
            
            // Load WhatsApp recipients
            refreshWhatsAppRecipients();
            
            // Add textarea auto-resize and character count
            const textarea = document.getElementById('chat-input');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    // Auto-resize
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 300) + 'px';
                    
                    // Character count
                    const charCount = document.getElementById('char-count');
                    if (charCount && this.value.length > 0) {
                        charCount.textContent = `${this.value.length} characters`;
                    } else if (charCount) {
                        charCount.textContent = '';
                    }
                });
            }
        }

        async function refreshWhatsAppRecipients() {
            const select = document.getElementById('whatsapp-recipient');
            if (!select) return;

            // Check if user is authenticated first
            const token = getAuthToken();
            if (!token) {
                console.log('Skipping WhatsApp recipients load - user not authenticated');
                // Add a message option indicating authentication needed
                const existingGroup = select.querySelector('optgroup');
                if (existingGroup) {
                    existingGroup.remove();
                }
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'Recent Patients';
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '‚ö†Ô∏è Please login to load patients';
                option.disabled = true;
                optgroup.appendChild(option);
                select.appendChild(optgroup);
                return;
            }

            // Show loading state
            const currentValue = select.value;
            select.disabled = true;

            try {
                // Fetch patients from database with authentication
                const response = await authenticatedFetch('/api/patients?with_phone=true');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const patients = await response.json();

                // Clear existing options (except first two)
                while (select.options.length > 2) {
                    select.remove(2);
                }

                // Remove existing optgroup if present
                const existingGroup = select.querySelector('optgroup');
                if (existingGroup) {
                    existingGroup.remove();
                }

                // Add patients to dropdown
                if (patients && patients.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = 'Recent Patients';

                    patients.forEach(patient => {
                        const option = document.createElement('option');
                        option.value = patient.phone_number || patient.whatsapp_number;
                        option.textContent = `${patient.name} - ${formatPhoneNumber(patient.phone_number || patient.whatsapp_number)}`;
                        optgroup.appendChild(option);
                    });

                    select.appendChild(optgroup);
                } else {
                    // Add "No patients" option
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = 'Recent Patients';
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No patients with phone numbers found';
                    option.disabled = true;
                    optgroup.appendChild(option);
                    select.appendChild(optgroup);
                }

                // Restore selection if it still exists
                if (currentValue) {
                    select.value = currentValue;
                }
            } catch (error) {
                console.error('Error loading WhatsApp recipients:', error);
                
                // Clear existing options (except first two)
                while (select.options.length > 2) {
                    select.remove(2);
                }
                
                // Add error option
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'Recent Patients';
                const option = document.createElement('option');
                option.value = '';
                option.textContent = error.message.includes('401') 
                    ? '‚ö†Ô∏è Authentication required - please login' 
                    : '‚ö†Ô∏è Error loading patients';
                option.disabled = true;
                optgroup.appendChild(option);
                select.appendChild(optgroup);
            } finally {
                select.disabled = false;
            }
        }

        function formatPhoneNumber(phone) {
            if (!phone) return '';
            // Remove non-numeric characters
            const cleaned = phone.replace(/\D/g, '');
            // Format as international number
            if (cleaned.length >= 10) {
                return `+${cleaned}`;
            }
            return phone;
        }

        function updateAIProviderSettings() {
            const provider = document.getElementById('ai-provider').value;
            const configDiv = document.getElementById('ai-provider-config');

            let configHTML = '';

            if (provider === 'ollama') {
                configHTML = `
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">Ollama URL</label>
                        <input type="text" id="ollama-url" value="${aiSettings.ollamaUrl}" placeholder="http://localhost:11434" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">Model</label>
                        <select id="ollama-model" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px;">
                            <option value="llama3.2" ${aiSettings.ollamaModel === 'llama3.2' ? 'selected' : ''}>Llama 3.2</option>
                            <option value="llama3.1" ${aiSettings.ollamaModel === 'llama3.1' ? 'selected' : ''}>Llama 3.1</option>
                            <option value="llama2" ${aiSettings.ollamaModel === 'llama2' ? 'selected' : ''}>Llama 2</option>
                            <option value="mistral" ${aiSettings.ollamaModel === 'mistral' ? 'selected' : ''}>Mistral</option>
                            <option value="codellama" ${aiSettings.ollamaModel === 'codellama' ? 'selected' : ''}>CodeLlama</option>
                        </select>
                    </div>
                `;
            } else if (provider === 'openrouter') {
                configHTML = `
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">API Key</label>
                        <input type="password" id="openrouter-key" value="${aiSettings.openrouterKey}" placeholder="sk-or-..." style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">Model</label>
                        <select id="openrouter-model" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px;">
                            <option value="anthropic/claude-3.5-sonnet" ${aiSettings.openrouterModel === 'anthropic/claude-3.5-sonnet' ? 'selected' : ''}>Claude 3.5 Sonnet</option>
                            <option value="openai/gpt-4" ${aiSettings.openrouterModel === 'openai/gpt-4' ? 'selected' : ''}>GPT-4</option>
                            <option value="google/gemini-pro" ${aiSettings.openrouterModel === 'google/gemini-pro' ? 'selected' : ''}>Gemini Pro</option>
                            <option value="meta-llama/llama-3.1-70b-instruct" ${aiSettings.openrouterModel === 'meta-llama/llama-3.1-70b-instruct' ? 'selected' : ''}>Llama 3.1 70B</option>
                        </select>
                    </div>
                `;
            } else if (provider === 'openai') {
                configHTML = `
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">API Key</label>
                        <input type="password" id="openai-key" value="${aiSettings.openaiKey}" placeholder="sk-..." style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">Model</label>
                        <select id="openai-model" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px;">
                            <option value="gpt-4" ${aiSettings.openaiModel === 'gpt-4' ? 'selected' : ''}>GPT-4</option>
                            <option value="gpt-4-turbo" ${aiSettings.openaiModel === 'gpt-4-turbo' ? 'selected' : ''}>GPT-4 Turbo</option>
                            <option value="gpt-3.5-turbo" ${aiSettings.openaiModel === 'gpt-3.5-turbo' ? 'selected' : ''}>GPT-3.5 Turbo</option>
                        </select>
                    </div>
                `;
            }

            configHTML += `
                <div style="margin-top: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">System Prompt</label>
                    <textarea id="system-prompt" rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; resize: vertical;">${aiSettings.systemPrompt}</textarea>
                </div>
            `;

            configDiv.innerHTML = configHTML;
        }

        function saveAISettings() {
            const provider = document.getElementById('ai-provider').value;

            aiSettings.provider = provider;
            aiSettings.systemPrompt = document.getElementById('system-prompt').value;

            if (provider === 'ollama') {
                aiSettings.ollamaUrl = document.getElementById('ollama-url').value;
                aiSettings.ollamaModel = document.getElementById('ollama-model').value;
            } else if (provider === 'openrouter') {
                aiSettings.openrouterKey = document.getElementById('openrouter-key').value;
                aiSettings.openrouterModel = document.getElementById('openrouter-model').value;
            } else if (provider === 'openai') {
                aiSettings.openaiKey = document.getElementById('openai-key').value;
                aiSettings.openaiModel = document.getElementById('openai-model').value;
            }

            localStorage.setItem('aiChatbotSettings', JSON.stringify(aiSettings));
            showMessage('AI settings saved successfully!', 'success');
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            const recipientSelect = document.getElementById('whatsapp-recipient');
            const selectedRecipient = recipientSelect.value;
            const recipientName = recipientSelect.options[recipientSelect.selectedIndex].text;

            if (!message && chatAttachments.length === 0) return;

            // Update chat header with recipient info using the updateChatHeader function
            updateChatHeader(selectedRecipient, recipientName);

            // Build message with attachment info
            let fullMessage = message;
            if (chatAttachments.length > 0) {
                const attachmentList = chatAttachments.map(a => `[${getFileIcon(a.type)} ${a.name}]`).join(' ');
                fullMessage = `${message}\n\nüìé Attachments: ${attachmentList}\n\n[Note: ${chatAttachments.length} file(s) attached. In a full implementation, these would be uploaded and processed. For now, they are referenced by name.]`;
            }

            // Clear input and attachments
            input.value = '';
            const sentAttachments = [...chatAttachments];
            clearAttachments();

            // ===== DIRECT WHATSAPP MODE =====
            if (isDirectWhatsAppMode) {
                // Add user message to chat
                addMessageToChat('user', message, false, sentAttachments.length > 0);

                // Send directly to WhatsApp without AI
                if (selectedRecipient && whatsappConnected) {
                    try {
                        await sendWhatsAppMessage(selectedRecipient, message, sentAttachments);
                        addMessageToChat('system', `‚úÖ Message sent to ${recipientName.split(' - ')[0]} via WhatsApp`, false);
                    } catch (error) {
                        addMessageToChat('system', `‚ùå Failed to send WhatsApp message: ${error.message}`, true);
                    }
                } else if (!whatsappConnected) {
                    addMessageToChat('system', '‚ö†Ô∏è WhatsApp is not connected. Please connect WhatsApp first.', true);
                } else {
                    addMessageToChat('system', '‚ö†Ô∏è No recipient selected. Please select a recipient from the dropdown.', true);
                }

                return; // Exit - don't call AI in Direct WhatsApp Mode
            }

            // ===== AI ASSISTANT MODE =====
            // Add WhatsApp recipient info to message context if selected
            if (selectedRecipient) {
                fullMessage = `[üì± WhatsApp ‚Üí ${recipientName}]\n\n${fullMessage}`;
            }

            // Add user message to chat (show with attachment badges and recipient)
            addMessageToChat('user', fullMessage, false, sentAttachments.length > 0);

            // Send to WhatsApp if recipient selected
            if (selectedRecipient && whatsappConnected) {
                try {
                    await sendWhatsAppMessage(selectedRecipient, message, sentAttachments);
                    addMessageToChat('system', `‚úÖ Message sent to ${recipientName} via WhatsApp`, false);
                } catch (error) {
                    addMessageToChat('system', `‚ùå Failed to send WhatsApp message: ${error.message}`, true);
                }
            }

            // Show typing indicator for AI response
            const typingId = addTypingIndicator();

            try {
                // Send to AI with attachment context
                const response = await callAI(fullMessage);
                removeTypingIndicator(typingId);
                addMessageToChat('assistant', response);

                // Save to history
                chatHistory.push({ role: 'user', content: fullMessage });
                chatHistory.push({ role: 'assistant', content: response });

                // Save conversation
                saveCurrentConversation();
            } catch (error) {
                removeTypingIndicator(typingId);
                addMessageToChat('system', `Error: ${error.message}`, true);
                console.error('Chat error:', error);
            }
        }

        async function sendWhatsAppMessage(recipient, message, attachments) {
            // This function will integrate with your WhatsApp API
            // For now, it's a placeholder that simulates sending
            
            if (!whatsappConnected) {
                throw new Error('WhatsApp is not connected. Please connect first.');
            }

            // Simulate API call for now (remove this in production)
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    console.log('WhatsApp message sent:', { recipient, message, attachments });
                    resolve({ success: true });
                }, 1000);
            });

            // In production, uncomment this to use the actual WhatsApp API with authentication:
            /*
            const response = await authenticatedFetch('/api/whatsapp/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    recipient: recipient,
                    message: message,
                    attachments: attachments.map(a => ({ name: a.name, type: a.type }))
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to send WhatsApp message');
            }
            
            return await response.json();
            */
        }

        async function callAI(message) {
            const provider = aiSettings.provider;

            if (provider === 'ollama') {
                return await callOllama(message);
            } else if (provider === 'openrouter') {
                return await callOpenRouter(message);
            } else if (provider === 'openai') {
                return await callOpenAI(message);
            }

            throw new Error('Invalid AI provider selected');
        }

        async function callOllama(message) {
            const messages = [
                { role: 'system', content: aiSettings.systemPrompt },
                ...chatHistory,
                { role: 'user', content: message }
            ];

            const response = await fetch(`${aiSettings.ollamaUrl}/api/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: aiSettings.ollamaModel,
                    messages: messages,
                    stream: false
                })
            });

            if (!response.ok) {
                throw new Error(`Ollama error: ${response.statusText}`);
            }

            const data = await response.json();
            return data.message.content;
        }

        async function callOpenRouter(message) {
            const messages = [
                { role: 'system', content: aiSettings.systemPrompt },
                ...chatHistory,
                { role: 'user', content: message }
            ];

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${aiSettings.openrouterKey}`,
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'MindLab Health AI Chatbot'
                },
                body: JSON.stringify({
                    model: aiSettings.openrouterModel,
                    messages: messages
                })
            });

            if (!response.ok) {
                throw new Error(`OpenRouter error: ${response.statusText}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function callOpenAI(message) {
            const messages = [
                { role: 'system', content: aiSettings.systemPrompt },
                ...chatHistory,
                { role: 'user', content: message }
            ];

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${aiSettings.openaiKey}`
                },
                body: JSON.stringify({
                    model: aiSettings.openaiModel,
                    messages: messages
                })
            });

            if (!response.ok) {
                throw new Error(`OpenAI error: ${response.statusText}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function addMessageToChat(role, content, isError = false, hasAttachments = false) {
            const chatContainer = document.getElementById('chat-messages');
            
            // Remove welcome message if exists
            if (chatContainer.children.length === 1 && chatContainer.children[0].style.textAlign === 'center') {
                chatContainer.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                margin-bottom: 15px;
                display: flex;
                ${role === 'user' ? 'justify-content: flex-end;' : 'justify-content: flex-start;'}
            `;

            const bubble = document.createElement('div');
            bubble.style.cssText = `
                max-width: 70%;
                padding: 12px 16px;
                border-radius: 12px;
                font-size: 14px;
                line-height: 1.5;
                white-space: pre-wrap;
                word-wrap: break-word;
                ${role === 'user' 
                    ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;' 
                    : isError
                        ? 'background: #fee2e2; color: #991b1b; border: 1px solid #fecaca;'
                        : 'background: #f3f4f6; color: #1f2937; border: 1px solid #e5e7eb;'}
            `;
            bubble.textContent = content;

            messageDiv.appendChild(bubble);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addTypingIndicator() {
            const chatContainer = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            const id = 'typing-' + Date.now();
            typingDiv.id = id;
            typingDiv.style.cssText = 'margin-bottom: 15px; display: flex; justify-content: flex-start;';
            typingDiv.innerHTML = `
                <div style="background: #f3f4f6; padding: 12px 16px; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <div style="display: flex; gap: 4px;">
                        <div style="width: 8px; height: 8px; background: #9ca3af; border-radius: 50%; animation: typing 1.4s infinite;"></div>
                        <div style="width: 8px; height: 8px; background: #9ca3af; border-radius: 50%; animation: typing 1.4s infinite 0.2s;"></div>
                        <div style="width: 8px; height: 8px; background: #9ca3af; border-radius: 50%; animation: typing 1.4s infinite 0.4s;"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return id;
        }

        function removeTypingIndicator(id) {
            const indicator = document.getElementById(id);
            if (indicator) indicator.remove();
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // Attachment handling
        let chatAttachments = [];

        function handleAttachmentSelect(event) {
            const files = Array.from(event.target.files);
            const maxSize = 10 * 1024 * 1024; // 10MB limit
            
            files.forEach(file => {
                if (file.size > maxSize) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    return;
                }
                
                chatAttachments.push({
                    file: file,
                    name: file.name,
                    size: file.size,
                    type: file.type
                });
            });
            
            displayAttachments();
            event.target.value = ''; // Reset input
        }

        function displayAttachments() {
            const previewContainer = document.getElementById('attachments-preview');
            const itemsContainer = document.getElementById('attachment-items');
            
            if (chatAttachments.length === 0) {
                previewContainer.style.display = 'none';
                return;
            }
            
            previewContainer.style.display = 'block';
            itemsContainer.innerHTML = '';
            
            chatAttachments.forEach((attachment, index) => {
                const sizeKB = (attachment.size / 1024).toFixed(1);
                const icon = getFileIcon(attachment.type);
                
                const itemHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;">
                        <span style="font-size: 18px;">${icon}</span>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 500; color: #374151; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${attachment.name}</div>
                            <div style="color: #9ca3af; font-size: 11px;">${sizeKB} KB</div>
                        </div>
                        <button onclick="removeAttachment(${index})" style="padding: 4px 8px; background: #fee2e2; color: #991b1b; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                            Remove
                        </button>
                    </div>
                `;
                itemsContainer.innerHTML += itemHTML;
            });
        }

        function getFileIcon(fileType) {
            if (fileType.startsWith('image/')) return 'üñºÔ∏è';
            if (fileType.includes('pdf')) return 'üìÑ';
            if (fileType.includes('word') || fileType.includes('document')) return 'üìù';
            if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'üìä';
            if (fileType.includes('text')) return 'üìã';
            return 'üìé';
        }

        function removeAttachment(index) {
            chatAttachments.splice(index, 1);
            displayAttachments();
        }

        function clearAttachments() {
            chatAttachments = [];
            displayAttachments();
        }

        async function insertQuickPrompt(actionType) {
            const input = document.getElementById('chat-input');
            const recipientSelect = document.getElementById('whatsapp-recipient');
            const selectedRecipient = recipientSelect.value;
            const recipientName = recipientSelect.options[recipientSelect.selectedIndex].text;
            
            // Show loading indicator
            input.value = '‚è≥ Loading patient data...';
            input.disabled = true;
            
            try {
                let promptText = '';
                let patientData = null;
                
                // If a specific patient is selected, fetch their data
                if (selectedRecipient && selectedRecipient !== 'all' && selectedRecipient !== '') {
                    try {
                        patientData = await fetchPatientData(selectedRecipient);
                    } catch (error) {
                        console.warn('Could not fetch patient data:', error);
                    }
                }
                
                // Build context-aware prompt based on action type
                switch(actionType) {
                    case 'patient_summary':
                        if (patientData) {
                            promptText = `Please provide a comprehensive summary for patient: ${patientData.name}\n\n`;
                            promptText += `Patient Information:\n`;
                            promptText += `- Name: ${patientData.name}\n`;
                            promptText += `- Phone: ${patientData.phone_number}\n`;
                            if (patientData.email) promptText += `- Email: ${patientData.email}\n`;
                            if (patientData.date_of_birth) promptText += `- Date of Birth: ${patientData.date_of_birth}\n`;
                            if (patientData.gender) promptText += `- Gender: ${patientData.gender}\n`;
                            
                            promptText += `\nRecent Activities:\n`;
                            if (patientData.appointments && patientData.appointments.length > 0) {
                                promptText += `- Appointments: ${patientData.appointments.length} scheduled\n`;
                            }
                            if (patientData.health_metrics) {
                                promptText += `- Latest health metrics available\n`;
                            }
                            
                            promptText += `\nPlease summarize:\n`;
                            promptText += `1. Recent appointment history and attendance\n`;
                            promptText += `2. Current health metrics and trends\n`;
                            promptText += `3. Any notable concerns or improvements\n`;
                            promptText += `4. Recommendations for next steps`;
                        } else {
                            promptText = 'Please provide a comprehensive summary of recent patient activities, including appointments, health metrics, and any notable trends or concerns.';
                            if (selectedRecipient === 'all') {
                                promptText = 'Please provide a summary of all patients\' recent activities, including appointment statistics, overall health trends, and any patients requiring immediate attention.';
                            } else if (!selectedRecipient) {
                                promptText += '\n\nüí° Tip: Select a specific patient from "Send To (WhatsApp)" to get personalized data.';
                            }
                        }
                        break;
                        
                    case 'appointment_reminder':
                        if (patientData) {
                            promptText = `Generate a friendly appointment reminder for patient: ${patientData.name}\n\n`;
                            if (patientData.appointments && patientData.appointments.length > 0) {
                                const nextAppt = patientData.appointments[0];
                                promptText += `Next Appointment Details:\n`;
                                if (nextAppt.date) promptText += `- Date: ${nextAppt.date}\n`;
                                if (nextAppt.time) promptText += `- Time: ${nextAppt.time}\n`;
                                if (nextAppt.type) promptText += `- Type: ${nextAppt.type}\n`;
                                if (nextAppt.therapist) promptText += `- Therapist: ${nextAppt.therapist}\n`;
                            }
                            promptText += `\nPlease create a warm, professional reminder message.`;
                        } else {
                            promptText = 'Generate a friendly appointment reminder message for patients scheduled for tomorrow.';
                            if (!selectedRecipient) {
                                promptText += '\n\nüí° Tip: Select a specific patient to include their appointment details.';
                            }
                        }
                        break;
                        
                    case 'health_analysis':
                        if (patientData) {
                            promptText = `Analyze health data trends for patient: ${patientData.name}\n\n`;
                            if (patientData.health_metrics) {
                                promptText += `Available Health Data:\n`;
                                if (patientData.health_metrics.weight) promptText += `- Weight: ${patientData.health_metrics.weight}\n`;
                                if (patientData.health_metrics.blood_pressure) promptText += `- Blood Pressure: ${patientData.health_metrics.blood_pressure}\n`;
                                if (patientData.health_metrics.heart_rate) promptText += `- Heart Rate: ${patientData.health_metrics.heart_rate}\n`;
                                // Add more metrics as available
                            }
                            promptText += `\nPlease analyze:\n`;
                            promptText += `1. Current health trends and progress\n`;
                            promptText += `2. Areas needing attention\n`;
                            promptText += `3. Recommendations for improvement`;
                        } else {
                            promptText = 'Analyze recent health data trends and provide insights on patient progress and areas needing attention.';
                            if (!selectedRecipient) {
                                promptText += '\n\nüí° Tip: Select a specific patient to analyze their health metrics.';
                            }
                        }
                        break;
                        
                    case 'meal_plans':
                        if (patientData) {
                            promptText = `Create a personalized weekly meal plan for patient: ${patientData.name}\n\n`;
                            promptText += `Patient Profile:\n`;
                            if (patientData.dietary_restrictions) promptText += `- Dietary Restrictions: ${patientData.dietary_restrictions}\n`;
                            if (patientData.allergies) promptText += `- Allergies: ${patientData.allergies}\n`;
                            if (patientData.health_goals) promptText += `- Health Goals: ${patientData.health_goals}\n`;
                            if (patientData.health_metrics && patientData.health_metrics.weight) {
                                promptText += `- Current Weight: ${patientData.health_metrics.weight}\n`;
                            }
                            promptText += `\nPlease create a 7-day meal plan considering:\n`;
                            promptText += `1. Patient's dietary needs and restrictions\n`;
                            promptText += `2. Nutritional balance for health goals\n`;
                            promptText += `3. Variety and practicality\n`;
                            promptText += `4. Portion sizes appropriate for the patient`;
                        } else {
                            promptText = 'Create a personalized weekly meal plan based on patient dietary requirements, health goals, and nutritional needs.';
                            if (!selectedRecipient) {
                                promptText += '\n\nüí° Tip: Select a specific patient to create a personalized meal plan based on their profile.';
                            }
                        }
                        break;
                        
                    case 'medication_guide':
                        if (patientData) {
                            promptText = `Provide medication guidance for patient: ${patientData.name}\n\n`;
                            if (patientData.medications && patientData.medications.length > 0) {
                                promptText += `Current Medications:\n`;
                                patientData.medications.forEach((med, index) => {
                                    promptText += `${index + 1}. ${med.name}`;
                                    if (med.dosage) promptText += ` - ${med.dosage}`;
                                    if (med.frequency) promptText += ` (${med.frequency})`;
                                    promptText += `\n`;
                                });
                            }
                            if (patientData.allergies) {
                                promptText += `\nKnown Allergies: ${patientData.allergies}\n`;
                            }
                            promptText += `\nPlease provide information about:\n`;
                            promptText += `1. Medication interactions\n`;
                            promptText += `2. Proper dosage guidelines\n`;
                            promptText += `3. Potential side effects\n`;
                            promptText += `4. Important precautions`;
                        } else {
                            promptText = 'Provide information about medication interactions, dosage guidelines, and potential side effects.';
                            if (!selectedRecipient) {
                                promptText += '\n\nüí° Tip: Select a specific patient to review their medication profile.';
                            }
                        }
                        break;
                        
                    case 'treatment_plan':
                        if (patientData) {
                            promptText = `Create a personalized treatment plan for patient: ${patientData.name}\n\n`;
                            promptText += `Patient History:\n`;
                            if (patientData.date_of_birth) {
                                const age = calculateAge(patientData.date_of_birth);
                                promptText += `- Age: ${age} years\n`;
                            }
                            if (patientData.medical_history) promptText += `- Medical History: ${patientData.medical_history}\n`;
                            if (patientData.current_conditions) promptText += `- Current Conditions: ${patientData.current_conditions}\n`;
                            if (patientData.medications) promptText += `- Active Medications: ${patientData.medications.length}\n`;
                            
                            promptText += `\nPlease create a treatment plan that includes:\n`;
                            promptText += `1. Primary treatment objectives\n`;
                            promptText += `2. Recommended therapies or interventions\n`;
                            promptText += `3. Timeline and milestones\n`;
                            promptText += `4. Follow-up schedule\n`;
                            promptText += `5. Lifestyle modifications`;
                        } else {
                            promptText = 'Help me create a personalized treatment plan based on patient history and current conditions.';
                            if (!selectedRecipient) {
                                promptText += '\n\nüí° Tip: Select a specific patient to create a treatment plan based on their medical history.';
                            }
                        }
                        break;
                        
                    default:
                        promptText = actionType; // Fallback for backward compatibility
                }
                
                input.value = promptText;
                input.disabled = false;
                input.focus();
                
                // Auto-expand textarea if needed
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 300) + 'px';
                
            } catch (error) {
                console.error('Error generating prompt:', error);
                input.value = 'Error loading prompt. Please try again.';
                input.disabled = false;
            }
        }
        
        async function fetchPatientData(phoneNumber) {
            // Fetch patient data from API based on phone number
            try {
                const response = await authenticatedFetch(`/api/patients/by-phone/${encodeURIComponent(phoneNumber)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error fetching patient data:', error);
                throw error;
            }
        }
        
        function calculateAge(dateOfBirth) {
            const dob = new Date(dateOfBirth);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const monthDiff = today.getMonth() - dob.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                age--;
            }
            return age;
        }

        function startNewConversation() {
            if (chatHistory.length > 0) {
                if (!confirm('Start a new conversation? Current conversation will be saved.')) {
                    return;
                }
                saveCurrentConversation();
            }

            currentConversationId = null;
            chatHistory = [];
            document.getElementById('chat-messages').innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                    <div style="font-size: 48px; margin-bottom: 15px;">ü§ñ</div>
                    <p style="margin: 0; font-size: 16px; color: #6b7280;">Start a conversation with the AI assistant</p>
                    <p style="margin: 10px 0 0 0; font-size: 13px;">Ask questions, get insights, or manage patient communications</p>
                </div>
            `;
            document.getElementById('chat-header-title').textContent = 'AI Assistant';
            document.getElementById('chat-header-subtitle').textContent = 'Ready to help';
        }

        function saveCurrentConversation() {
            if (chatHistory.length === 0) return;

            const conversations = JSON.parse(localStorage.getItem('aiConversations') || '[]');
            
            if (currentConversationId) {
                // Update existing
                const index = conversations.findIndex(c => c.id === currentConversationId);
                if (index !== -1) {
                    conversations[index].messages = chatHistory;
                    conversations[index].updatedAt = new Date().toISOString();
                }
            } else {
                // Create new
                const newConv = {
                    id: Date.now().toString(),
                    title: chatHistory[0]?.content?.substring(0, 50) || 'New Conversation',
                    messages: chatHistory,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                conversations.unshift(newConv);
                currentConversationId = newConv.id;
            }

            localStorage.setItem('aiConversations', JSON.stringify(conversations.slice(0, 50))); // Keep last 50
            loadConversations();
        }

        function loadConversations() {
            const conversations = JSON.parse(localStorage.getItem('aiConversations') || '[]');
            const listContainer = document.getElementById('conversation-list');

            if (conversations.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #9ca3af; font-size: 13px; padding: 20px;">No conversations yet</p>';
                return;
            }

            listContainer.innerHTML = conversations.map(conv => `
                <div onclick="loadConversation('${conv.id}')" style="padding: 12px; margin-bottom: 8px; background: ${currentConversationId === conv.id ? '#eff6ff' : '#f9fafb'}; border: 1px solid ${currentConversationId === conv.id ? '#3b82f6' : '#e5e7eb'}; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#eff6ff'" onmouseout="this.style.background='${currentConversationId === conv.id ? '#eff6ff' : '#f9fafb'}'">
                    <div style="font-size: 13px; font-weight: 500; color: #1f2937; margin-bottom: 4px;">${conv.title}</div>
                    <div style="font-size: 11px; color: #6b7280;">${new Date(conv.updatedAt).toLocaleString()}</div>
                </div>
            `).join('');
        }

        function loadConversation(id) {
            const conversations = JSON.parse(localStorage.getItem('aiConversations') || '[]');
            const conv = conversations.find(c => c.id === id);

            if (!conv) return;

            currentConversationId = id;
            chatHistory = conv.messages;

            // Render messages
            const chatContainer = document.getElementById('chat-messages');
            chatContainer.innerHTML = '';

            chatHistory.forEach(msg => {
                addMessageToChat(msg.role, msg.content);
            });

            document.getElementById('chat-header-title').textContent = conv.title;
            document.getElementById('chat-header-subtitle').textContent = `Updated ${new Date(conv.updatedAt).toLocaleString()}`;

            loadConversations(); // Refresh list to update highlighting
        }

        function clearCurrentConversation() {
            if (!confirm('Clear current conversation? This cannot be undone.')) return;

            if (currentConversationId) {
                const conversations = JSON.parse(localStorage.getItem('aiConversations') || '[]');
                const filtered = conversations.filter(c => c.id !== currentConversationId);
                localStorage.setItem('aiConversations', JSON.stringify(filtered));
            }

            startNewConversation();
            loadConversations();
        }

        function exportConversation() {
            if (chatHistory.length === 0) {
                showMessage('No conversation to export', 'error');
                return;
            }

            const content = chatHistory.map(msg => 
                `${msg.role.toUpperCase()}: ${msg.content}\n`
            ).join('\n');

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversation-${new Date().toISOString()}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            showMessage('Conversation exported!', 'success');
        }

        // ==========================================
        // WHATSAPP INTEGRATION
        // ==========================================

        function toggleWhatsAppConnection() {
            const btn = document.getElementById('whatsapp-toggle-btn');
            const status = document.getElementById('whatsapp-status');
            const indicator = document.getElementById('whatsapp-status-indicator');

            if (whatsappConnected) {
                // Disconnect
                whatsappConnected = false;
                btn.textContent = 'Connect WhatsApp';
                btn.style.background = '#25D366';
                status.innerHTML = '<span id="whatsapp-status-indicator">üî¥</span> Not Connected';
                showMessage('WhatsApp disconnected', 'success');
            } else {
                // Connect (show QR code modal)
                showWhatsAppQRCode();
            }
        }

        function showWhatsAppQRCode() {
            const qrModal = document.createElement('div');
            qrModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 20000;
            `;

            qrModal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 16px; text-align: center; max-width: 400px;">
                    <h3 style="margin: 0 0 20px 0; color: #1f2937;">Connect WhatsApp</h3>
                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="width: 200px; height: 200px; margin: 0 auto; background: white; border: 2px solid #e5e7eb; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 10px;">üì±</div>
                                <p style="margin: 0; font-size: 13px; color: #6b7280;">Scan with WhatsApp</p>
                            </div>
                        </div>
                    </div>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 20px;">
                        1. Open WhatsApp on your phone<br>
                        2. Tap Menu or Settings<br>
                        3. Tap Linked Devices<br>
                        4. Scan this QR code
                    </p>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="flex: 1; padding: 10px; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="completeWhatsAppConnection(); this.parentElement.parentElement.parentElement.remove();" style="flex: 1; padding: 10px; background: #25D366; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            Connected
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(qrModal);
        }

        function completeWhatsAppConnection() {
            whatsappConnected = true;
            const btn = document.getElementById('whatsapp-toggle-btn');
            const status = document.getElementById('whatsapp-status');
            
            btn.textContent = 'Disconnect WhatsApp';
            btn.style.background = '#dc2626';
            status.innerHTML = '<span id="whatsapp-status-indicator">üü¢</span> Connected';
            
            showMessage('WhatsApp connected successfully!', 'success');
        }

        function openWhatsAppSettings() {
            const settingsHTML = `
                <div style="max-width: 600px; margin: 0 auto;">
                    <h3 style="color: var(--primary-green); margin-bottom: 20px;">WhatsApp Integration Settings</h3>
                    
                    <div style="background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #1e40af; font-size: 14px;">Integration Method</h4>
                        <p style="margin: 0; font-size: 13px; color: #1e3a8a;">
                            This integration uses <strong>WhatsApp Business API</strong> or <strong>WhatsApp Web</strong> for sending/receiving messages.
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Integration Type</label>
                        <select id="whatsapp-integration-type" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                            <option value="web">WhatsApp Web (Free, Browser-based)</option>
                            <option value="api">WhatsApp Business API (Paid, Official)</option>
                            <option value="twilio">Twilio WhatsApp (Paid, Third-party)</option>
                        </select>
                    </div>

                    <div id="whatsapp-config-fields">
                        <!-- Dynamic fields based on integration type -->
                    </div>

                    <div style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">
                            <input type="checkbox" id="auto-reply" style="margin-right: 8px;">
                            Enable AI Auto-Reply
                        </label>
                        <p style="margin: 5px 0 0 24px; font-size: 13px; color: #6b7280;">
                            Automatically respond to WhatsApp messages using AI
                        </p>
                    </div>

                    <div style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">
                            Webhook URL (for receiving messages)
                        </label>
                        <input type="text" id="webhook-url" placeholder="https://your-server.com/webhook/whatsapp" value="${whatsappSettings.webhookUrl}" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 10px;">
                        <button onclick="closeModal()" style="flex: 1; padding: 12px; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            Cancel
                        </button>
                        <button onclick="saveWhatsAppSettings()" style="flex: 1; padding: 12px; background: #25D366; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            Save Settings
                        </button>
                    </div>
                </div>
            `;

            showLargeModal('WhatsApp Settings', settingsHTML);

            // Update config fields when integration type changes
            document.getElementById('whatsapp-integration-type').addEventListener('change', updateWhatsAppConfigFields);
            updateWhatsAppConfigFields();
        }

        function updateWhatsAppConfigFields() {
            const type = document.getElementById('whatsapp-integration-type').value;
            const container = document.getElementById('whatsapp-config-fields');

            let fieldsHTML = '';

            if (type === 'web') {
                fieldsHTML = `
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <p style="margin: 0; font-size: 13px; color: #92400e;">
                            <strong>Note:</strong> WhatsApp Web integration requires keeping a browser session active. 
                            Consider using a headless browser or dedicated server.
                        </p>
                    </div>
                `;
            } else if (type === 'api') {
                fieldsHTML = `
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Business Account ID</label>
                        <input type="text" id="wa-business-id" placeholder="123456789012345" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Phone Number ID</label>
                        <input type="text" id="wa-phone-id" placeholder="123456789012345" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Access Token</label>
                        <input type="password" id="wa-access-token" placeholder="EAAxxxxxxxxxx" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                    </div>
                `;
            } else if (type === 'twilio') {
                fieldsHTML = `
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Twilio Account SID</label>
                        <input type="text" id="twilio-account-sid" placeholder="ACxxxxxxxxxx" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Twilio Auth Token</label>
                        <input type="password" id="twilio-auth-token" placeholder="your-auth-token" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">WhatsApp Number</label>
                        <input type="text" id="twilio-whatsapp-number" placeholder="whatsapp:+14155238886" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                    </div>
                `;
            }

            container.innerHTML = fieldsHTML;
        }

        function saveWhatsAppSettings() {
            whatsappSettings.webhookUrl = document.getElementById('webhook-url').value;
            localStorage.setItem('whatsappSettings', JSON.stringify(whatsappSettings));
            showMessage('WhatsApp settings saved!', 'success');
            closeModal();
        }

        function closeModal() {
            const modal = document.getElementById('custom-modal');
            if (modal) modal.remove();
        }
    </script>
    <style>
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
    </style>
